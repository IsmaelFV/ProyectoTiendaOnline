---
import CartIcon from '../islands/CartIcon';
import SearchBar from '../search/SearchBar';
import GenderSelector from '../navigation/GenderSelector';

// Detectar g√©nero actual desde la URL
const currentPath = Astro.url.pathname;
let currentGender: 'mujer' | 'hombre' | undefined;

if (currentPath.startsWith('/mujer')) {
  currentGender = 'mujer';
} else if (currentPath.startsWith('/hombre')) {
  currentGender = 'hombre';
}

// IMPORTANTE: el estado de auth real vive en localStorage (Supabase cliente).
// No dependas de cookies sb-* porque en dev y en el cliente no siempre se setean.
---

<header class="bg-white border-b border-brand-slate/20 sticky top-0 z-50 shadow-sm">
  <nav class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
    {/* Fila superior: Logo + B√∫squeda + Carrito */}
    <div class="flex justify-between items-center py-4 gap-4">
      {/* Logo */}
      <a href="/" class="font-serif text-2xl font-bold text-brand-navy tracking-tight whitespace-nowrap">
        FashionMarket
      </a>

      {/* Barra de b√∫squeda (desktop) */}
      <div class="hidden lg:block flex-1 max-w-2xl mx-8">
        <SearchBar client:load />
      </div>

      {/* Carrito + Usuario + Men√∫ mobile */}
      <div class="flex items-center space-x-4">
        {/* Usuario (guest) */}
        <a id="user-guest" href="/auth/login" class="flex items-center space-x-2 text-brand-charcoal hover:text-brand-navy transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </a>

        {/* Usuario (auth) */}
        <div id="user-auth" class="hidden relative">
          <button 
            id="user-menu-btn"
            class="flex items-center space-x-2 text-brand-charcoal hover:text-brand-navy transition-colors"
            aria-label="Men√∫ de usuario"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </button>
          
          {/* Men√∫ desplegable */}
          <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
            <a href="/perfil" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              Mi Perfil
            </a>
            <a href="/perfil/mis-pedidos" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              Mis Pedidos
            </a>
            <hr class="my-1" />
            <button id="logout-btn-header" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>
        
        <CartIcon client:load />
        
        <button 
          id="mobile-menu-btn"
          class="lg:hidden text-brand-charcoal hover:text-brand-navy p-2"
          aria-label="Abrir men√∫"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    {/* Fila inferior: Navegaci√≥n principal */}
    <div class="hidden lg:flex items-center justify-center space-x-8 pb-4 border-t border-gray-100 pt-4">
      <GenderSelector currentGender={currentGender} client:load />
      
      <div class="h-6 w-px bg-gray-300"></div>
      
      <a href="/novedades" class="text-brand-charcoal hover:text-brand-navy transition-colors text-sm uppercase tracking-wider">
        Novedades
      </a>
      <a href="/ofertas" class="text-red-600 hover:text-red-700 transition-colors text-sm uppercase tracking-wider font-semibold">
        Rebajas
      </a>
      <a href="/sostenibilidad" class="text-brand-charcoal hover:text-brand-navy transition-colors text-sm uppercase tracking-wider">
        Sostenibilidad
      </a>
    </div>

    {/* B√∫squeda mobile */}
    <div class="lg:hidden pb-4">
      <SearchBar client:load />
    </div>

    {/* Men√∫ mobile */}
    <div id="mobile-menu" class="lg:hidden hidden pb-4 border-t border-gray-200 mt-4 pt-4">
      <div class="flex flex-col space-y-3">
        <a href="/mujer" class="text-brand-charcoal hover:text-brand-navy transition-colors font-medium py-2">
          Mujer
        </a>
        <a href="/hombre" class="text-brand-charcoal hover:text-brand-navy transition-colors font-medium py-2">
          Hombre
        </a>
        <a href="/novedades" class="text-brand-charcoal hover:text-brand-navy transition-colors font-medium py-2">
          Novedades
        </a>
        <a href="/ofertas" class="text-red-600 hover:text-red-700 transition-colors font-semibold py-2">
          Ofertas
        </a>
      </div>
    </div>
  </nav>
</header>

<script>
  // Toggle mobile menu
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  
  mobileMenuBtn?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
  });

  // Toggle user menu
  const userMenuBtn = document.getElementById('user-menu-btn');
  const userMenu = document.getElementById('user-menu');
  
  // Abrir/cerrar men√∫ al hacer clic en el bot√≥n
  userMenuBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    userMenu?.classList.toggle('hidden');
  });

  // Cerrar men√∫ al hacer clic fuera (pero NO en los enlaces internos)
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    // Si se hace clic en un enlace dentro del men√∫, dejar que navegue
    if (target.tagName === 'A' && userMenu?.contains(target)) {
      return;
    }
    // Si se hace clic fuera del men√∫ y del bot√≥n, cerrar
    if (userMenu && !userMenu.contains(target) && !userMenuBtn?.contains(target)) {
      userMenu.classList.add('hidden');
    }
  });

  // Cerrar men√∫ al presionar Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && userMenu) {
      userMenu.classList.add('hidden');
    }
  });

  // Cerrar sesi√≥n desde el header
  (async () => {
    try {
      const { supabase } = await import('/src/lib/supabase');
      const guestEl = document.getElementById('user-guest');
      const authEl = document.getElementById('user-auth');

      const toggle = (hasUser: boolean) => {
        if (!guestEl || !authEl) return;
        if (hasUser) {
          guestEl.classList.add('hidden');
          authEl.classList.remove('hidden');
        } else {
          authEl.classList.add('hidden');
          guestEl.classList.remove('hidden');
        }
      };

      const clearAuthArtifacts = () => {
        try {
          // Borrar cookies manuales
          const expire = 'Expires=Thu, 01 Jan 1970 00:00:01 GMT; Path=/; SameSite=Lax';
          document.cookie = `sb-access-token=; ${expire}`;
          document.cookie = `sb-refresh-token=; ${expire}`;
          // Borrar claves sb-* en localStorage (incluyendo custom sb-user-*)
          const toRemove: string[] = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('sb-')) toRemove.push(key);
          }
          toRemove.forEach((k) => localStorage.removeItem(k));
        } catch (e) {
          console.warn('No se pudieron limpiar claves/cookies sb-*', e);
        }
      };

      // Logout button
      document.getElementById('logout-btn-header')?.addEventListener('click', async () => {
        console.log('üîì [HEADER] Logout iniciado...');
        try {
          // Limpiar PRIMERO antes de signOut para evitar race conditions
          clearAuthArtifacts();
          console.log('üîì [HEADER] Artefactos limpios, llamando signOut...');
          
          // Llamar signOut DESPU√âS de limpiar
          await supabase.auth.signOut();
          console.log('üîì [HEADER] signOut completado');
        } catch (e) {
          console.warn('üîì [HEADER] supabase.signOut fall√≥ (es ok, limpieza igual fue ejecutada):', e);
        } finally {
          // Esperar 200ms para que los eventos se procesen
          await new Promise((r) => setTimeout(r, 200));
          console.log('üîì [HEADER] Redirigiendo a /');
          window.location.href = '/';
        }
      });

      // Estado inicial
      const { data } = await supabase.auth.getSession();
      toggle(!!data.session?.user);

      // Escuchar cambios
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
          toggle(!!session?.user);
        }
        if (event === 'SIGNED_OUT') {
          clearAuthArtifacts();
          toggle(false);
        }
      });
    } catch (err) {
      console.error('Error toggling user menu:', err);
    }
  })();
</script>
