---
import CartIcon from '../islands/CartIcon';
import SearchBar from '../search/SearchBar';
import GenderSelector from '../navigation/GenderSelector';

// Detectar género actual desde la URL
const currentPath = Astro.url.pathname;
let currentGender: 'mujer' | 'hombre' | undefined;

if (currentPath.startsWith('/mujer')) {
  currentGender = 'mujer';
} else if (currentPath.startsWith('/hombre')) {
  currentGender = 'hombre';
}

// Verificar si el usuario está autenticado
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const isAuthenticated = !!accessToken;
---

<header class="bg-white border-b border-brand-slate/20 sticky top-0 z-50 shadow-sm">
  <nav class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
    {/* Fila superior: Logo + Búsqueda + Carrito */}
    <div class="flex justify-between items-center py-4 gap-4">
      {/* Logo */}
      <a href="/" class="font-serif text-2xl font-bold text-brand-navy tracking-tight whitespace-nowrap">
        FashionMarket
      </a>

      {/* Barra de búsqueda (desktop) */}
      <div class="hidden lg:block flex-1 max-w-2xl mx-8">
        <SearchBar client:load />
      </div>

      {/* Carrito + Usuario + Menú mobile */}
      <div class="flex items-center space-x-4">
        {/* Usuario */}
        {isAuthenticated ? (
          <div class="relative">
            <button 
              id="user-menu-btn"
              class="flex items-center space-x-2 text-brand-charcoal hover:text-brand-navy transition-colors"
              aria-label="Menú de usuario"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </button>
            
            {/* Menú desplegable */}
            <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
              <a href="/perfil" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                Mi Perfil
              </a>
              <a href="/perfil#pedidos" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                Mis Pedidos
              </a>
              <hr class="my-1" />
              <button id="logout-btn-header" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                Cerrar Sesión
              </button>
            </div>
          </div>
        ) : (
          <a href="/auth/login" class="flex items-center space-x-2 text-brand-charcoal hover:text-brand-navy transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </a>
        )}
        
        <CartIcon client:load />
        
        <button 
          id="mobile-menu-btn"
          class="lg:hidden text-brand-charcoal hover:text-brand-navy p-2"
          aria-label="Abrir menú"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    {/* Fila inferior: Navegación principal */}
    <div class="hidden lg:flex items-center justify-center space-x-8 pb-4 border-t border-gray-100 pt-4">
      <GenderSelector currentGender={currentGender} client:load />
      
      <div class="h-6 w-px bg-gray-300"></div>
      
      <a href="/novedades" class="text-brand-charcoal hover:text-brand-navy transition-colors text-sm uppercase tracking-wider">
        Novedades
      </a>
      <a href="/ofertas" class="text-red-600 hover:text-red-700 transition-colors text-sm uppercase tracking-wider font-semibold">
        Rebajas
      </a>
      <a href="/sostenibilidad" class="text-brand-charcoal hover:text-brand-navy transition-colors text-sm uppercase tracking-wider">
        Sostenibilidad
      </a>
    </div>

    {/* Búsqueda mobile */}
    <div class="lg:hidden pb-4">
      <SearchBar client:load />
    </div>

    {/* Menú mobile */}
    <div id="mobile-menu" class="lg:hidden hidden pb-4 border-t border-gray-200 mt-4 pt-4">
      <div class="flex flex-col space-y-3">
        <a href="/mujer" class="text-brand-charcoal hover:text-brand-navy transition-colors font-medium py-2">
          Mujer
        </a>
        <a href="/hombre" class="text-brand-charcoal hover:text-brand-navy transition-colors font-medium py-2">
          Hombre
        </a>
        <a href="/novedades" class="text-brand-charcoal hover:text-brand-navy transition-colors font-medium py-2">
          Novedades
        </a>
        <a href="/ofertas" class="text-red-600 hover:text-red-700 transition-colors font-semibold py-2">
          Ofertas
        </a>
      </div>
    </div>
  </nav>
</header>

<script>
  // Toggle mobile menu
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  
  mobileMenuBtn?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
  });

  // Toggle user menu
  const userMenuBtn = document.getElementById('user-menu-btn');
  const userMenu = document.getElementById('user-menu');
  
  // Abrir/cerrar menú al hacer clic en el botón
  userMenuBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    userMenu?.classList.toggle('hidden');
  });

  // Cerrar menú al hacer clic fuera
  document.addEventListener('click', (e) => {
    if (userMenu && !userMenu.contains(e.target as Node) && !userMenuBtn?.contains(e.target as Node)) {
      userMenu.classList.add('hidden');
    }
  });

  // Cerrar menú al presionar Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && userMenu) {
      userMenu.classList.add('hidden');
    }
  });

  // Cerrar sesión desde el header
  document.getElementById('logout-btn-header')?.addEventListener('click', async () => {
    try {
      const response = await fetch('/api/auth/logout', {
        method: 'POST',
      });

      if (response.ok) {
        window.location.href = '/';
      }
    } catch (error) {
      console.error('Error al cerrar sesión:', error);
    }
  });
</script>
