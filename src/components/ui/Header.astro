---
import CartIcon from '../islands/CartIcon';
import SearchBar from '../search/SearchBar';

// Detectar p√°gina actual desde la URL para resaltar enlace activo
const currentPath = Astro.url.pathname;
---

<header class="header-premium sticky top-0 z-50">
  <!-- Barra superior decorativa -->
  <div class="header-top-bar">
    <div class="max-w-7xl mx-auto px-4 flex justify-center items-center">
      <span class="flex items-center gap-2 text-xs">
        <svg class="w-4 h-4 text-gold-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
        </svg>
        <span class="text-gold-400">Env√≠o gratis</span>
        <span class="text-gray-500">en pedidos +50‚Ç¨</span>
        <span class="mx-3 text-gray-700">|</span>
        <span class="text-emerald-400">Devoluciones gratuitas</span>
      </span>
    </div>
  </div>
  
  <!-- Header principal -->
  <div class="header-main">
    <div class="header-glow"></div>
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
      <!-- Fila principal: Logo + B√∫squeda + Acciones -->
      <div class="flex justify-between items-center py-4 gap-6">
        <!-- Logo -->
        <a href="/" class="group flex items-center gap-3 flex-shrink-0">
          <div class="logo-icon">
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M12 2L2 7l10 5 10-5-10-5z" class="stroke-gold-500"/>
              <path d="M2 17l10 5 10-5" class="stroke-gold-400 opacity-60"/>
              <path d="M2 12l10 5 10-5" class="stroke-gold-300 opacity-40"/>
            </svg>
          </div>
          <div class="flex flex-col">
            <span class="font-serif text-xl font-bold text-white tracking-tight whitespace-nowrap group-hover:text-gold-500 transition-colors duration-500">
              FashionMarket
            </span>
            <span class="text-[10px] text-gray-500 tracking-widest uppercase">Premium Fashion</span>
          </div>
        </a>

        <!-- Barra de b√∫squeda (desktop) -->
        <div class="hidden lg:block flex-1 max-w-lg mx-8">
          <SearchBar client:load />
        </div>

        <!-- Acciones: Usuario + Carrito -->
        <div class="flex items-center gap-3">
          <!-- Usuario Guest (solo visible sin sesi√≥n) -->
          <a id="user-guest" href="/auth/login" class="header-icon-btn flex" aria-label="Iniciar sesi√≥n">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </a>

          <!-- Usuario Autenticado (solo visible con sesi√≥n) -->
          <div id="user-auth" class="relative" style="display: none;">
            <button id="user-menu-btn" class="header-icon-btn" aria-label="Men√∫ de usuario">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </button>
            
            <!-- Men√∫ desplegable -->
            <div id="user-menu" class="hidden absolute right-0 mt-3 w-56 user-dropdown animate-scale-in">
              <div class="py-2">
                <a href="/perfil" class="dropdown-item">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  Mi Perfil
                </a>
                <a href="/perfil/mis-pedidos" class="dropdown-item">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                  </svg>
                  Mis Pedidos
                </a>
                <div class="my-2 mx-3 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
                <button id="logout-btn-header" class="dropdown-item text-red-400 hover:bg-red-500/10 w-full">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  Cerrar Sesi√≥n
                </button>
              </div>
            </div>
          </div>
          
          <CartIcon client:load />
        </div>
      </div>
    </nav>
  </div>

  <!-- Navegaci√≥n secundaria (Desktop) -->
  <div class="nav-bar hidden lg:block">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-center gap-1">
        <a href="/productos" class={`nav-item ${currentPath === '/productos' || currentPath.startsWith('/productos') ? 'nav-item-active' : ''}`}>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
          Todos
        </a>
        
        <span class="nav-divider"></span>
        
        <a href="/hombre" class={`nav-item ${currentPath.startsWith('/hombre') ? 'nav-item-active' : ''}`}>
          Hombre
        </a>
        
        <a href="/mujer" class={`nav-item ${currentPath.startsWith('/mujer') ? 'nav-item-active' : ''}`}>
          Mujer
        </a>
        
        <span class="nav-divider"></span>
        
        <a href="/novedades" class={`nav-item nav-item-new ${currentPath.startsWith('/novedades') ? 'nav-item-active' : ''}`}>
          <span class="nav-badge">New</span>
          Novedades
        </a>
        
        <a href="/ofertas" class={`nav-item nav-item-sale ${currentPath.startsWith('/ofertas') ? 'nav-item-active' : ''}`}>
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
          </svg>
          Rebajas
        </a>
        
        <a href="/sostenibilidad" class={`nav-item ${currentPath.startsWith('/sostenibilidad') ? 'nav-item-active' : ''}`}>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Eco
        </a>
      </div>
    </nav>
  </div>

  <!-- Navegaci√≥n mobile -->
  <div class="lg:hidden border-t border-white/5">
    <div class="flex items-center justify-center gap-1 py-2 px-2 overflow-x-auto">
      <a href="/productos" class={`nav-item-mobile ${currentPath.startsWith('/productos') ? 'nav-item-active' : ''}`}>
        Todos
      </a>
      <a href="/hombre" class={`nav-item-mobile ${currentPath.startsWith('/hombre') ? 'nav-item-active' : ''}`}>
        Hombre
      </a>
      <a href="/mujer" class={`nav-item-mobile ${currentPath.startsWith('/mujer') ? 'nav-item-active' : ''}`}>
        Mujer
      </a>
      <a href="/novedades" class={`nav-item-mobile nav-item-new ${currentPath.startsWith('/novedades') ? 'nav-item-active' : ''}`}>
        <span class="nav-badge-sm">New</span>
        Nuevo
      </a>
      <a href="/ofertas" class={`nav-item-mobile nav-item-sale ${currentPath.startsWith('/ofertas') ? 'nav-item-active' : ''}`}>
        Ofertas
      </a>
    </div>
    
    <!-- B√∫squeda mobile -->
    <div class="px-4 pb-3">
      <SearchBar client:load />
    </div>
  </div>
</header>

<style>
  /* === Barra superior === */
  .header-top-bar {
    background: linear-gradient(90deg, 
      #0a0a0a 0%, 
      #171717 50%,
      #0a0a0a 100%
    );
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    padding: 8px 0;
    box-shadow: 0 1px 0 rgba(212, 175, 55, 0.06);
  }

  /* === Header principal === */
  .header-premium {
    background: linear-gradient(180deg, 
      rgba(23, 23, 23, 0.98) 0%, 
      rgba(10, 10, 10, 0.96) 100%
    );
    backdrop-filter: blur(24px) saturate(150%);
    -webkit-backdrop-filter: blur(24px) saturate(150%);
    box-shadow: 
      0 4px 24px rgba(0, 0, 0, 0.6),
      0 1px 0 rgba(255, 255, 255, 0.08) inset,
      0 -1px 0 rgba(212, 175, 55, 0.12) inset;
  }

  .header-main {
    position: relative;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  }
  
  .header-glow {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 2px;
    background: linear-gradient(90deg, 
      transparent 0%, 
      rgba(212, 175, 55, 0.4) 25%,
      rgba(232, 201, 109, 0.6) 50%, 
      rgba(212, 175, 55, 0.4) 75%,
      transparent 100%
    );
    opacity: 0.7;
    filter: blur(1px);
    animation: glow-pulse 4s ease-in-out infinite;
  }

  @keyframes glow-pulse {
    0%, 100% { opacity: 0.5; filter: blur(1px); }
    50% { opacity: 0.9; filter: blur(0.5px); }
  }
  
  .logo-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.12) 0%, rgba(212, 175, 55, 0.04) 100%);
    border-radius: 12px;
    border: 1px solid rgba(212, 175, 55, 0.2);
    box-shadow: 
      0 0 16px rgba(212, 175, 55, 0.08),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .group:hover .logo-icon {
    border-color: rgba(212, 175, 55, 0.4);
    box-shadow: 
      0 0 24px rgba(212, 175, 55, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.08);
    transform: scale(1.05);
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.18) 0%, rgba(212, 175, 55, 0.06) 100%);
  }

  /* === Barra de navegaci√≥n === */
  .nav-bar {
    background: linear-gradient(180deg, 
      rgba(10, 10, 10, 0.92) 0%, 
      rgba(23, 23, 23, 0.96) 100%
    );
    border-top: 1px solid rgba(255, 255, 255, 0.06);
    border-bottom: 1px solid rgba(212, 175, 55, 0.1);
    padding: 12px 0;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
  }

  .nav-item {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: #a3a3a3;
    padding: 10px 18px;
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .nav-item:hover {
    color: #f5f5f5;
    background: rgba(255, 255, 255, 0.06);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .nav-item-active {
    color: #d4af37 !important;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.12) 0%, rgba(212, 175, 55, 0.06) 100%);
    box-shadow: 0 2px 12px rgba(212, 175, 55, 0.15);
  }

  .nav-item-active::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 40%;
    height: 2px;
    background: linear-gradient(90deg, #d4af37, #e8c96d);
    border-radius: 2px;
  }

  .nav-divider {
    width: 1px;
    height: 24px;
    background: linear-gradient(180deg, 
      transparent 0%,
      rgba(255, 255, 255, 0.15) 50%,
      transparent 100%
    );
    margin: 0 8px;
  }

  /* === Estilos especiales para Novedades y Rebajas === */
  .nav-item-new {
    color: #10b981;
  }

  .nav-item-new:hover {
    color: #34d399;
    background: rgba(16, 185, 129, 0.1);
  }

  .nav-item-sale {
    color: #ef4444;
  }

  .nav-item-sale:hover {
    color: #f87171;
    background: rgba(239, 68, 68, 0.1);
  }

  .nav-badge {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 4px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    animation: badge-pulse 2s ease-in-out infinite;
  }

  .nav-badge-sm {
    font-size: 8px;
    font-weight: 700;
    padding: 1px 4px;
    border-radius: 3px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
  }

  @keyframes badge-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  /* === Iconos del header === */
  .header-icon-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border-radius: 12px;
    color: #a3a3a3;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .header-icon-btn:hover {
    color: #d4af37;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.08) 100%);
    border-color: rgba(212, 175, 55, 0.35);
    transform: translateY(-2px);
    box-shadow: 
      0 8px 24px rgba(212, 175, 55, 0.2),
      0 2px 8px rgba(0, 0, 0, 0.4);
  }
  
  /* === Dropdown usuario === */
  .user-dropdown {
    background: linear-gradient(135deg, rgba(38, 38, 38, 0.96) 0%, rgba(23, 23, 23, 0.98) 100%);
    backdrop-filter: blur(32px) saturate(150%);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 16px;
    box-shadow: 
      0 24px 48px rgba(0, 0, 0, 0.7),
      0 0 0 1px rgba(255, 255, 255, 0.06) inset,
      0 1px 0 rgba(212, 175, 55, 0.08);
    z-index: 50;
  }
  
  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    font-size: 14px;
    color: #d4d4d4;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .dropdown-item:hover {
    color: #d4af37;
    background: rgba(255, 255, 255, 0.06);
    box-shadow: inset 0 0 0 1px rgba(212, 175, 55, 0.15);
  }

  /* === Navegaci√≥n mobile === */
  .nav-item-mobile {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 0.02em;
    color: #9ca3af;
    padding: 8px 12px;
    border-radius: 6px;
    white-space: nowrap;
    transition: all 0.2s ease;
  }
  
  .nav-item-mobile:hover {
    color: #d4af37;
    background: rgba(212, 175, 55, 0.1);
  }
  
  .nav-item-mobile.nav-item-active {
    color: #d4af37;
    background: rgba(212, 175, 55, 0.15);
  }

  .nav-item-mobile.nav-item-new {
    color: #10b981;
  }

  .nav-item-mobile.nav-item-sale {
    color: #ef4444;
  }

  /* === Animaciones === */
  @keyframes scale-in {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(-10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .animate-scale-in {
    animation: scale-in 0.2s ease-out;
  }
</style>

<script>
  // Toggle user menu
  const userMenuBtn = document.getElementById('user-menu-btn');
  const userMenu = document.getElementById('user-menu');
  
  // Abrir/cerrar men√∫ al hacer clic en el bot√≥n
  userMenuBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    userMenu?.classList.toggle('hidden');
  });

  // Cerrar men√∫ al hacer clic fuera (pero NO en los enlaces internos)
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    // Si se hace clic en un enlace dentro del men√∫, dejar que navegue
    if (target.tagName === 'A' && userMenu?.contains(target)) {
      return;
    }
    // Si se hace clic fuera del men√∫ y del bot√≥n, cerrar
    if (userMenu && !userMenu.contains(target) && !userMenuBtn?.contains(target)) {
      userMenu.classList.add('hidden');
    }
  });

  // Cerrar men√∫ al presionar Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && userMenu) {
      userMenu.classList.add('hidden');
    }
  });

  // Cerrar sesi√≥n desde el header
  (async () => {
    try {
      const { supabase } = await import('../../lib/supabase');
      const guestEl = document.getElementById('user-guest');
      const authEl = document.getElementById('user-auth');

      console.log('üîê [HEADER] Elementos encontrados:', { guestEl: !!guestEl, authEl: !!authEl });

      const toggle = (hasUser: boolean) => {
        console.log('üîê [HEADER] Toggle llamado con hasUser:', hasUser);
        if (!guestEl || !authEl) {
          console.error('üîê [HEADER] ERROR: Elementos no encontrados');
          return;
        }
        if (hasUser) {
          // Usuario autenticado: ocultar guest, mostrar auth
          guestEl.style.display = 'none';
          guestEl.classList.add('hidden');
          authEl.style.display = 'block';
          authEl.classList.remove('hidden');
          console.log('üîê [HEADER] Usuario autenticado - ocultando guest, mostrando auth');
        } else {
          // Usuario no autenticado: mostrar guest, ocultar auth
          guestEl.style.display = 'flex';
          guestEl.classList.remove('hidden');
          authEl.style.display = 'none';
          authEl.classList.add('hidden');
          console.log('üîê [HEADER] Sin usuario - mostrando guest, ocultando auth');
        }
      };

      const clearAuthArtifacts = () => {
        try {
          // Borrar cookies manuales
          const expire = 'Expires=Thu, 01 Jan 1970 00:00:01 GMT; Path=/; SameSite=Lax';
          document.cookie = `sb-access-token=; ${expire}`;
          document.cookie = `sb-refresh-token=; ${expire}`;
          // Borrar claves sb-* en localStorage (incluyendo custom sb-user-*)
          const toRemove: string[] = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('sb-')) toRemove.push(key);
          }
          toRemove.forEach((k) => localStorage.removeItem(k));
        } catch (e) {
          console.warn('No se pudieron limpiar claves/cookies sb-*', e);
        }
      };

      // Logout button
      document.getElementById('logout-btn-header')?.addEventListener('click', async () => {
        console.log('üîì [HEADER] Logout iniciado...');
        try {
          // Limpiar PRIMERO antes de signOut para evitar race conditions
          clearAuthArtifacts();
          console.log('üîì [HEADER] Artefactos limpios, llamando signOut...');
          
          // Llamar signOut DESPU√âS de limpiar
          await supabase.auth.signOut();
          console.log('üîì [HEADER] signOut completado');
        } catch (e) {
          console.warn('üîì [HEADER] supabase.signOut fall√≥ (es ok, limpieza igual fue ejecutada):', e);
        } finally {
          // Esperar 200ms para que los eventos se procesen
          await new Promise((r) => setTimeout(r, 200));
          console.log('üîì [HEADER] Redirigiendo a /');
          window.location.href = '/';
        }
      });

      // Estado inicial - verificar sesi√≥n inmediatamente
      const { data, error } = await supabase.auth.getSession();
      console.log('üîê [HEADER] Estado inicial - session:', !!data.session, 'error:', error);
      toggle(!!data.session?.user);

      // Escuchar cambios de autenticaci√≥n
      supabase.auth.onAuthStateChange((event: any, session: any) => {
        console.log('üîê [HEADER] Auth state change:', event, 'hasSession:', !!session);
        if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
          toggle(!!session?.user);
        }
        if (event === 'SIGNED_OUT') {
          clearAuthArtifacts();
          toggle(false);
        }
      });
    } catch (err) {
      console.error('Error toggling user menu:', err);
    }
  })();
</script>
