---
/**
 * ============================================================================
 * DETALLE DE PEDIDO + TIMELINE DE SEGUIMIENTO
 * ============================================================================
 * Ruta: /perfil/mis-pedidos/[id]
 * - Muestra informaci√≥n completa del pedido
 * - Timeline visual del estado
 * - Acciones disponibles (cancelar si aplica)
 */
import PublicLayout from '../../../layouts/PublicLayout.astro';
import { createClient } from '@supabase/supabase-js';

const { id } = Astro.params;

// Crear cliente de Supabase
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

// Obtener tokens de las cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

if (!accessToken || !refreshToken) {
  return Astro.redirect('/auth/login?redirect=/perfil/mis-pedidos/' + id);
}

// Crear cliente con autorizaci√≥n
const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: false,
    autoRefreshToken: false,
  },
  global: {
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  },
});

// Verificar usuario
const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  return Astro.redirect('/auth/login?redirect=/perfil/mis-pedidos/' + id);
}

// Obtener el pedido con sus items
const { data: order, error } = await supabase
  .from('orders')
  .select(`
    *,
    order_items (*)
  `)
  .eq('id', id)
  .eq('user_id', user.id)
  .single();

// Si no existe o no pertenece al usuario
if (error || !order) {
  return Astro.redirect('/perfil/mis-pedidos');
}

// Funci√≥n para formatear fecha
const formatDate = (dateString: string | null) => {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// Funci√≥n para formatear moneda
const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(amount);
};

// Estados del timeline
const timelineSteps = [
  { 
    id: 'pending', 
    name: 'Pendiente', 
    description: 'Pedido recibido',
    icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2'
  },
  { 
    id: 'confirmed', 
    name: 'Confirmado', 
    description: 'Pago verificado',
    icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'
  },
  { 
    id: 'processing', 
    name: 'Procesando', 
    description: 'Preparando env√≠o',
    icon: 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4'
  },
  { 
    id: 'shipped', 
    name: 'Enviado', 
    description: 'En camino',
    icon: 'M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0'
  },
  { 
    id: 'delivered', 
    name: 'Entregado', 
    description: 'Pedido completado',
    icon: 'M5 13l4 4L19 7'
  }
];

// Determinar el paso actual
const statusOrder = ['pending', 'confirmed', 'processing', 'shipped', 'delivered'];
const currentStepIndex = statusOrder.indexOf(order.status);
const isCancelled = order.status === 'cancelled';
const isRefunded = order.status === 'refunded';
const isReturnRequested = order.status === 'return_requested';

// Calcular tiempo desde el pedido
const orderCreatedAt = new Date(order.created_at).getTime();
const timeSinceOrderMs = Date.now() - orderCreatedAt;
const TWO_HOURS_MS = 2 * 60 * 60 * 1000;
const isWithin2Hours = timeSinceOrderMs < TWO_HOURS_MS;
const minutesLeft = Math.max(0, Math.floor((TWO_HOURS_MS - timeSinceOrderMs) / 60000));

// Puede cancelar directamente (<2h, no enviado/entregado)
const canCancel = isWithin2Hours && !['shipped', 'delivered', 'cancelled', 'refunded', 'return_requested'].includes(order.status);

// Puede solicitar devoluci√≥n (>2h o ya entregado, no cancelado/reembolsado)
const canRequestReturn = !isWithin2Hours && !['cancelled', 'refunded', 'return_requested'].includes(order.status);

// Obtener info de estado (colores mejorados para tema oscuro)
const getStatusInfo = (status: string) => {
  const info: Record<string, { color: string; text: string; bg: string; icon: string }> = {
    pending: { color: 'text-amber-300', text: 'Pendiente', bg: 'bg-amber-500/20 border border-amber-400/40', icon: '' },
    confirmed: { color: 'text-blue-300', text: 'Confirmado', bg: 'bg-blue-500/20 border border-blue-400/40', icon: '‚úì' },
    processing: { color: 'text-purple-300', text: 'Procesando', bg: 'bg-purple-500/20 border border-purple-400/40', icon: '' },
    shipped: { color: 'text-indigo-300', text: 'Enviado', bg: 'bg-indigo-500/20 border border-indigo-400/40', icon: '‚Üí' },
    delivered: { color: 'text-emerald-300', text: 'Entregado', bg: 'bg-emerald-500/20 border border-emerald-400/40', icon: '‚úì' },
    cancelled: { color: 'text-red-300', text: 'Cancelado', bg: 'bg-red-500/20 border border-red-400/40', icon: '‚úï' },
    refunded: { color: 'text-gray-300', text: 'Reembolsado', bg: 'bg-gray-500/20 border border-gray-400/40', icon: '‚Ü©' },
    return_requested: { color: 'text-orange-300', text: 'Devoluci√≥n Solicitada', bg: 'bg-orange-500/20 border border-orange-400/40', icon: '‚Ü©' }
  };
  return info[status] || info.pending;
};

const statusInfo = getStatusInfo(order.status);
---

<PublicLayout title={`Pedido #${order.order_number}`}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6">
      <ol class="flex items-center space-x-2 text-sm text-gray-400">
        <li><a href="/perfil" class="hover:text-accent-gold transition-colors">Mi Perfil</a></li>
        <li class="text-gray-600">/</li>
        <li><a href="/perfil/mis-pedidos" class="hover:text-accent-gold transition-colors">Mis Pedidos</a></li>
        <li class="text-gray-600">/</li>
        <li class="text-white font-medium">{order.order_number}</li>
      </ol>
    </nav>

    <!-- Header mejorado -->
    <div class="bg-dark-surface/80 backdrop-blur-sm rounded-2xl border border-white/10 p-6 mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-3xl font-bold text-white font-serif">
            {order.order_number}
          </h1>
          <p class="text-gray-400 mt-2">
            Realizado el {formatDate(order.created_at)}
          </p>
        </div>
        <div class="flex items-center gap-4">
          <span class={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold ${statusInfo.bg} ${statusInfo.color}`}>
            <span>{statusInfo.icon}</span>
            {statusInfo.text}
          </span>
          <span class="text-3xl font-bold text-accent-gold">
            {formatCurrency(order.total)}
          </span>
        </div>
      </div>
    </div>

    <!-- Timeline de seguimiento (tema oscuro) -->
    {!isCancelled && !isRefunded && (
      <div class="bg-dark-surface/80 backdrop-blur-sm rounded-2xl border border-white/10 p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-6">Seguimiento del Pedido</h2>
        
        <div class="relative">
          <!-- L√≠nea de progreso -->
          <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-white/10" aria-hidden="true"></div>
          
          <!-- Steps -->
          <ul class="space-y-6">
            {timelineSteps.map((step, index) => (
              <li class="relative flex items-start">
                <!-- Icono del step -->
                <div class={`
                  relative z-10 flex items-center justify-center w-16 h-16 rounded-full border-2 transition-all
                  ${index <= currentStepIndex 
                    ? 'bg-accent-gold border-accent-gold' 
                    : 'bg-dark-card border-white/20'}
                  ${index === currentStepIndex ? 'ring-4 ring-accent-gold/30 scale-110' : ''}
                `}>
                  <svg 
                    class={`w-7 h-7 ${index <= currentStepIndex ? 'text-dark-bg' : 'text-gray-500'}`} 
                    fill="none" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={step.icon} />
                  </svg>
                </div>
                
                <!-- Texto del step -->
                <div class="ml-4 min-w-0 flex-1">
                  <h3 class={`text-base font-semibold ${index <= currentStepIndex ? 'text-white' : 'text-gray-500'}`}>
                    {step.name}
                  </h3>
                  <p class={`text-sm ${index <= currentStepIndex ? 'text-gray-300' : 'text-gray-600'}`}>
                    {step.description}
                  </p>
                  
                  {step.id === 'pending' && order.created_at && (
                    <p class="text-xs text-gray-500 mt-1">{formatDate(order.created_at)}</p>
                  )}
                  {step.id === 'shipped' && order.shipped_at && (
                    <p class="text-xs text-gray-500 mt-1">{formatDate(order.shipped_at)}</p>
                  )}
                  {step.id === 'delivered' && order.delivered_at && (
                    <p class="text-xs text-gray-500 mt-1">{formatDate(order.delivered_at)}</p>
                  )}
                </div>
              </li>
            ))}
          </ul>
        </div>
        
        {/* Tracking number */}
        {order.tracking_number && (
          <div class="mt-6 pt-6 border-t border-white/10">
            <div class="flex items-center justify-between bg-dark-card/50 rounded-xl p-4 border border-white/10">
              <div>
                <p class="text-sm font-medium text-gray-400">N√∫mero de seguimiento</p>
                <p class="text-lg font-mono font-bold text-accent-gold">{order.tracking_number}</p>
              </div>
              <button 
                id="copy-tracking"
                data-tracking={order.tracking_number}
                class="px-4 py-2 text-sm font-medium text-accent-gold hover:text-dark-bg hover:bg-accent-gold border border-accent-gold rounded-lg transition-all"
              >
                Copiar
              </button>
            </div>
          </div>
        )}
      </div>
    )}

    <!-- Estado especial: Cancelado, Reembolsado o Devoluci√≥n solicitada -->
    {(isCancelled || isRefunded || isReturnRequested) && (
      <div class={`bg-dark-surface/80 backdrop-blur-sm rounded-2xl border p-6 mb-6 ${isCancelled ? 'border-red-500/40' : isReturnRequested ? 'border-orange-500/40' : 'border-white/10'}`}>
        <div class="flex items-center">
          <div class={`flex-shrink-0 w-14 h-14 rounded-full flex items-center justify-center ${isCancelled ? 'bg-red-500/20' : isReturnRequested ? 'bg-orange-500/20' : 'bg-gray-500/20'}`}>
            <svg class={`w-7 h-7 ${isCancelled ? 'text-red-400' : isReturnRequested ? 'text-orange-400' : 'text-gray-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              {isCancelled ? (
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              ) : (
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
              )}
            </svg>
          </div>
          <div class="ml-5">
            <h3 class={`text-xl font-semibold ${isCancelled ? 'text-red-300' : isReturnRequested ? 'text-orange-300' : 'text-white'}`}>
              {isCancelled ? 'Pedido Cancelado' : isReturnRequested ? 'Devoluci√≥n en Proceso' : 'Pedido Reembolsado'}
            </h3>
            <p class={`text-sm mt-1 ${isCancelled ? 'text-red-300/70' : isReturnRequested ? 'text-orange-300/70' : 'text-gray-400'}`}>
              {isCancelled 
                ? 'Este pedido fue cancelado. El reembolso ha sido procesado.' 
                : isReturnRequested
                  ? 'Tu solicitud de devoluci√≥n est√° siendo procesada. Sigue las instrucciones para enviar el producto.'
                  : 'Este pedido ha sido reembolsado. El dinero ser√° devuelto en 3-5 d√≠as laborables.'}
            </p>
          </div>
        </div>
      </div>
    )}

    <!-- Productos del pedido -->
    <div class="bg-dark-surface/80 backdrop-blur-sm rounded-2xl border border-white/10 overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-white/10 bg-white/5">
        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
          <svg class="w-5 h-5 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          Productos ({order.order_items?.length || 0})
        </h2>
      </div>
      
      <div class="divide-y divide-white/5">
        {order.order_items?.map((item: any) => (
          <div class="p-6 flex items-start gap-4 hover:bg-white/5 transition-colors">
            {item.product_image ? (
              <img 
                src={item.product_image} 
                alt={item.product_name}
                class="w-24 h-24 object-cover rounded-xl flex-shrink-0 border border-white/10 shadow-lg"
              />
            ) : (
              <div class="w-24 h-24 bg-dark-card rounded-xl flex items-center justify-center flex-shrink-0 border border-white/10">
                <svg class="w-10 h-10 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
            )}
            <div class="flex-1 min-w-0">
              <h3 class="text-lg font-medium text-white">{item.product_name}</h3>
              <div class="mt-2 flex flex-wrap items-center gap-3 text-sm">
                {item.size && (
                  <span class="px-2 py-1 bg-white/5 rounded-md text-gray-300 border border-white/10">
                    Talla: <strong class="text-white">{item.size}</strong>
                  </span>
                )}
                {item.color && (
                  <span class="px-2 py-1 bg-white/5 rounded-md text-gray-300 border border-white/10">
                    Color: <strong class="text-white">{item.color}</strong>
                  </span>
                )}
                <span class="px-2 py-1 bg-white/5 rounded-md text-gray-300 border border-white/10">
                  Cantidad: <strong class="text-white">{item.quantity}</strong>
                </span>
              </div>
              <p class="mt-2 text-sm text-gray-400">
                {formatCurrency(item.price)} √ó {item.quantity}
              </p>
            </div>
            <div class="text-right">
              <p class="text-xl font-bold text-accent-gold">
                {formatCurrency(item.subtotal)}
              </p>
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- Resumen y Direcci√≥n -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Direcci√≥n de env√≠o -->
      <div class="bg-dark-surface/80 backdrop-blur-sm rounded-2xl border border-white/10 p-6">
        <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          Direcci√≥n de Env√≠o
        </h2>
        <div class="text-gray-400 space-y-2 bg-dark-card/50 rounded-xl p-4 border border-white/5">
          <p class="font-semibold text-lg text-white">{order.shipping_full_name}</p>
          <p class="text-gray-300">{order.shipping_address_line1}</p>
          {order.shipping_address_line2 && <p class="text-gray-300">{order.shipping_address_line2}</p>}
          <p class="text-gray-300">{order.shipping_city}, {order.shipping_state} {order.shipping_postal_code}</p>
          <p class="text-gray-300">{order.shipping_country}</p>
          {order.shipping_phone && (
            <p class="mt-3 pt-3 border-t border-white/10 flex items-center gap-2">
              <svg class="w-4 h-4 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
              <span class="text-white">{order.shipping_phone}</span>
            </p>
          )}
        </div>
      </div>

      <!-- Resumen del pedido -->
      <div class="bg-dark-surface/80 backdrop-blur-sm rounded-2xl border border-white/10 p-6">
        <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
          Resumen
        </h2>
        <div class="space-y-3 bg-dark-card/50 rounded-xl p-4 border border-white/5">
          <div class="flex justify-between text-gray-400">
            <span>Subtotal</span>
            <span class="text-white font-medium">{formatCurrency(order.subtotal)}</span>
          </div>
          <div class="flex justify-between text-gray-400">
            <span>Env√≠o</span>
            <span class="text-white font-medium">{formatCurrency(order.shipping_cost)}</span>
          </div>
          {order.discount > 0 && (
            <div class="flex justify-between text-emerald-400">
              <span>Descuento</span>
              <span class="font-medium">-{formatCurrency(order.discount)}</span>
            </div>
          )}
          <div class="flex justify-between text-gray-400">
            <span>IVA (21%)</span>
            <span class="text-white font-medium">{formatCurrency(order.tax)}</span>
          </div>
          <div class="flex justify-between text-xl font-bold pt-4 mt-2 border-t border-white/10">
            <span class="text-white">Total</span>
            <span class="text-accent-gold">{formatCurrency(order.total)}</span>
          </div>
        </div>
        
        <div class="mt-4 flex items-center gap-2 text-sm bg-white/5 rounded-lg px-4 py-3 border border-white/10">
          <svg class="w-5 h-5 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
          </svg>
          <span class="text-gray-400">M√©todo de pago:</span>
          <span class="text-white font-medium">{order.payment_method}</span>
        </div>
      </div>
    </div>

    <!-- Acciones -->
    <div class="bg-dark-surface/80 backdrop-blur-sm rounded-2xl border border-white/10 p-6">
      <div class="flex flex-wrap gap-4">
        <a 
          href="/perfil/mis-pedidos"
          class="inline-flex items-center px-5 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-sm font-medium text-white transition-all hover:scale-105"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Volver a mis pedidos
        </a>
        
        <button 
          id="download-invoice"
          data-order-id={order.id}
          data-order-number={order.order_number}
          class="inline-flex items-center px-5 py-3 bg-accent-gold hover:bg-accent-gold/90 rounded-xl text-sm font-semibold text-dark-bg transition-all hover:scale-105"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
          </svg>
          Descargar Factura
        </button>

        {/* Bot√≥n Cancelar (solo si <2h y no enviado) */}
        {canCancel && (
          <button 
            id="cancel-order"
            data-order-id={order.id}
            class="inline-flex items-center px-4 py-3 border border-red-500/30 rounded-xl text-sm font-medium text-red-400 bg-red-500/10 hover:bg-red-500/20 transition-colors"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            Cancelar Pedido
            <span class="ml-2 text-xs text-red-400/60">({minutesLeft} min restantes)</span>
          </button>
        )}

        {/* Bot√≥n Solicitar Devoluci√≥n (>2h, no cancelado/reembolsado) */}
        {canRequestReturn && (
          <button 
            id="request-return"
            data-order-id={order.id}
            data-order-total={order.total}
            class="inline-flex items-center px-4 py-3 border border-blue-500/30 rounded-xl text-sm font-medium text-blue-400 bg-blue-500/10 hover:bg-blue-500/20 transition-colors"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
            </svg>
            Solicitar Devoluci√≥n
          </button>
        )}
      </div>

      {/* Info de fase seg√∫n tiempo */}
      {!isCancelled && !isRefunded && !isReturnRequested && (
        <div class={`mt-4 p-3 rounded-lg text-sm ${isWithin2Hours ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-blue-500/10 border border-blue-500/20'}`}>
          {isWithin2Hours ? (
            <p class="text-emerald-300">
              <strong>Cancelaci√≥n gratuita disponible</strong> ‚Äî Puedes cancelar este pedido y recibir un reembolso inmediato. Te quedan <strong>{minutesLeft} minutos</strong>.
            </p>
          ) : (
            <p class="text-blue-300">
              <strong>Per√≠odo de devoluci√≥n</strong> ‚Äî El plazo de cancelaci√≥n directa ha expirado. Puedes solicitar una devoluci√≥n y recibir√°s el reembolso cuando recibamos el producto.
            </p>
          )}
        </div>
      )}
    </div>
  </div>

  <!-- ==================== MODAL DE CANCELACI√ìN (<2h) ==================== -->
  <div id="cancel-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" id="cancel-overlay"></div>
      <div class="relative bg-dark-surface rounded-2xl border border-white/10 shadow-2xl max-w-md w-full p-6">
        <div class="flex items-start">
          <div class="flex-shrink-0 w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center">
            <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <div class="ml-4">
            <h3 class="text-lg font-semibold text-white">¬øCancelar pedido?</h3>
            <p class="mt-2 text-sm text-gray-400">
              Tu pedido ser√° cancelado y recibir√°s el reembolso completo de forma inmediata. El dinero estar√° en tu cuenta en 3-5 d√≠as laborables.
            </p>
            <div class="mt-3 p-2.5 bg-emerald-500/10 rounded-lg border border-emerald-500/20">
              <p class="text-xs text-emerald-300">Reembolso inmediato ‚Äî No necesitas devolver nada.</p>
            </div>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button id="cancel-modal-close" class="px-4 py-2 text-sm font-medium text-gray-300 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition-colors">
            No, mantener
          </button>
          <button id="cancel-modal-confirm" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
            S√≠, cancelar y reembolsar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL DE DEVOLUCI√ìN (>2h) ==================== -->
  <div id="return-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 py-8">
      <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" id="return-overlay"></div>
      <div class="relative bg-dark-surface rounded-2xl border border-white/10 shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        
        <!-- Header del modal -->
        <div class="sticky top-0 bg-dark-surface border-b border-white/10 px-6 py-4 rounded-t-2xl z-10">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-semibold text-white flex items-center gap-2">
              <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
              </svg>
              Solicitar Devoluci√≥n
            </h3>
            <button id="return-modal-close" class="text-gray-400 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
        
        <div class="px-6 py-5 space-y-6">
          <!-- Paso 1: Seleccionar motivo -->
          <div>
            <label class="block text-sm font-semibold text-white mb-3">¬øPor qu√© quieres devolver el pedido? <span class="text-red-400">*</span></label>
            <div class="space-y-2" id="reason-options">
              <label class="flex items-center gap-3 p-3 rounded-lg border border-white/10 hover:border-blue-500/40 cursor-pointer transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-500/10">
                <input type="radio" name="return-reason" value="wrong_size" class="accent-blue-500">
                <div>
                  <span class="text-white text-sm font-medium">Talla incorrecta</span>
                  <p class="text-xs text-gray-500">La talla no me queda bien</p>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 rounded-lg border border-white/10 hover:border-blue-500/40 cursor-pointer transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-500/10">
                <input type="radio" name="return-reason" value="defective" class="accent-blue-500">
                <div>
                  <span class="text-white text-sm font-medium">Producto defectuoso</span>
                  <p class="text-xs text-gray-500">El producto tiene alg√∫n defecto o est√° da√±ado</p>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 rounded-lg border border-white/10 hover:border-blue-500/40 cursor-pointer transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-500/10">
                <input type="radio" name="return-reason" value="wrong_item" class="accent-blue-500">
                <div>
                  <span class="text-white text-sm font-medium">Producto incorrecto</span>
                  <p class="text-xs text-gray-500">Me han enviado un producto diferente al que ped√≠</p>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 rounded-lg border border-white/10 hover:border-blue-500/40 cursor-pointer transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-500/10">
                <input type="radio" name="return-reason" value="not_as_described" class="accent-blue-500">
                <div>
                  <span class="text-white text-sm font-medium">No es como se describ√≠a</span>
                  <p class="text-xs text-gray-500">El producto no coincide con la descripci√≥n o las fotos</p>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 rounded-lg border border-white/10 hover:border-blue-500/40 cursor-pointer transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-500/10">
                <input type="radio" name="return-reason" value="changed_mind" class="accent-blue-500">
                <div>
                  <span class="text-white text-sm font-medium">üí≠ He cambiado de opini√≥n</span>
                  <p class="text-xs text-gray-500">Ya no quiero el producto</p>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 rounded-lg border border-white/10 hover:border-blue-500/40 cursor-pointer transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-500/10">
                <input type="radio" name="return-reason" value="better_price" class="accent-blue-500">
                <div>
                  <span class="text-white text-sm font-medium">Encontr√© un precio mejor</span>
                  <p class="text-xs text-gray-500">He visto el mismo producto m√°s barato en otro sitio</p>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 rounded-lg border border-white/10 hover:border-orange-500/40 cursor-pointer transition-colors has-[:checked]:border-orange-500 has-[:checked]:bg-orange-500/10">
                <input type="radio" name="return-reason" value="other" class="accent-orange-500">
                <div>
                  <span class="text-white text-sm font-medium">Otro motivo</span>
                  <p class="text-xs text-gray-500">Quiero especificar mi propio motivo</p>
                </div>
              </label>
            </div>
          </div>

          <!-- Campo de texto para "Otro" (aparece al seleccionar "other") -->
          <div id="other-reason-container" class="hidden">
            <label class="block text-sm font-semibold text-white mb-2">Especifica el motivo <span class="text-red-400">*</span></label>
            <textarea 
              id="other-reason-text"
              placeholder="Describe tu motivo (m√≠nimo 10 caracteres)..."
              class="w-full px-4 py-3 bg-dark-card border border-white/10 rounded-lg text-white text-sm placeholder-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-none"
              rows="3"
            ></textarea>
            <p class="text-xs text-gray-500 mt-1"><span id="other-char-count">0</span>/10 caracteres m√≠nimo</p>
          </div>

          <!-- Paso 2: Descripci√≥n adicional (siempre visible) -->
          <div>
            <label class="block text-sm font-semibold text-white mb-2">Detalles adicionales <span class="text-gray-500 font-normal">(opcional)</span></label>
            <textarea 
              id="return-description"
              placeholder="¬øAlgo m√°s que quieras a√±adir? Describe cualquier detalle que pueda ayudarnos..."
              class="w-full px-4 py-3 bg-dark-card border border-white/10 rounded-lg text-white text-sm placeholder-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-none"
              rows="3"
            ></textarea>
          </div>

          <!-- Info importante -->
          <div class="bg-amber-500/10 border border-amber-500/20 rounded-xl p-4">
            <h4 class="text-sm font-semibold text-amber-300 mb-2 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              Informaci√≥n importante
            </h4>
            <ul class="text-xs text-amber-200/80 space-y-1.5">
              <li>‚Ä¢ Tienes <strong class="text-amber-200">7 d√≠as</strong> para enviar el producto a nuestra direcci√≥n.</li>
              <li>‚Ä¢ El producto debe estar <strong class="text-amber-200">sin usar, con etiquetas y en su embalaje original</strong>.</li>
              <li>‚Ä¢ El reembolso se procesar√° <strong class="text-amber-200">cuando recibamos el producto</strong>.</li>
              <li>‚Ä¢ Si no recibimos el producto en el plazo, la solicitud se cancelar√° autom√°ticamente.</li>
              <li>‚Ä¢ Los gastos de env√≠o de devoluci√≥n corren a cargo del cliente.</li>
            </ul>
          </div>
        </div>
        
        <!-- Footer del modal -->
        <div class="sticky bottom-0 bg-dark-surface border-t border-white/10 px-6 py-4 rounded-b-2xl flex justify-end gap-3">
          <button id="return-modal-cancel" class="px-5 py-2.5 text-sm font-medium text-gray-300 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition-colors">
            Cancelar
          </button>
          <button id="return-modal-submit" disabled class="px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
            Solicitar Devoluci√≥n
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL DE INSTRUCCIONES (despu√©s de enviar solicitud) ==================== -->
  <div id="instructions-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 py-8">
      <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" id="instructions-overlay"></div>
      <div class="relative bg-dark-surface rounded-2xl border border-emerald-500/30 shadow-2xl max-w-lg w-full p-6">
        <div class="text-center mb-6">
          <div class="w-16 h-16 mx-auto rounded-full bg-emerald-500/20 flex items-center justify-center mb-4">
            <svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white">Solicitud registrada</h3>
          <p class="text-sm text-gray-400 mt-1" id="instructions-return-number"></p>
        </div>

        <div class="space-y-4">
          <div class="bg-dark-card/50 rounded-xl p-4 border border-white/10">
            <h4 class="text-sm font-semibold text-white mb-3 flex items-center gap-2">
              Instrucciones para devolver el producto
            </h4>
            <ol class="text-sm text-gray-300 space-y-2 list-decimal list-inside">
              <li>Empaqueta el producto en su <strong class="text-white">embalaje original</strong> o en un paquete adecuado.</li>
              <li>Incluye una <strong class="text-white">nota con tu n√∫mero de devoluci√≥n</strong> dentro del paquete.</li>
              <li>Aseg√∫rate de que el producto est√© <strong class="text-white">sin usar y con etiquetas</strong>.</li>
              <li>Env√≠a el paquete a la direcci√≥n indicada abajo.</li>
              <li>Conserva el <strong class="text-white">comprobante de env√≠o</strong> y n√∫mero de seguimiento.</li>
            </ol>
          </div>

          <div class="bg-dark-card/50 rounded-xl p-4 border border-white/10">
            <h4 class="text-sm font-semibold text-white mb-2">üìç Direcci√≥n de env√≠o</h4>
            <p class="text-sm text-gray-300 font-mono">
              FashionMarket ‚Äî Devoluciones<br>
              Calle Ejemplo, 123<br>
              28001 Madrid, Espa√±a
            </p>
          </div>

          <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-4">
            <p class="text-sm text-red-300">
              <strong>Plazo l√≠mite:</strong> <span id="instructions-deadline" class="font-semibold"></span>
            </p>
            <p class="text-xs text-red-300/70 mt-1">Si no recibimos el producto antes de esta fecha, la solicitud se cancelar√° autom√°ticamente y no recibir√°s el reembolso.</p>
          </div>
        </div>

        <div class="mt-6">
          <button id="instructions-close" class="w-full px-5 py-3 text-sm font-semibold text-dark-bg bg-accent-gold rounded-lg hover:bg-accent-gold/90 transition-colors">
            Entendido
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-4 right-4 z-[60]">
    <div class="bg-dark-surface/95 backdrop-blur-xl rounded-lg shadow-glow border-l-4 p-4 max-w-md border border-white/10" id="toast-container">
      <div class="flex items-center">
        <svg id="toast-icon" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p id="toast-message" class="text-white font-medium"></p>
      </div>
    </div>
  </div>

  <!-- Datos para JS -->
  <div id="order-data" class="hidden" data-order-id={order.id} data-order-number={order.order_number}></div>

  <script>
    // === Helpers ===
    function showToast(message: string, type: 'success' | 'error') {
      const toast = document.getElementById('toast');
      const container = document.getElementById('toast-container');
      const msg = document.getElementById('toast-message');
      const icon = document.getElementById('toast-icon');
      if (!toast || !container || !msg || !icon) return;

      msg.textContent = message;
      container.classList.toggle('border-red-500', type === 'error');
      container.classList.toggle('border-accent-glow', type === 'success');
      icon.classList.toggle('text-red-400', type === 'error');
      icon.classList.toggle('text-accent-glow', type === 'success');
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }

    async function getAuthToken(): Promise<string | null> {
      try {
        const { createClient } = await import('@supabase/supabase-js');
        const sb = createClient(
          (import.meta as any).env.PUBLIC_SUPABASE_URL,
          (import.meta as any).env.PUBLIC_SUPABASE_ANON_KEY
        );
        const { data: { session } } = await sb.auth.getSession();
        return session?.access_token || null;
      } catch { return null; }
    }

    function openModal(id: string) { document.getElementById(id)?.classList.remove('hidden'); }
    function closeModal(id: string) { document.getElementById(id)?.classList.add('hidden'); }

    // === Copiar tracking ===
    document.getElementById('copy-tracking')?.addEventListener('click', function() {
      const tracking = (this as HTMLElement).getAttribute('data-tracking');
      if (tracking) { navigator.clipboard.writeText(tracking); showToast('N√∫mero de seguimiento copiado', 'success'); }
    });

    // === Descargar factura ===
    document.getElementById('download-invoice')?.addEventListener('click', async function() {
      const btn = this as HTMLButtonElement;
      const orderId = btn.dataset.orderId;
      const orderNumber = btn.dataset.orderNumber;
      try {
        const response = await fetch(`/api/orders/${orderId}/invoice`);
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = `Factura-${orderNumber}.pdf`;
          document.body.appendChild(a); a.click();
          window.URL.revokeObjectURL(url); a.remove();
          showToast('Factura descargada', 'success');
        } else { showToast('Error al descargar la factura', 'error'); }
      } catch { showToast('Error al descargar la factura', 'error'); }
    });

    // === CANCELACI√ìN (<2h) ===
    const cancelBtn = document.getElementById('cancel-order');
    cancelBtn?.addEventListener('click', () => openModal('cancel-modal'));
    document.getElementById('cancel-modal-close')?.addEventListener('click', () => closeModal('cancel-modal'));
    document.getElementById('cancel-overlay')?.addEventListener('click', () => closeModal('cancel-modal'));

    document.getElementById('cancel-modal-confirm')?.addEventListener('click', async () => {
      const orderId = cancelBtn?.getAttribute('data-order-id');
      if (!orderId) return;

      const btn = document.getElementById('cancel-modal-confirm') as HTMLButtonElement;
      btn.textContent = 'Procesando reembolso...';
      btn.disabled = true;

      const token = await getAuthToken();
      if (!token) { showToast('Debes iniciar sesi√≥n', 'error'); return; }

      try {
        const res = await fetch('/api/orders/cancel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ orderId })
        });
        const data = await res.json();

        if (data.success) {
          closeModal('cancel-modal');
          showToast(data.message || 'Pedido cancelado y reembolsado', 'success');
          setTimeout(() => window.location.reload(), 2000);
        } else if (data.type === 'requires_return') {
          closeModal('cancel-modal');
          showToast('Han pasado m√°s de 2h. Usa "Solicitar Devoluci√≥n".', 'error');
        } else {
          showToast(data.message || 'Error al cancelar', 'error');
          btn.textContent = 'S√≠, cancelar y reembolsar';
          btn.disabled = false;
        }
      } catch {
        showToast('Error inesperado', 'error');
        btn.textContent = 'S√≠, cancelar y reembolsar';
        btn.disabled = false;
      }
    });

    // === DEVOLUCI√ìN (>2h) ===
    const returnBtn = document.getElementById('request-return');
    const submitBtn = document.getElementById('return-modal-submit') as HTMLButtonElement;
    const otherContainer = document.getElementById('other-reason-container');
    const otherText = document.getElementById('other-reason-text') as HTMLTextAreaElement;
    const charCount = document.getElementById('other-char-count');

    returnBtn?.addEventListener('click', () => openModal('return-modal'));
    document.getElementById('return-modal-close')?.addEventListener('click', () => closeModal('return-modal'));
    document.getElementById('return-modal-cancel')?.addEventListener('click', () => closeModal('return-modal'));
    document.getElementById('return-overlay')?.addEventListener('click', () => closeModal('return-modal'));

    // L√≥gica de radio buttons
    document.querySelectorAll('input[name="return-reason"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const value = (e.target as HTMLInputElement).value;
        const isOther = value === 'other';
        otherContainer?.classList.toggle('hidden', !isOther);

        if (isOther) {
          submitBtn.disabled = (otherText?.value.trim().length || 0) < 10;
        } else {
          submitBtn.disabled = false;
        }
      });
    });

    // Contar caracteres en "otro"
    otherText?.addEventListener('input', () => {
      const len = otherText.value.trim().length;
      if (charCount) charCount.textContent = String(len);
      const selected = (document.querySelector('input[name="return-reason"]:checked') as HTMLInputElement)?.value;
      if (selected === 'other') {
        submitBtn.disabled = len < 10;
      }
    });

    // Enviar solicitud de devoluci√≥n
    submitBtn?.addEventListener('click', async () => {
      const reason = (document.querySelector('input[name="return-reason"]:checked') as HTMLInputElement)?.value;
      if (!reason) { showToast('Selecciona un motivo', 'error'); return; }

      const orderData = document.getElementById('order-data');
      const orderId = orderData?.dataset.orderId;
      if (!orderId) return;

      const description = (document.getElementById('return-description') as HTMLTextAreaElement)?.value || '';
      const fullDescription = reason === 'other' 
        ? `${otherText?.value.trim()}\n\n${description}`.trim()
        : description.trim();

      submitBtn.textContent = 'Enviando solicitud...';
      submitBtn.disabled = true;

      const token = await getAuthToken();
      if (!token) { showToast('Debes iniciar sesi√≥n', 'error'); return; }

      try {
        const res = await fetch('/api/orders/return', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ orderId, reason, description: fullDescription })
        });
        const data = await res.json();

        if (data.success) {
          closeModal('return-modal');

          // Mostrar instrucciones
          const retNum = document.getElementById('instructions-return-number');
          if (retNum) retNum.textContent = `N¬∫ Devoluci√≥n: ${data.returnNumber}`;

          const deadline = document.getElementById('instructions-deadline');
          if (deadline && data.deadline) {
            deadline.textContent = new Date(data.deadline).toLocaleDateString('es-ES', {
              weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
          }

          openModal('instructions-modal');
        } else {
          showToast(data.message || 'Error al solicitar la devoluci√≥n', 'error');
          submitBtn.textContent = 'Solicitar Devoluci√≥n';
          submitBtn.disabled = false;
        }
      } catch {
        showToast('Error inesperado', 'error');
        submitBtn.textContent = 'Solicitar Devoluci√≥n';
        submitBtn.disabled = false;
      }
    });

    // Cerrar modal de instrucciones ‚Üí recargar
    document.getElementById('instructions-close')?.addEventListener('click', () => {
      closeModal('instructions-modal');
      window.location.reload();
    });
    document.getElementById('instructions-overlay')?.addEventListener('click', () => {
      closeModal('instructions-modal');
      window.location.reload();
    });
  </script>
</PublicLayout>
