---
import PublicLayout from '../../layouts/PublicLayout.astro';
import { createServerSupabaseClient } from '../../lib/auth';

// Proteger la ruta - requiere autenticación
const supabase = createServerSupabaseClient(Astro);
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/auth/login?redirect=/perfil/mis-pedidos');
}

// Obtener pedidos del usuario
const { data: orders, error } = await supabase
  .from('orders')
  .select(`
    *,
    order_items (
      *
    )
  `)
  .eq('user_id', session.user.id)
  .order('created_at', { ascending: false });

if (error) {
  console.error('Error fetching orders:', error);
}

// Función para formatear fecha
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Función para obtener el color del badge según el estado
const getStatusBadge = (status: string) => {
  const badges: Record<string, { color: string; text: string }> = {
    pending: { color: 'bg-yellow-100 text-yellow-800', text: 'Pendiente' },
    confirmed: { color: 'bg-blue-100 text-blue-800', text: 'Confirmado' },
    processing: { color: 'bg-purple-100 text-purple-800', text: 'Procesando' },
    shipped: { color: 'bg-indigo-100 text-indigo-800', text: 'Enviado' },
    delivered: { color: 'bg-green-100 text-green-800', text: 'Entregado' },
    cancelled: { color: 'bg-red-100 text-red-800', text: 'Cancelado' },
    refunded: { color: 'bg-gray-100 text-gray-800', text: 'Reembolsado' }
  };
  return badges[status] || badges.pending;
};
---

<PublicLayout title="Mis Pedidos">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Mis Pedidos</h1>
      <p class="mt-2 text-gray-600">Revisa el estado de tus pedidos y descarga tus facturas</p>
    </div>

    {orders && orders.length > 0 ? (
      <div class="space-y-6">
        {orders.map((order) => {
          const statusBadge = getStatusBadge(order.status);
          return (
            <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-200 hover:shadow-lg transition-shadow">
              {/* Header del pedido */}
              <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                  <div>
                    <h3 class="text-lg font-semibold text-gray-900">
                      Pedido #{order.order_number}
                    </h3>
                    <p class="text-sm text-gray-500 mt-1">
                      Realizado el {formatDate(order.created_at)}
                    </p>
                  </div>
                  <div class="flex items-center gap-3">
                    <span class={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusBadge.color}`}>
                      {statusBadge.text}
                    </span>
                    <span class="text-lg font-bold text-gray-900">
                      {order.total.toFixed(2)}€
                    </span>
                  </div>
                </div>
              </div>

              {/* Detalles del pedido */}
              <div class="px-6 py-4">
                {/* Productos */}
                <div class="space-y-3 mb-4">
                  {order.order_items?.map((item: any) => (
                    <div class="flex items-center gap-4">
                      {item.product_image ? (
                        <img 
                          src={item.product_image} 
                          alt={item.product_name}
                          class="w-16 h-16 object-cover rounded-md"
                        />
                      ) : (
                        <div class="w-16 h-16 bg-gray-200 rounded-md flex items-center justify-center">
                          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                          </svg>
                        </div>
                      )}
                      <div class="flex-1">
                        <h4 class="text-sm font-medium text-gray-900">{item.product_name}</h4>
                        <p class="text-sm text-gray-500">
                          Cantidad: {item.quantity} × {item.price.toFixed(2)}€
                        </p>
                      </div>
                      <div class="text-sm font-medium text-gray-900">
                        {item.subtotal.toFixed(2)}€
                      </div>
                    </div>
                  ))}
                </div>

                {/* Dirección de envío */}
                <div class="border-t border-gray-200 pt-4 mt-4">
                  <h4 class="text-sm font-semibold text-gray-900 mb-2">Dirección de envío</h4>
                  <p class="text-sm text-gray-600">
                    {order.shipping_full_name}<br />
                    {order.shipping_address_line1}<br />
                    {order.shipping_address_line2 && <>{order.shipping_address_line2}<br /></>}
                    {order.shipping_city}, {order.shipping_state} {order.shipping_postal_code}<br />
                    {order.shipping_country}
                  </p>
                </div>

                {/* Resumen de precios */}
                <div class="border-t border-gray-200 pt-4 mt-4">
                  <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600">Subtotal:</span>
                      <span class="text-gray-900">{order.subtotal.toFixed(2)}€</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600">Envío:</span>
                      <span class="text-gray-900">{order.shipping_cost.toFixed(2)}€</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600">IVA (21%):</span>
                      <span class="text-gray-900">{order.tax.toFixed(2)}€</span>
                    </div>
                    <div class="flex justify-between text-base font-semibold border-t border-gray-200 pt-2">
                      <span class="text-gray-900">Total:</span>
                      <span class="text-gray-900">{order.total.toFixed(2)}€</span>
                    </div>
                  </div>
                </div>

                {/* Tracking info si existe */}
                {order.tracking_number && (
                  <div class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="text-sm font-semibold text-gray-900 mb-2">Seguimiento</h4>
                    <p class="text-sm text-gray-600">
                      Número de seguimiento: <span class="font-mono font-semibold">{order.tracking_number}</span>
                    </p>
                  </div>
                )}

                {/* Botones de acción */}
                <div class="border-t border-gray-200 pt-4 mt-4 flex flex-wrap gap-3">
                  <a 
                    href={`/perfil/mis-pedidos/${order.id}`}
                    class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                  >
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    Ver detalles
                  </a>
                  
                  <button 
                    data-order-id={order.id}
                    data-order-number={order.order_number}
                    class="download-invoice inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                  >
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                    </svg>
                    Descargar factura
                  </button>

                  {order.status === 'confirmed' || order.status === 'processing' ? (
                    <button 
                      data-order-id={order.id}
                      class="cancel-order inline-flex items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                    >
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                      </svg>
                      Cancelar pedido
                    </button>
                  ) : null}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    ) : (
      <div class="bg-white shadow-md rounded-lg p-12 text-center">
        <svg class="mx-auto h-24 w-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
        </svg>
        <h3 class="mt-4 text-lg font-medium text-gray-900">No tienes pedidos aún</h3>
        <p class="mt-2 text-sm text-gray-500">Cuando realices una compra, aparecerá aquí.</p>
        <div class="mt-6">
          <a 
            href="/productos" 
            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700"
          >
            Ir a comprar
          </a>
        </div>
      </div>
    )}
  </div>

  <script>
    // Manejar descarga de facturas
    document.querySelectorAll('.download-invoice').forEach(button => {
      button.addEventListener('click', async (e) => {
        const btn = e.currentTarget as HTMLButtonElement;
        const orderId = btn.dataset.orderId;
        const orderNumber = btn.dataset.orderNumber;
        
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Descargando...';

        try {
          const response = await fetch(`/api/orders/${orderId}/invoice`);
          if (!response.ok) throw new Error('Error al descargar la factura');
          
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Factura-${orderNumber}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          btn.disabled = false;
          btn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path></svg> Descargar factura';
        } catch (error) {
          console.error('Error:', error);
          alert('Error al descargar la factura. Por favor, intenta de nuevo.');
          btn.disabled = false;
          btn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path></svg> Descargar factura';
        }
      });
    });

    // Manejar cancelación de pedidos
    document.querySelectorAll('.cancel-order').forEach(button => {
      button.addEventListener('click', async (e) => {
        const btn = e.currentTarget as HTMLButtonElement;
        const orderId = btn.dataset.orderId;
        
        if (!confirm('¿Estás seguro de que quieres cancelar este pedido?')) {
          return;
        }

        btn.disabled = true;
        btn.textContent = 'Cancelando...';

        try {
          const response = await fetch(`/api/orders/${orderId}/cancel`, {
            method: 'POST'
          });
          
          if (!response.ok) throw new Error('Error al cancelar el pedido');
          
          alert('Pedido cancelado correctamente');
          window.location.reload();
        } catch (error) {
          console.error('Error:', error);
          alert('Error al cancelar el pedido. Por favor, contacta con soporte.');
          btn.disabled = false;
          btn.textContent = 'Cancelar pedido';
        }
      });
    });
  </script>
</BaseLayout>
