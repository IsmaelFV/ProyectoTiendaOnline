---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

// Protecci√≥n: solo admins
const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) {
  return Astro.redirect('/admin/login');
}

// Verificar si es admin
const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) {
  return Astro.redirect('/admin/login');
}

const { data: adminUser } = await supabase
  .from('admin_users')
  .select('*')
  .eq('user_id', user.id);

if (!adminUser || adminUser.length === 0) {
  return Astro.redirect('/admin/login');
}

// Obtener categor√≠as para el select
const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .order('name');

// Obtener mensaje de error si existe
const url = new URL(Astro.request.url);
const errorParam = url.searchParams.get('error');

const errorMessages: { [key: string]: string } = {
  missing_fields: 'Por favor completa todos los campos requeridos',
  invalid_name: 'El nombre debe tener entre 3 y 200 caracteres',
  invalid_price: 'El precio debe ser un n√∫mero v√°lido mayor o igual a 0',
  price_too_high: 'El precio no puede superar ‚Ç¨1,000,000',
  invalid_stock: 'El stock debe ser un n√∫mero entre 0 y 999,999',
  no_sizes: 'Debes especificar al menos una talla',
  no_images: 'Debes agregar al menos una imagen',
  slug_exists: 'Ya existe un producto con ese nombre',
  sku_exists: 'Ya existe un producto con ese SKU',
  create_failed: 'Error al crear el producto. Int√©ntalo de nuevo',
};

const errorMessage = errorParam ? errorMessages[errorParam] : null;
---

<AdminLayout title="Nuevo Producto - Admin">
  <div class="max-w-4xl mx-auto space-y-6">
    {/* Header */}
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Nuevo Producto</h1>
        <p class="mt-1 text-sm text-gray-600">Agrega un nuevo producto al cat√°logo</p>
      </div>
      <a
        href="/admin/productos"
        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
      >
        Volver
      </a>
    </div>

    {/* Error message */}
    {errorMessage && (
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
          <span class="text-red-800 font-medium">{errorMessage}</span>
        </div>
      </div>
    )}

    {/* Formulario */}
    <form method="POST" action="/api/products/create" class="bg-white rounded-lg shadow-md">
      <div class="p-6 space-y-6">
        {/* Informaci√≥n B√°sica */}
        <div>
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Informaci√≥n B√°sica</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Nombre */}
            <div class="md:col-span-2">
              <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                Nombre del producto <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="name"
                id="name"
                required
                placeholder="Ej: Camiseta b√°sica de algod√≥n"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-gold focus:border-transparent"
              />
              <p class="mt-1 text-xs text-gray-500">Entre 3 y 200 caracteres</p>
            </div>

            {/* SKU */}
            <div>
              <label for="sku" class="block text-sm font-medium text-gray-700 mb-2">
                SKU (C√≥digo √∫nico)
              </label>
              <input
                type="text"
                name="sku"
                id="sku"
                placeholder="Ej: CAM-BAS-001"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-gold focus:border-transparent"
              />
              <p class="mt-1 text-xs text-gray-500">Opcional, se genera autom√°ticamente si se deja vac√≠o</p>
            </div>

            {/* Categor√≠a */}
            <div>
              <label for="category_id" class="block text-sm font-medium text-gray-700 mb-2">
                Categor√≠a <span class="text-red-500">*</span>
              </label>
              <select
                name="category_id"
                id="category_id"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-gold focus:border-transparent"
              >
                <option value="">Selecciona una categor√≠a</option>
                {categories && categories.map((cat) => (
                  <option value={cat.id}>{cat.name}</option>
                ))}
              </select>
            </div>
          </div>
        </div>

        {/* Descripci√≥n */}
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
            Descripci√≥n
          </label>
          <textarea
            name="description"
            id="description"
            rows="4"
            placeholder="Describe el producto, materiales, caracter√≠sticas..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-gold focus:border-transparent"
          ></textarea>
        </div>

        {/* Precio y Stock */}
        <div>
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Precio y Stock</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Precio */}
            <div>
              <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
                Precio (‚Ç¨) <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-gray-500">‚Ç¨</span>
                <input
                  type="number"
                  name="price"
                  id="price"
                  required
                  min="0"
                  step="0.01"
                  placeholder="19.99"
                  class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-gold focus:border-transparent"
                />
              </div>
              <p class="mt-1 text-xs text-gray-500">Precio en euros (con decimales)</p>
            </div>

            {/* Stock */}
            <div>
              <label for="stock" class="block text-sm font-medium text-gray-700 mb-2">
                Stock disponible <span class="text-red-500">*</span>
              </label>
              <input
                type="number"
                name="stock"
                id="stock"
                required
                min="0"
                max="999999"
                placeholder="100"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-gold focus:border-transparent"
              />
              <p class="mt-1 text-xs text-gray-500">Unidades disponibles para venta</p>
            </div>
          </div>
        </div>

        {/* Tallas */}
        <div>
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Tallas</h2>
          <label for="sizes" class="block text-sm font-medium text-gray-700 mb-2">
            Tallas disponibles <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="sizes"
            id="sizes"
            required
            placeholder="XS, S, M, L, XL, XXL"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-gold focus:border-transparent"
          />
          <p class="mt-1 text-xs text-gray-500">Separadas por comas. Se convertir√°n autom√°ticamente a may√∫sculas</p>
        </div>

        {/* Im√°genes */}
        <div>
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Im√°genes</h2>
          <label for="images" class="block text-sm font-medium text-gray-700 mb-2">
            URLs de im√°genes <span class="text-red-500">*</span>
          </label>
          <textarea
            name="images"
            id="images"
            required
            rows="6"
            placeholder="https://images.unsplash.com/photo-1...&#10;https://images.unsplash.com/photo-2...&#10;https://images.unsplash.com/photo-3..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-gold focus:border-transparent font-mono text-sm"
          ></textarea>
          <p class="mt-1 text-xs text-gray-500">Una URL por l√≠nea. La primera imagen ser√° la principal.</p>
          <p class="mt-1 text-xs text-amber-600">‚ö†Ô∏è Solo se permiten URLs de Unsplash o tu almacenamiento de Supabase</p>
        </div>

        {/* Destacado */}
        <div>
          <label class="flex items-center space-x-3 cursor-pointer">
            <input
              type="checkbox"
              name="featured"
              id="featured"
              class="w-4 h-4 text-brand-gold border-gray-300 rounded focus:ring-brand-gold"
            />
            <div>
              <span class="text-sm font-medium text-gray-700">Producto destacado</span>
              <p class="text-xs text-gray-500">Se mostrar√° en la p√°gina principal</p>
            </div>
          </label>
        </div>
      </div>

      {/* Footer con botones */}
      <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between rounded-b-lg">
        <a
          href="/admin/productos"
          class="px-4 py-2 text-gray-700 hover:text-gray-900 transition-colors"
        >
          Cancelar
        </a>
        <button
          type="submit"
          class="px-6 py-2 bg-brand-gold text-white rounded-lg hover:bg-yellow-600 transition-colors font-medium"
        >
          Crear Producto
        </button>
      </div>
    </form>

    {/* Ayuda */}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h3 class="text-sm font-semibold text-blue-900 mb-2">üí° Consejos</h3>
      <ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
        <li>Usa nombres descriptivos pero concisos para los productos</li>
        <li>El SKU debe ser √∫nico para cada producto</li>
        <li>Aseg√∫rate de que las im√°genes sean de alta calidad y carguen r√°pido</li>
        <li>El stock se actualizar√° autom√°ticamente con cada venta</li>
        <li>Puedes editar el producto despu√©s de crearlo</li>
      </ul>
    </div>
  </div>
</AdminLayout>
