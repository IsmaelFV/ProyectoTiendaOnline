---
import AdminLayout from '@layouts/AdminLayout.astro';
import { verifyAdminFromCookies, createServerSupabaseClient } from '@lib/auth';

// Protecci√≥n: solo admins
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

const userId = await verifyAdminFromCookies(accessToken, refreshToken);
if (!userId) {
  return Astro.redirect('/auth/login');
}

// Usar service_role para consultas de admin
const supabase = createServerSupabaseClient();

// Obtener categor√≠as con su g√©nero asociado
const { data: categories } = await supabase
  .from('categories')
  .select('*, gender:genders(id, name)')
  .order('name');

// Obtener g√©neros para agrupar las categor√≠as
const { data: genders } = await supabase
  .from('genders')
  .select('*')
  .order('name');

// Agrupar categor√≠as por g√©nero para el select
const categoriesByGender: Record<string, { genderName: string; items: typeof categories }> = {};
if (categories && genders) {
  for (const g of genders) {
    categoriesByGender[g.id] = {
      genderName: g.name,
      items: categories.filter((c: any) => c.gender_id === g.id),
    };
  }
  // Categor√≠as sin g√©nero
  const sinGenero = categories.filter((c: any) => !c.gender_id);
  if (sinGenero.length > 0) {
    categoriesByGender['sin-genero'] = { genderName: 'General', items: sinGenero };
  }
}

// Obtener mensaje de error si existe
const url = new URL(Astro.request.url);
const errorParam = url.searchParams.get('error');

const errorMessages: { [key: string]: string } = {
  missing_fields: 'Por favor completa todos los campos requeridos',
  invalid_name: 'El nombre debe tener entre 3 y 200 caracteres',
  invalid_price: 'El precio debe ser un n√∫mero v√°lido mayor o igual a 0',
  price_too_high: 'El precio no puede superar ‚Ç¨1,000,000',
  invalid_stock: 'El stock debe ser un n√∫mero entre 0 y 999,999',
  no_sizes: 'Debes especificar al menos una talla',
  no_images: 'Debes agregar al menos una imagen',
  slug_exists: 'Ya existe un producto con ese nombre',
  sku_exists: 'Ya existe un producto con ese SKU',
  create_failed: 'Error al crear el producto. Int√©ntalo de nuevo',
};

const errorMessage = errorParam ? errorMessages[errorParam] : null;
---

<AdminLayout title="Nuevo Producto - Admin">
  <div class="max-w-4xl mx-auto space-y-6">
    {/* Header */}
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-white">Nuevo Producto</h1>
        <p class="mt-1 text-sm text-gray-400">Agrega un nuevo producto al cat√°logo</p>
      </div>
      <a
        href="/admin/productos"
        class="px-4 py-2 bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition-colors"
      >
        Volver
      </a>
    </div>

    {/* Error message */}
    {errorMessage && (
      <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
          <span class="text-red-400 font-medium">{errorMessage}</span>
        </div>
      </div>
    )}

    {/* Formulario */}
    <form method="POST" action="/api/products/create" class="bg-dark-surface rounded-xl border border-white/10">
      <div class="p-6 space-y-6">
        {/* Informaci√≥n B√°sica */}
        <div>
          <h2 class="text-lg font-semibold text-white mb-4">Informaci√≥n B√°sica</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Nombre */}
            <div class="md:col-span-2">
              <label for="name" class="block text-sm font-medium text-gray-400 mb-2">
                Nombre del producto <span class="text-red-400">*</span>
              </label>
              <input
                type="text"
                name="name"
                id="name"
                required
                placeholder="Ej: Camiseta b√°sica de algod√≥n"
                class="w-full px-4 py-2 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent"
              />
              <p class="mt-1 text-xs text-gray-500">Entre 3 y 200 caracteres</p>
            </div>

            {/* SKU */}
            <div>
              <label for="sku" class="block text-sm font-medium text-gray-400 mb-2">
                SKU (C√≥digo √∫nico)
              </label>
              <input
                type="text"
                name="sku"
                id="sku"
                placeholder="Ej: CAM-BAS-001"
                class="w-full px-4 py-2 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent"
              />
              <p class="mt-1 text-xs text-gray-500">Opcional, se genera autom√°ticamente si se deja vac√≠o</p>
            </div>

            {/* Categor√≠a */}
            <div>
              <label for="category_id" class="block text-sm font-medium text-gray-400 mb-2">
                Categor√≠a <span class="text-red-400">*</span>
              </label>
              <select
                name="category_id"
                id="category_id"
                required
                class="w-full px-4 py-2 bg-dark-card border border-white/10 rounded-lg text-white focus:ring-2 focus:ring-accent-gold focus:border-transparent"
              >
                <option value="">Selecciona una categor√≠a</option>
                {Object.entries(categoriesByGender).map(([genderId, group]: [string, any]) => (
                  group.items && group.items.length > 0 && (
                    <optgroup label={`‚îÄ‚îÄ ${group.genderName} ‚îÄ‚îÄ`}>
                      {group.items.map((cat: any) => (
                        <option value={cat.id}>{cat.name}</option>
                      ))}
                    </optgroup>
                  )
                ))}
              </select>
            </div>
          </div>
        </div>

        {/* Descripci√≥n */}
        <div>
          <label for="description" class="block text-sm font-medium text-gray-400 mb-2">
            Descripci√≥n
          </label>
          <textarea
            name="description"
            id="description"
            rows="4"
            placeholder="Describe el producto, materiales, caracter√≠sticas..."
            class="w-full px-4 py-2 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent"
          ></textarea>
        </div>

        {/* Precio y Stock */}
        <div>
          <h2 class="text-lg font-semibold text-white mb-4">Precio y Stock</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Precio */}
            <div>
              <label for="price" class="block text-sm font-medium text-gray-400 mb-2">
                Precio (‚Ç¨) <span class="text-red-400">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-gray-500">‚Ç¨</span>
                <input
                  type="number"
                  name="price"
                  id="price"
                  required
                  min="0"
                  step="0.01"
                  placeholder="19.99"
                  class="w-full pl-8 pr-4 py-2 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent"
                />
              </div>
              <p class="mt-1 text-xs text-gray-500">Precio en euros (con decimales)</p>
            </div>

            {/* Stock total (solo lectura, calculado) */}
            <div>
              <label for="stock" class="block text-sm font-medium text-gray-400 mb-2">
                Stock total <span class="text-gray-600">(suma autom√°tica)</span>
              </label>
              <div class="relative">
                <input
                  type="number"
                  name="stock"
                  id="stock"
                  readonly
                  min="0"
                  value="0"
                  class="w-full px-4 py-2 bg-dark-card/50 border border-white/5 rounded-lg text-gray-400 cursor-not-allowed"
                />
                <span id="stock-total-badge" class="absolute right-3 top-2 text-xs font-bold px-2 py-0.5 rounded-full bg-accent-gold/20 text-accent-gold">
                  0 uds
                </span>
              </div>
              <p class="mt-1 text-xs text-gray-500">Se calcula sumando el stock de cada talla</p>
            </div>
          </div>

          {/* Stock por talla */}
          <div id="stock-by-size-section" class="mt-4 hidden">
            <div class="flex items-center justify-between mb-3">
              <label class="block text-sm font-medium text-gray-400">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                  </svg>
                  Stock por talla
                </span>
              </label>
            </div>
            <div id="stock-by-size-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
              {/* Se rellena din√°micamente con JS al seleccionar tallas */}
            </div>
            <div id="stock-by-size-summary" class="mt-3 flex items-center gap-4 text-xs">
              <span class="text-gray-500">Cada talla tiene su stock independiente</span>
            </div>
          </div>

          {/* Campo oculto para stock_by_size JSON */}
          <input type="hidden" name="stock_by_size" id="stock-by-size-hidden" />
        </div>

        {/* Tallas */}
        <div>
          <h2 class="text-lg font-semibold text-white mb-4">Tallas</h2>
          <label class="block text-sm font-medium text-gray-400 mb-3">
            Tallas disponibles <span class="text-red-400">*</span>
          </label>

          {/* Selector r√°pido de tipo de tallaje */}
          <div class="flex flex-wrap gap-2 mb-4">
            <button type="button" data-preset="letras" class="size-preset-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 hover:text-accent-gold transition-all bg-white/5">Ropa (XS‚ÄìXXL)</button>
            <button type="button" data-preset="pantalon" class="size-preset-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 hover:text-accent-gold transition-all bg-white/5">Pantal√≥n (34‚Äì46)</button>
            <button type="button" data-preset="zapatos" class="size-preset-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 hover:text-accent-gold transition-all bg-white/5">Calzado (36‚Äì45)</button>
            <button type="button" data-preset="unica" class="size-preset-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 hover:text-accent-gold transition-all bg-white/5">Talla √∫nica</button>
          </div>

          {/* Grid de checkboxes de tallas */}
          <div id="sizes-grid" class="flex flex-wrap gap-2 mb-3">
            {/* Se rellenan din√°micamente con JS */}
          </div>

          {/* A√±adir talla personalizada */}
          <div class="flex gap-2 mb-3">
            <input type="text" id="custom-size-input" placeholder="Ej: 3XL, 28, XXXS‚Ä¶" class="flex-1 px-3 py-2 text-sm bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold/50 focus:border-transparent" />
            <button type="button" id="add-custom-size" class="px-4 py-2 text-sm bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition-colors">+ A√±adir</button>
          </div>

          {/* Campo oculto que env√≠a el valor real */}
          <input type="hidden" name="sizes" id="sizes-hidden" required />

          {/* Resumen de selecci√≥n */}
          <div id="sizes-summary" class="text-xs text-gray-500">Selecciona al menos una talla</div>

          {/* Editor de medidas por talla */}
          <div id="measurements-section" class="mt-6 hidden">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-gray-300 flex items-center gap-2">
                <svg class="w-4 h-4 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                </svg>
                Medidas por talla (cm)
              </h3>
              <button type="button" id="fill-default-measurements" class="text-xs text-accent-gold hover:text-accent-gold/80 transition-colors underline">
                Rellenar con valores est√°ndar
              </button>
            </div>
            <p class="text-xs text-gray-500 mb-3">Selecciona qu√© medidas quieres definir y establece el rango (m√≠n‚Äìm√°x) para cada talla.</p>
            
            {/* Selector de medidas a incluir */}
            <div class="flex flex-wrap gap-2 mb-4" id="measure-type-selector">
              <button type="button" data-measure-type="chest" class="measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-accent-gold text-accent-gold bg-accent-gold/10 transition-all">Pecho</button>
              <button type="button" data-measure-type="waist" class="measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-accent-gold text-accent-gold bg-accent-gold/10 transition-all">Cintura</button>
              <button type="button" data-measure-type="hip" class="measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-accent-gold text-accent-gold bg-accent-gold/10 transition-all">Cadera</button>
              <button type="button" data-measure-type="length" class="measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 bg-white/5 transition-all">Largo total</button>
              <button type="button" data-measure-type="sleeve" class="measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 bg-white/5 transition-all">Manga</button>
              <button type="button" data-measure-type="shoulder" class="measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 bg-white/5 transition-all">Hombro</button>
              <button type="button" data-measure-type="inseam" class="measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 bg-white/5 transition-all">Entrepierna</button>
              <button type="button" data-measure-type="foot" class="measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 bg-white/5 transition-all">Pie (cm)</button>
            </div>

            <div id="measurements-editor" class="space-y-3">
              {/* Se rellena din√°micamente con JS */}
            </div>
          </div>

          {/* Campo oculto para medidas */}
          <input type="hidden" name="size_measurements" id="measurements-hidden" />
        </div>

        {/* Im√°genes */}
        <div>
          <h2 class="text-lg font-semibold text-white mb-4">Im√°genes</h2>
          <label class="block text-sm font-medium text-gray-400 mb-3">
            Im√°genes del producto <span class="text-red-400">*</span>
          </label>

          {/* Zona de drop / selecci√≥n de archivos */}
          <div
            id="drop-zone"
            class="border-2 border-dashed border-white/10 rounded-xl p-6 text-center transition-all hover:border-accent-gold/30 cursor-pointer"
          >
            <input type="file" id="file-input" multiple accept="image/jpeg,image/jpg,image/png,image/webp,image/gif,image/avif,image/svg+xml" class="hidden" />
            <div class="pointer-events-none">
              <svg class="mx-auto h-10 w-10 text-gray-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
              </svg>
              <p class="text-sm text-gray-400">Arrastra im√°genes aqu√≠ o <span class="text-accent-gold underline">selecciona archivos</span></p>
              <p class="mt-1 text-xs text-gray-600">JPG, PNG, WebP, GIF, AVIF, SVG ¬∑ M√°x. 10MB por imagen</p>
            </div>
          </div>

          {/* Barra de progreso de upload */}
          <div id="upload-progress" class="hidden mt-3">
            <div class="flex items-center gap-3">
              <div class="flex-1 h-1.5 bg-white/5 rounded-full overflow-hidden">
                <div id="upload-bar" class="h-full bg-accent-gold rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <span id="upload-text" class="text-xs text-gray-400">Subiendo...</span>
            </div>
          </div>

          {/* A√±adir URL manual */}
          <div class="mt-3 flex gap-2">
            <input
              type="url"
              id="url-input"
              placeholder="O pega una URL de imagen: https://..."
              class="flex-1 px-3 py-2 text-sm bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold/50 focus:border-transparent"
            />
            <button type="button" id="add-url-btn" class="px-4 py-2 text-sm bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition-colors whitespace-nowrap">
              + URL
            </button>
          </div>

          {/* Grid de previews */}
          <div id="images-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mt-4">
            {/* Se rellena din√°micamente */}
          </div>

          {/* Resumen y campo oculto */}
          <div id="images-summary" class="text-xs text-gray-500 mt-2">A√±ade al menos una imagen</div>
          <input type="hidden" name="images" id="images-hidden" required />

          {/* Error */}
          <div id="images-error" class="hidden mt-2 text-xs text-red-400 items-center gap-1">
            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
            <span id="images-error-text"></span>
          </div>
        </div>

        {/* Oferta / Descuento */}
        <div>
          <h2 class="text-lg font-semibold text-white mb-4">Oferta / Descuento</h2>
          <div class="space-y-4">
            <label class="flex items-center space-x-3 cursor-pointer">
              <input
                type="checkbox"
                name="is_on_sale"
                id="is_on_sale"
                class="w-4 h-4 text-accent-gold border-white/20 bg-dark-card rounded focus:ring-accent-gold"
              />
              <div>
                <span class="text-sm font-medium text-gray-300">Este producto tiene oferta</span>
                <p class="text-xs text-gray-500">Activa para mostrar precio con descuento</p>
              </div>
            </label>

            <div id="sale-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-dark-card/50 rounded-lg border border-white/5">
              <div>
                <label for="discount_percentage" class="block text-sm font-medium text-gray-400 mb-2">
                  Porcentaje de descuento (%)
                </label>
                <div class="relative">
                  <input
                    type="number"
                    name="discount_percentage"
                    id="discount_percentage"
                    min="1"
                    max="99"
                    step="1"
                    placeholder="20"
                    class="w-full px-4 py-2 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent"
                  />
                  <span class="absolute right-3 top-2 text-gray-500">%</span>
                </div>
                <p class="mt-1 text-xs text-gray-500">Entre 1% y 99%</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">
                  Precio con descuento (vista previa)
                </label>
                <div class="flex items-center h-[42px] px-4 bg-dark-card border border-white/10 rounded-lg">
                  <span id="sale-price-preview" class="text-accent-gold font-semibold">‚Äî</span>
                </div>
                <p class="mt-1 text-xs text-gray-500">Se calcula autom√°ticamente seg√∫n el precio base</p>
              </div>
            </div>
          </div>
        </div>

        {/* Destacado */}
        <div>
          <label class="flex items-center space-x-3 cursor-pointer">
            <input
              type="checkbox"
              name="featured"
              id="featured"
              class="w-4 h-4 text-accent-gold border-white/20 bg-dark-card rounded focus:ring-accent-gold"
            />
            <div>
              <span class="text-sm font-medium text-gray-300">Producto destacado</span>
              <p class="text-xs text-gray-500">Se mostrar√° en la p√°gina principal</p>
            </div>
          </label>
        </div>
      </div>

      {/* Footer con botones */}
      <div class="px-6 py-4 bg-dark-card/50 border-t border-white/10 flex items-center justify-between rounded-b-xl">
        <a
          href="/admin/productos"
          class="px-4 py-2 text-gray-400 hover:text-white transition-colors"
        >
          Cancelar
        </a>
        <button
          type="submit"
          class="px-6 py-2 bg-accent-gold text-dark-bg rounded-lg hover:bg-accent-gold/90 transition-colors font-medium"
        >
          Crear Producto
        </button>
      </div>
    </form>

    {/* Ayuda */}
    <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4">
      <h3 class="text-sm font-semibold text-blue-400 mb-2">üí° Consejos</h3>
      <ul class="text-sm text-blue-300/80 space-y-1 list-disc list-inside">
        <li>Usa nombres descriptivos pero concisos para los productos</li>
        <li>El SKU debe ser √∫nico para cada producto</li>
        <li>Aseg√∫rate de que las im√°genes sean de alta calidad y carguen r√°pido</li>
        <li>El stock se actualizar√° autom√°ticamente con cada venta</li>
        <li>Puedes editar el producto despu√©s de crearlo</li>
      </ul>
    </div>
  </div>
</AdminLayout>

<script>
  const saleCheckbox = document.getElementById('is_on_sale') as HTMLInputElement;
  const saleFields = document.getElementById('sale-fields');
  const discountInput = document.getElementById('discount_percentage') as HTMLInputElement;
  const priceInput = document.getElementById('price') as HTMLInputElement;
  const preview = document.getElementById('sale-price-preview');

  function toggleSaleFields() {
    if (saleCheckbox.checked) {
      saleFields?.classList.remove('hidden');
      saleFields?.classList.add('grid');
    } else {
      saleFields?.classList.add('hidden');
      saleFields?.classList.remove('grid');
      if (discountInput) discountInput.value = '';
      if (preview) preview.textContent = '‚Äî';
    }
  }

  function updatePreview() {
    const price = parseFloat(priceInput?.value || '0');
    const discount = parseInt(discountInput?.value || '0');
    if (price > 0 && discount > 0 && discount < 100) {
      const salePrice = price * (1 - discount / 100);
      if (preview) preview.textContent = `‚Ç¨${salePrice.toFixed(2)} (antes ‚Ç¨${price.toFixed(2)})`;
    } else {
      if (preview) preview.textContent = '‚Äî';
    }
  }

  saleCheckbox?.addEventListener('change', toggleSaleFields);
  discountInput?.addEventListener('input', updatePreview);
  priceInput?.addEventListener('input', updatePreview);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SELECTOR DE TALLAS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const SIZE_PRESETS = {
    letras:   ['XS', 'S', 'M', 'L', 'XL', 'XXL'],
    pantalon: ['34', '36', '38', '40', '42', '44', '46'],
    zapatos:  ['36', '37', '38', '39', '40', '41', '42', '43', '44', '45'],
    unica:    ['√önica'],
  };

  let selectedSizes = new Set<string>();
  let currentPreset = '';
  const sizesGrid = document.getElementById('sizes-grid') as HTMLDivElement;
  const sizesHidden = document.getElementById('sizes-hidden') as HTMLInputElement;
  const sizesSummary = document.getElementById('sizes-summary') as HTMLDivElement;
  const customInput = document.getElementById('custom-size-input') as HTMLInputElement | null;
  const addCustomBtn = document.getElementById('add-custom-size');
  const stockBySizeSection = document.getElementById('stock-by-size-section') as HTMLDivElement;
  const stockBySizeGrid = document.getElementById('stock-by-size-grid') as HTMLDivElement;
  const stockBySizeHidden = document.getElementById('stock-by-size-hidden') as HTMLInputElement;
  const stockTotalInput = document.getElementById('stock') as HTMLInputElement;

  // Objeto para almacenar stock por talla
  let stockBySize: Record<string, number> = {};

  function renderSizeButtons(preset: string) {
    const sizes = SIZE_PRESETS[preset as keyof typeof SIZE_PRESETS] || [];
    sizesGrid.innerHTML = '';
    sizes.forEach((size: string) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = size;
      btn.dataset.size = size;
      const isActive = selectedSizes.has(size);
      btn.className = `size-toggle-btn px-4 py-2 text-sm rounded-lg border-2 font-medium transition-all cursor-pointer ${
        isActive
          ? 'border-accent-gold bg-accent-gold/20 text-white'
          : 'border-white/10 text-gray-400 hover:border-white/30 bg-white/[0.02]'
      }`;
      btn.addEventListener('click', () => toggleSize(size));
      sizesGrid.appendChild(btn);
    });
  }

  function toggleSize(size: string) {
    if (selectedSizes.has(size)) {
      selectedSizes.delete(size);
    } else {
      selectedSizes.add(size);
    }
    updateSizesUI();
  }

  function updateSizesUI() {
    const arr = Array.from(selectedSizes);
    sizesHidden.value = arr.join(',');
    // Actualizar botones del grid
    sizesGrid.querySelectorAll<HTMLButtonElement>('.size-toggle-btn').forEach((btn) => {
      const s = btn.dataset.size;
      if (selectedSizes.has(s || '')) {
        btn.className = 'size-toggle-btn px-4 py-2 text-sm rounded-lg border-2 font-medium transition-all cursor-pointer border-accent-gold bg-accent-gold/20 text-white';
      } else {
        btn.className = 'size-toggle-btn px-4 py-2 text-sm rounded-lg border-2 font-medium transition-all cursor-pointer border-white/10 text-gray-400 hover:border-white/30 bg-white/[0.02]';
      }
    });
    // Resumen
    if (arr.length > 0) {
      sizesSummary.innerHTML = `<span class="text-accent-gold font-medium">${arr.length} talla${arr.length > 1 ? 's' : ''}</span> seleccionada${arr.length > 1 ? 's' : ''}: <span class="text-gray-300">${arr.join(', ')}</span>`;
    } else {
      sizesSummary.textContent = 'Selecciona al menos una talla';
    }

    // ‚≠ê Actualizar secci√≥n de stock por talla
    updateStockBySizeUI();
  }

  const stockTotalBadge = document.getElementById('stock-total-badge');
  const stockSummaryEl = document.getElementById('stock-by-size-summary');

  function getStockColor(stock: number) {
    if (stock === 0) return { border: 'border-red-500/40', bg: 'bg-red-500/5', badge: 'bg-red-500/20 text-red-400', text: 'text-red-400' };
    if (stock <= 3) return { border: 'border-orange-500/40', bg: 'bg-orange-500/5', badge: 'bg-orange-500/20 text-orange-400', text: 'text-orange-400' };
    if (stock <= 10) return { border: 'border-yellow-500/30', bg: 'bg-yellow-500/5', badge: 'bg-yellow-500/20 text-yellow-400', text: 'text-yellow-400' };
    return { border: 'border-emerald-500/30', bg: 'bg-emerald-500/5', badge: 'bg-emerald-500/20 text-emerald-400', text: 'text-emerald-400' };
  }

  function getStockLabel(stock: number) {
    if (stock === 0) return '‚õî Sin stock';
    if (stock <= 3) return '‚ö†Ô∏è Muy bajo';
    if (stock <= 10) return 'üì¶ Bajo';
    return '‚úÖ OK';
  }

  function updateStockBySizeUI() {
    const arr = Array.from(selectedSizes);
    
    if (arr.length === 0) {
      stockBySizeSection?.classList.add('hidden');
      stockBySize = {};
      updateStockBySizeHidden();
      return;
    }

    stockBySizeSection?.classList.remove('hidden');

    // Limpiar tallas que ya no est√°n seleccionadas
    Object.keys(stockBySize).forEach(size => {
      if (!selectedSizes.has(size)) {
        delete stockBySize[size];
      }
    });

    // A√±adir tallas nuevas con stock 0
    arr.forEach(size => {
      if (!(size in stockBySize)) {
        stockBySize[size] = 0;
      }
    });

    // Renderizar inputs con indicadores de color
    stockBySizeGrid.innerHTML = '';
    arr.forEach(size => {
      const stock = stockBySize[size] || 0;
      const colors = getStockColor(stock);
      const div = document.createElement('div');
      div.className = `flex flex-col gap-1.5 rounded-lg p-3 border ${colors.border} ${colors.bg} transition-all duration-200`;
      div.dataset.stockSize = size;
      div.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-sm font-bold text-accent-gold">${size}</span>
          <span class="stock-label text-[10px] font-medium px-1.5 py-0.5 rounded-full ${colors.badge}">${getStockLabel(stock)}</span>
        </div>
        <div class="relative">
          <input 
            type="number" 
            min="0" 
            max="999999" 
            value="${stock}"
            data-size="${size}"
            class="stock-size-input w-full px-3 py-2 text-sm bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent text-center font-medium"
            placeholder="0"
          />
          <span class="absolute right-2 top-2 text-[10px] text-gray-600">uds</span>
        </div>
      `;
      stockBySizeGrid.appendChild(div);
    });

    // Event listeners para inputs con actualizaci√≥n visual en tiempo real
    stockBySizeGrid.querySelectorAll<HTMLInputElement>('.stock-size-input').forEach(input => {
      input.addEventListener('input', () => {
        const size = input.dataset.size || '';
        const val = parseInt(input.value) || 0;
        stockBySize[size] = val;
        
        // Actualizar indicador visual de este input
        const container = input.closest('[data-stock-size]');
        if (container) {
          const colors = getStockColor(val);
          (container as HTMLElement).className = `flex flex-col gap-1.5 rounded-lg p-3 border ${colors.border} ${colors.bg} transition-all duration-200`;
          const label = container.querySelector('.stock-label');
          if (label) {
            label.className = `stock-label text-[10px] font-medium px-1.5 py-0.5 rounded-full ${colors.badge}`;
            label.textContent = getStockLabel(val);
          }
        }
        
        updateStockBySizeHidden();
      });

      // Seleccionar todo el texto al hacer focus
      input.addEventListener('focus', () => { input.select(); });
    });

    updateStockBySizeHidden();
  }

  function updateStockBySizeHidden() {
    stockBySizeHidden.value = JSON.stringify(stockBySize);
    const total = Object.values(stockBySize).reduce((sum: number, v: number) => sum + (v || 0), 0);
    stockTotalInput.value = total.toString();
    
    // Actualizar badge del total
    if (stockTotalBadge) {
      stockTotalBadge.textContent = `${total} uds`;
    }

    // Actualizar resumen
    if (stockSummaryEl) {
      const arr = Array.from(selectedSizes);
      const outOfStock = arr.filter(s => (stockBySize[s] || 0) === 0).length;
      const lowStock = arr.filter(s => { const v = stockBySize[s] || 0; return v > 0 && v <= 3; }).length;
      
      let parts = [`<span class="text-gray-400">Total: <strong class="text-white">${total}</strong> unidades en <strong class="text-white">${arr.length}</strong> tallas</span>`];
      if (outOfStock > 0) parts.push(`<span class="text-red-400">‚õî ${outOfStock} sin stock</span>`);
      if (lowStock > 0) parts.push(`<span class="text-orange-400">‚ö†Ô∏è ${lowStock} stock bajo</span>`);
      stockSummaryEl.innerHTML = parts.join(' ¬∑ ');
    }
  }

  // Preset buttons
  document.querySelectorAll<HTMLButtonElement>('.size-preset-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const preset = btn.dataset.preset || '';
      // Highlight active preset button
      document.querySelectorAll('.size-preset-btn').forEach(b => {
        (b as HTMLElement).className = 'size-preset-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 hover:text-accent-gold transition-all bg-white/5';
      });
      btn.className = 'size-preset-btn px-3 py-1.5 text-xs rounded-lg border border-accent-gold text-accent-gold transition-all bg-accent-gold/10';
      currentPreset = preset;

      // Si es talla √∫nica, seleccionar autom√°ticamente
      if (preset === 'unica') {
        selectedSizes.clear();
        selectedSizes.add('√önica');
      } else {
        // Mantener seleccionadas solo las que est√©n en este preset
        const presetSizes = SIZE_PRESETS[preset as keyof typeof SIZE_PRESETS] || [];
        const keepSelected = new Set<string>();
        selectedSizes.forEach((s: string) => {
          if (presetSizes.includes(s)) keepSelected.add(s);
        });
        selectedSizes = keepSelected;
      }
      renderSizeButtons(preset);
      updateSizesUI();
    });
  });

  // Custom size
  addCustomBtn?.addEventListener('click', () => {
    const val = customInput?.value?.trim().toUpperCase();
    if (val && !selectedSizes.has(val)) {
      selectedSizes.add(val);
      // Si no est√° en el grid, a√±adir bot√≥n
      const existing = sizesGrid.querySelector(`[data-size="${val}"]`);
      if (!existing) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = val;
        btn.dataset.size = val;
        btn.className = 'size-toggle-btn px-4 py-2 text-sm rounded-lg border-2 font-medium transition-all cursor-pointer border-accent-gold bg-accent-gold/20 text-white';
        btn.addEventListener('click', () => toggleSize(val));
        sizesGrid.appendChild(btn);
      }
      updateSizesUI();
      if (customInput) customInput.value = '';
    }
  });

  customInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addCustomBtn?.click();
    }
  });

  // Inicializar con preset de letras
  renderSizeButtons('letras');
  const letrasPresetBtn = document.querySelector('[data-preset="letras"]') as HTMLElement | null;
  if (letrasPresetBtn) letrasPresetBtn.className = 'size-preset-btn px-3 py-1.5 text-xs rounded-lg border border-accent-gold text-accent-gold transition-all bg-accent-gold/10';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // EDITOR DE MEDIDAS POR TALLA
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const MEASURE_LABELS: Record<string, string> = {
    chest: 'Pecho',
    waist: 'Cintura',
    hip: 'Cadera',
    length: 'Largo total',
    sleeve: 'Manga',
    shoulder: 'Hombro',
    inseam: 'Entrepierna',
    foot: 'Pie',
  };

  const DEFAULT_MEASUREMENTS: Record<string, Record<string, Record<string, [number, number]>>> = {
    mujer: {
      XS:  { chest: [78, 82],  waist: [60, 64],  hip: [86, 90],  length: [60, 62], sleeve: [58, 60], shoulder: [36, 38] },
      S:   { chest: [82, 88],  waist: [64, 70],  hip: [90, 96],  length: [62, 64], sleeve: [59, 61], shoulder: [37, 39] },
      M:   { chest: [88, 94],  waist: [70, 76],  hip: [96, 102], length: [64, 66], sleeve: [60, 62], shoulder: [38, 40] },
      L:   { chest: [94, 100], waist: [76, 82],  hip: [102, 108], length: [66, 68], sleeve: [61, 63], shoulder: [39, 41] },
      XL:  { chest: [100, 108], waist: [82, 90],  hip: [108, 116], length: [68, 70], sleeve: [62, 64], shoulder: [40, 42] },
      XXL: { chest: [108, 118], waist: [90, 100], hip: [116, 126], length: [70, 72], sleeve: [63, 65], shoulder: [41, 43] },
    },
    hombre: {
      XS:  { chest: [84, 88],  waist: [70, 74],  hip: [86, 90],  length: [66, 68], sleeve: [61, 63], shoulder: [40, 42] },
      S:   { chest: [88, 94],  waist: [74, 80],  hip: [90, 96],  length: [68, 70], sleeve: [62, 64], shoulder: [42, 44] },
      M:   { chest: [94, 100], waist: [80, 86],  hip: [96, 102], length: [70, 72], sleeve: [63, 65], shoulder: [44, 46] },
      L:   { chest: [100, 108], waist: [86, 94],  hip: [102, 108], length: [72, 74], sleeve: [64, 66], shoulder: [46, 48] },
      XL:  { chest: [108, 116], waist: [94, 102], hip: [108, 116], length: [74, 76], sleeve: [65, 67], shoulder: [48, 50] },
      XXL: { chest: [116, 126], waist: [102, 112], hip: [116, 126], length: [76, 78], sleeve: [66, 68], shoulder: [50, 52] },
    }
  };

  type MeasureRange = [number | null, number | null] | [string, string];
  type SizeMeasurement = Record<string, MeasureRange>;
  type SizeMeasurementsMap = Record<string, SizeMeasurement>;

  const measurementsSection = document.getElementById('measurements-section');
  const measurementsEditor = document.getElementById('measurements-editor') as HTMLDivElement;
  const measurementsHidden = document.getElementById('measurements-hidden') as HTMLInputElement;
  const fillDefaultBtn = document.getElementById('fill-default-measurements');
  let sizeMeasurements: SizeMeasurementsMap = {};
  let activeMeasureTypes = new Set<string>(['chest', 'waist', 'hip']);

  // Toggle de tipos de medida
  document.querySelectorAll<HTMLButtonElement>('.measure-type-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.measureType || '';
      if (activeMeasureTypes.has(type)) {
        activeMeasureTypes.delete(type);
        btn.className = 'measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-white/10 text-gray-400 hover:border-accent-gold/50 bg-white/5 transition-all';
      } else {
        activeMeasureTypes.add(type);
        btn.className = 'measure-type-btn px-3 py-1.5 text-xs rounded-lg border border-accent-gold text-accent-gold bg-accent-gold/10 transition-all';
      }
      renderMeasurementsEditor();
    });
  });

  function renderMeasurementsEditor() {
    const sizes = Array.from(selectedSizes);
    if (sizes.length === 0 || (sizes.length === 1 && sizes[0] === '√önica') || activeMeasureTypes.size === 0) {
      if (sizes.length === 0 || (sizes.length === 1 && sizes[0] === '√önica')) {
        measurementsSection?.classList.add('hidden');
      }
      measurementsHidden.value = '';
      measurementsEditor.innerHTML = '';
      return;
    }
    measurementsSection?.classList.remove('hidden');
    measurementsEditor.innerHTML = '';

    const activeTypes = Array.from(activeMeasureTypes);

    sizes.forEach((size: string) => {
      const m = sizeMeasurements[size] || {};
      const row = document.createElement('div');
      row.className = 'bg-dark-card/50 rounded-lg border border-white/5 p-3';
      row.dataset.measureSize = size;

      const fieldsHtml = activeTypes.map((type) => {
        const val = m[type] || ['', ''];
        return `
          <div>
            <label class="text-[10px] text-gray-500 mb-1 block">${MEASURE_LABELS[type] || type} (cm)</label>
            <div class="flex items-center gap-1">
              <input type="number" data-size="${size}" data-measure="${type}" data-bound="0" value="${val[0]}" min="20" max="200" placeholder="min" class="measure-input w-full px-2 py-1.5 text-xs bg-dark-card border border-white/10 rounded text-white placeholder-gray-600 focus:ring-1 focus:ring-accent-gold/50" />
              <span class="text-gray-600 text-xs">‚Äì</span>
              <input type="number" data-size="${size}" data-measure="${type}" data-bound="1" value="${val[1]}" min="20" max="200" placeholder="max" class="measure-input w-full px-2 py-1.5 text-xs bg-dark-card border border-white/10 rounded text-white placeholder-gray-600 focus:ring-1 focus:ring-accent-gold/50" />
            </div>
          </div>
        `;
      }).join('');

      // Calcular grid cols seg√∫n la cantidad de medidas activas
      const cols = activeTypes.length <= 3 ? activeTypes.length : Math.min(activeTypes.length, 4);

      row.innerHTML = `
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-bold text-accent-gold bg-accent-gold/10 px-2 py-0.5 rounded">${size}</span>
          <span class="text-[10px] text-gray-600">Rango m√≠n ‚Äì m√°x en cm</span>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-${cols} gap-3">
          ${fieldsHtml}
        </div>
      `;
      measurementsEditor.appendChild(row);
    });

    // Escuchar cambios en todos los inputs de medidas
    measurementsEditor.querySelectorAll<HTMLInputElement>('.measure-input').forEach((input) => {
      input.addEventListener('input', updateMeasurementsHidden);
    });
    updateMeasurementsHidden();
  }

  function updateMeasurementsHidden() {
    const data: SizeMeasurementsMap = {};
    measurementsEditor.querySelectorAll<HTMLInputElement>('.measure-input').forEach((input) => {
      const size = input.dataset.size || '';
      const measure = input.dataset.measure || '';
      const bound = parseInt(input.dataset.bound || '0');
      const val = input.value ? parseInt(input.value) : null;
      if (!data[size]) data[size] = {};
      if (!data[size][measure]) data[size][measure] = [null, null];
      (data[size][measure] as (number | null)[])[bound] = val;
    });
    // Limpiar entradas vac√≠as
    const clean: SizeMeasurementsMap = {};
    for (const [size, measures] of Object.entries(data)) {
      const hasAny = Object.values(measures).some(arr => arr[0] !== null || arr[1] !== null);
      if (hasAny) clean[size] = measures;
    }
    sizeMeasurements = { ...sizeMeasurements, ...data };
    measurementsHidden.value = Object.keys(clean).length > 0 ? JSON.stringify(clean) : '';
  }

  fillDefaultBtn?.addEventListener('click', () => {
    // Detectar g√©nero seg√∫n la categor√≠a seleccionada
    const catSelect = document.getElementById('category_id') as HTMLSelectElement | null;
    const selectedOption = catSelect?.options?.[catSelect.selectedIndex];
    const optgroupLabel = (selectedOption?.parentElement as HTMLOptGroupElement)?.label || '';
    const gender = optgroupLabel.toLowerCase().includes('hombre') ? 'hombre' : 'mujer';
    const defaults = DEFAULT_MEASUREMENTS[gender] || DEFAULT_MEASUREMENTS['mujer'];

    const sizes = Array.from(selectedSizes);
    sizes.forEach((size: string) => {
      const sizeDefaults = defaults[size as keyof typeof defaults];
      if (sizeDefaults) {
        if (!sizeMeasurements[size]) sizeMeasurements[size] = {};
        // Solo rellenar las medidas activas que tengan valores por defecto
        activeMeasureTypes.forEach((type) => {
          if (sizeDefaults[type]) {
            sizeMeasurements[size][type] = [...sizeDefaults[type]] as [number, number];
          }
        });
      }
    });
    renderMeasurementsEditor();
  });

  // Hook: cada vez que cambian las tallas, actualizar el editor de medidas
  const _origUpdateSizesUI = updateSizesUI;
  // @ts-ignore - reasignaci√≥n intencional para decorar la funci√≥n
  updateSizesUI = function() {
    _origUpdateSizesUI();
    renderMeasurementsEditor();
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // UPLOADER DE IM√ÅGENES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const imageUrls: string[] = [];
  const dropZone = document.getElementById('drop-zone') as HTMLDivElement;
  const fileInput = document.getElementById('file-input') as HTMLInputElement;
  const urlInput = document.getElementById('url-input') as HTMLInputElement;
  const addUrlBtn = document.getElementById('add-url-btn') as HTMLButtonElement;
  const imagesGrid = document.getElementById('images-grid') as HTMLDivElement;
  const imagesHidden = document.getElementById('images-hidden') as HTMLInputElement;
  const imagesSummary = document.getElementById('images-summary') as HTMLDivElement;
  const uploadProgress = document.getElementById('upload-progress') as HTMLDivElement;
  const uploadBar = document.getElementById('upload-bar') as HTMLDivElement;
  const uploadText = document.getElementById('upload-text') as HTMLSpanElement;
  const imagesError = document.getElementById('images-error') as HTMLDivElement;
  const imagesErrorText = document.getElementById('images-error-text') as HTMLSpanElement;

  function showImageError(msg: string) {
    imagesErrorText.textContent = msg;
    imagesError.style.display = 'flex';
    imagesError.classList.remove('hidden');
    setTimeout(() => { imagesError.classList.add('hidden'); imagesError.style.display = ''; }, 5000);
  }

  function updateImagesUI() {
    imagesHidden.value = imageUrls.join('\n');
    if (imageUrls.length > 0) {
      imagesSummary.innerHTML = `<span class="text-accent-gold font-medium">${imageUrls.length} imagen${imageUrls.length > 1 ? 'es' : ''}</span> ¬∑ La primera es la principal`;
    } else {
      imagesSummary.textContent = 'A√±ade al menos una imagen';
    }
    renderImagesGrid();
  }

  function renderImagesGrid() {
    imagesGrid.innerHTML = '';
    imageUrls.forEach((url: string, i: number) => {
      const card = document.createElement('div');
      card.className = 'relative group rounded-lg overflow-hidden border-2 border-white/10 aspect-square bg-dark-card';
      card.draggable = true;
      card.dataset.index = String(i);
      card.innerHTML = `
        <img src="${url}" alt="Imagen ${i + 1}" class="w-full h-full object-cover" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2210%22>Error</text></svg>'" />
        ${i === 0 ? '<span class="absolute top-1 left-1 bg-accent-gold text-dark-bg text-[9px] font-bold px-1.5 py-0.5 rounded">Principal</span>' : ''}
        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
          ${i > 0 ? `<button type="button" data-action="move-first" data-idx="${i}" class="p-1.5 bg-white/20 rounded-lg hover:bg-white/30 text-white" title="Hacer principal"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg></button>` : ''}
          <button type="button" data-action="remove" data-idx="${i}" class="p-1.5 bg-red-500/60 rounded-lg hover:bg-red-500/80 text-white" title="Eliminar"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
        </div>
      `;
      imagesGrid.appendChild(card);
    });

    // Event listeners para botones
    imagesGrid.querySelectorAll<HTMLButtonElement>('[data-action="remove"]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const idx = parseInt(btn.dataset.idx || '0');
        imageUrls.splice(idx, 1);
        updateImagesUI();
      });
    });
    imagesGrid.querySelectorAll<HTMLButtonElement>('[data-action="move-first"]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const idx = parseInt(btn.dataset.idx || '0');
        const [moved] = imageUrls.splice(idx, 1);
        imageUrls.unshift(moved);
        updateImagesUI();
      });
    });
  }

  async function uploadFiles(files: FileList | null) {
    if (!files) return;
    const validFiles = Array.from(files).filter((f: File) => {
      if (f.size > 10 * 1024 * 1024) { showImageError(`${f.name} supera 10MB`); return false; }
      if (!f.type.startsWith('image/')) { showImageError(`${f.name} no es una imagen`); return false; }
      return true;
    });
    if (!validFiles.length) return;

    uploadProgress.classList.remove('hidden');
    let uploaded = 0;

    for (const file of validFiles) {
      uploadText.textContent = `Subiendo ${uploaded + 1}/${validFiles.length}...`;
      uploadBar.style.width = `${(uploaded / validFiles.length) * 100}%`;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/api/admin/upload-image', { 
          method: 'POST', 
          body: formData,
          credentials: 'same-origin',
        });
        const data = await res.json();
        console.log('[Upload] Response:', res.status, data);
        if (res.ok && data.url) {
          imageUrls.push(data.url);
        } else {
          showImageError(data.error || `Error subiendo ${file.name}`);
        }
      } catch (err) {
        showImageError(`Error de red subiendo ${file.name}`);
      }
      uploaded++;
      uploadBar.style.width = `${(uploaded / validFiles.length) * 100}%`;
    }

    uploadText.textContent = '¬°Listo!';
    setTimeout(() => uploadProgress.classList.add('hidden'), 1500);
    updateImagesUI();
  }

  // Click en la zona de drop
  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => uploadFiles(fileInput.files));

  // Drag & Drop
  ['dragenter', 'dragover'].forEach(ev => {
    dropZone.addEventListener(ev, (e) => { e.preventDefault(); dropZone.classList.add('border-accent-gold/50', 'bg-accent-gold/5'); });
  });
  ['dragleave', 'drop'].forEach(ev => {
    dropZone.addEventListener(ev, (e) => { e.preventDefault(); dropZone.classList.remove('border-accent-gold/50', 'bg-accent-gold/5'); });
  });
  dropZone.addEventListener('drop', (e: DragEvent) => {
    e.preventDefault();
    const files = e.dataTransfer?.files;
    if (files?.length) uploadFiles(files);
  });

  // A√±adir URL manual
  addUrlBtn.addEventListener('click', () => {
    const url = urlInput.value.trim();
    if (!url) return;
    try {
      new URL(url);
      imageUrls.push(url);
      updateImagesUI();
      urlInput.value = '';
    } catch {
      showImageError('URL no v√°lida');
    }
  });
  urlInput.addEventListener('keydown', (e: KeyboardEvent) => { if (e.key === 'Enter') { e.preventDefault(); addUrlBtn.click(); } });

  // Inicializar
  updateImagesUI();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // VALIDACI√ìN DEL FORMULARIO ANTES DE ENVIAR
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const form = document.querySelector('form') as HTMLFormElement;
  form?.addEventListener('submit', (e) => {
    const errors: string[] = [];
    
    const nameVal = (document.getElementById('name') as HTMLInputElement)?.value?.trim();
    if (!nameVal || nameVal.length < 3) errors.push('El nombre debe tener al menos 3 caracteres');
    
    const priceVal = (document.getElementById('price') as HTMLInputElement)?.value;
    if (!priceVal || parseFloat(priceVal) < 0) errors.push('Introduce un precio v√°lido');
    
    const stockVal = (document.getElementById('stock') as HTMLInputElement)?.value;
    if (!stockVal || parseInt(stockVal) < 0) errors.push('Introduce un stock v√°lido');
    
    const catVal = (document.getElementById('category_id') as HTMLSelectElement)?.value;
    if (!catVal) errors.push('Selecciona una categor√≠a');
    
    const sizesVal = sizesHidden.value;
    if (!sizesVal) errors.push('Selecciona al menos una talla');
    
    const imagesVal = imagesHidden.value;
    if (!imagesVal || !imagesVal.trim()) errors.push('A√±ade al menos una imagen');
    
    if (errors.length > 0) {
      e.preventDefault();
      alert('Por favor corrige lo siguiente:\n\n‚Ä¢ ' + errors.join('\n‚Ä¢ '));
      return false;
    }
    
    console.log('[Form] Submitting with:', {
      name: nameVal,
      price: priceVal,
      stock: stockVal,
      category: catVal,
      sizes: sizesVal,
      images: imagesVal?.split('\n').length + ' images',
    });
  });
</script>
