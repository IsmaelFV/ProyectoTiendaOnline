---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/pedidos');
}

// Obtener pedido completo con items
const { data: order, error: orderError } = await supabase
  .from('orders')
  .select('*')
  .eq('id', id)
  .single();

if (orderError || !order) {
  return Astro.redirect('/admin/pedidos');
}

// Obtener items del pedido
const { data: orderItems } = await supabase
  .from('order_items')
  .select('*')
  .eq('order_id', id);

// Formatear moneda
const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(amount);
};

// Formatear fecha
const formatDate = (date: string) => {
  return new Date(date).toLocaleString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// Estados disponibles
const statusOptions = [
  { value: 'pending', label: 'Pendiente', color: 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' },
  { value: 'confirmed', label: 'Confirmado', color: 'bg-blue-500/20 text-blue-400 border border-blue-500/30' },
  { value: 'processing', label: 'Procesando', color: 'bg-indigo-500/20 text-indigo-400 border border-indigo-500/30' },
  { value: 'shipped', label: 'Enviado', color: 'bg-purple-500/20 text-purple-400 border border-purple-500/30' },
  { value: 'delivered', label: 'Entregado', color: 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' },
  { value: 'cancelled', label: 'Cancelado', color: 'bg-red-500/20 text-red-400 border border-red-500/30' },
  { value: 'refunded', label: 'Reembolsado', color: 'bg-gray-500/20 text-gray-400 border border-gray-500/30' }
];

const currentStatus = statusOptions.find(s => s.value === order.status) || statusOptions[0];

// Estados de pago
const paymentStatusOptions = [
  { value: 'pending', label: 'Pendiente', color: 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' },
  { value: 'paid', label: 'Pagado', color: 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' },
  { value: 'failed', label: 'Fallido', color: 'bg-red-500/20 text-red-400 border border-red-500/30' },
  { value: 'refunded', label: 'Reembolsado', color: 'bg-gray-500/20 text-gray-400 border border-gray-500/30' }
];

const currentPaymentStatus = paymentStatusOptions.find(s => s.value === order.payment_status) || paymentStatusOptions[0];
---

<AdminLayout title={`Pedido ${order.order_number} - Admin`}>
  <div class="space-y-6">
    {/* Header con botón volver */}
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <a
          href="/admin/pedidos"
          class="text-gray-400 hover:text-white transition-colors"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </a>
        <div>
          <h1 class="text-3xl font-bold text-white">Pedido {order.order_number}</h1>
          <p class="text-sm text-gray-500 mt-1">Creado el {formatDate(order.created_at)}</p>
        </div>
      </div>
      
      {/* Estado actual */}
      <div class="flex items-center space-x-3">
        <span class={`px-3 py-1 rounded-full text-sm font-medium ${currentPaymentStatus.color}`}>
          {currentPaymentStatus.label}
        </span>
        <span class={`px-3 py-1 rounded-full text-sm font-medium ${currentStatus.color}`}>
          {currentStatus.label}
        </span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      {/* Columna izquierda - Productos */}
      <div class="lg:col-span-2 space-y-6">
        {/* Items del pedido */}
        <div class="bg-dark-surface rounded-xl border border-white/10 overflow-hidden">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Productos ({orderItems?.length || 0})</h2>
          </div>
          
          <div class="divide-y divide-white/5">
            {orderItems && orderItems.map((item) => (
              <div class="px-6 py-4 flex items-center space-x-4">
                {/* Imagen */}
                {item.product_image && (
                  <img
                    src={item.product_image}
                    alt={item.product_name}
                    class="w-16 h-16 object-cover rounded"
                  />
                )}
                
                {/* Info del producto */}
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-white truncate">
                    {item.product_name}
                  </p>
                  <p class="text-sm text-gray-500">
                    SKU: {item.product_sku} • Talla: {item.size}
                  </p>
                </div>
                
                {/* Cantidad y precio */}
                <div class="text-right">
                  <p class="text-sm text-gray-400">
                    {item.quantity} × {formatCurrency(item.price_per_unit)}
                  </p>
                  <p class="text-sm font-medium text-accent-gold">
                    {formatCurrency(item.total_price)}
                  </p>
                </div>
              </div>
            ))}
          </div>
          
          {/* Totales */}
          <div class="px-6 py-4 bg-dark-card/50 border-t border-white/10 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-400">Subtotal:</span>
              <span class="text-white">{formatCurrency(order.subtotal)}</span>
            </div>
            {order.shipping_cost > 0 && (
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Envío:</span>
                <span class="text-white">{formatCurrency(order.shipping_cost)}</span>
              </div>
            )}
            {order.tax > 0 && (
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">IVA:</span>
                <span class="text-white">{formatCurrency(order.tax)}</span>
              </div>
            )}
            {order.discount > 0 && (
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Descuento:</span>
                <span class="text-red-400">-{formatCurrency(order.discount)}</span>
              </div>
            )}
            <div class="flex justify-between text-base font-semibold pt-2 border-t border-white/10">
              <span class="text-white">Total:</span>
              <span class="text-accent-gold">{formatCurrency(order.total)}</span>
            </div>
          </div>
        </div>

        {/* Información de pago */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Información de Pago</h2>
          </div>
          <div class="px-6 py-4 space-y-3">
            <div class="flex justify-between">
              <span class="text-sm text-gray-400">Método de pago:</span>
              <span class="text-sm text-white capitalize">{order.payment_method}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-400">Estado del pago:</span>
              <span class={`text-sm px-2 py-1 rounded ${currentPaymentStatus.color}`}>
                {currentPaymentStatus.label}
              </span>
            </div>
            {order.payment_id && (
              <div class="flex justify-between">
                <span class="text-sm text-gray-400">ID de pago:</span>
                <span class="text-sm text-white font-mono">{order.payment_id}</span>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Columna derecha - Información del cliente y gestión */}
      <div class="space-y-6">
        {/* Actualizar estado */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Gestión del Pedido</h2>
          </div>
          <div class="px-6 py-4">
            <form id="update-status-form" class="space-y-4">
              <div>
                <label for="status" class="block text-sm font-medium text-gray-400 mb-1">
                  Estado del pedido
                </label>
                <select
                  id="status"
                  name="status"
                  class="w-full px-3 py-2 bg-dark-card border border-white/10 rounded-lg text-white focus:ring-2 focus:ring-accent-gold focus:border-transparent"
                >
                  {statusOptions.map(option => (
                    <option value={option.value} selected={option.value === order.status}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label for="shipping_method" class="block text-sm font-medium text-gray-400 mb-1">
                  Método de envío
                </label>
                <input
                  type="text"
                  id="shipping_method"
                  name="shipping_method"
                  value={order.shipping_method || ''}
                  placeholder="Ej: SEUR, Correos Express"
                  class="w-full px-3 py-2 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent"
                />
              </div>

              <div>
                <label for="tracking_number" class="block text-sm font-medium text-gray-400 mb-1">
                  Número de seguimiento
                </label>
                <input
                  type="text"
                  id="tracking_number"
                  name="tracking_number"
                  value={order.tracking_number || ''}
                  placeholder="Código de tracking"
                  class="w-full px-3 py-2 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent"
                />
              </div>

              <div>
                <label for="admin_notes" class="block text-sm font-medium text-gray-400 mb-1">
                  Notas internas
                </label>
                <textarea
                  id="admin_notes"
                  name="admin_notes"
                  rows="3"
                  class="w-full px-3 py-2 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent"
                  placeholder="Notas privadas del administrador"
                >{order.admin_notes || ''}</textarea>
              </div>

              <button
                type="submit"
                class="w-full bg-accent-gold text-dark-bg px-4 py-2 rounded-lg hover:bg-accent-gold/90 transition-colors font-medium"
              >
                Guardar cambios
              </button>
            </form>
          </div>
        </div>

        {/* Zona de peligro - Reembolso */}
        {(order.payment_status === 'paid' && order.status !== 'refunded') && (
          <div class="bg-dark-surface rounded-xl border-2 border-red-500/30">
            <div class="px-6 py-4 border-b border-red-500/30 bg-red-500/10">
              <h2 class="text-lg font-semibold text-red-400">Zona de Peligro</h2>
            </div>
            <div class="px-6 py-4">
              <p class="text-sm text-gray-400 mb-4">
                El reembolso devolverá el dinero al cliente mediante Stripe y recuperará el stock de los productos. Esta acción no se puede deshacer.
              </p>
              <button
                id="refund-button"
                type="button"
                class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium"
              >
                Procesar Reembolso
              </button>
            </div>
          </div>
        )}

        {/* Estado de reembolso */}
        {(order.status === 'refunded' || order.payment_status === 'refunded') && (
          <div class="bg-dark-surface rounded-xl border border-white/10">
            <div class="px-6 py-4 bg-emerald-500/10">
              <div class="flex items-center space-x-2">
                <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-lg font-semibold text-white">Pedido Reembolsado</h2>
              </div>
              <p class="text-sm text-gray-400 mt-2">
                Este pedido ha sido reembolsado. El dinero fue devuelto al cliente y el stock recuperado.
              </p>
            </div>
          </div>
        )}

        {/* Información del cliente */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Cliente</h2>
          </div>
          <div class="px-6 py-4 space-y-3">
            <div>
              <p class="text-sm text-gray-400">Nombre:</p>
              <p class="text-sm font-medium text-white">{order.shipping_full_name}</p>
            </div>
            {order.shipping_phone && (
              <div>
                <p class="text-sm text-gray-400">Teléfono:</p>
                <p class="text-sm text-white">{order.shipping_phone}</p>
              </div>
            )}
            {order.user_id && (
              <div>
                <p class="text-sm text-gray-400">ID Usuario:</p>
                <p class="text-sm text-gray-500 font-mono text-xs">{order.user_id}</p>
              </div>
            )}
          </div>
        </div>

        {/* Dirección de envío */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Dirección de Envío</h2>
          </div>
          <div class="px-6 py-4">
            <address class="text-sm text-gray-300 not-italic space-y-1">
              <p class="font-medium">{order.shipping_full_name}</p>
              <p>{order.shipping_address_line1}</p>
              {order.shipping_address_line2 && <p>{order.shipping_address_line2}</p>}
              <p>{order.shipping_postal_code} {order.shipping_city}</p>
              {order.shipping_state && <p>{order.shipping_state}</p>}
              <p class="uppercase">{order.shipping_country}</p>
            </address>
          </div>
        </div>

        {/* Notas del cliente */}
        {order.customer_notes && (
          <div class="bg-dark-surface rounded-xl border border-white/10">
            <div class="px-6 py-4 border-b border-white/10">
              <h2 class="text-lg font-semibold text-white">Notas del Cliente</h2>
            </div>
            <div class="px-6 py-4">
              <p class="text-sm text-gray-300">{order.customer_notes}</p>
            </div>
          </div>
        )}

        {/* Timestamps */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Historial</h2>
          </div>
          <div class="px-6 py-4 space-y-2 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-400">Creado:</span>
              <span class="text-white">{formatDate(order.created_at)}</span>
            </div>
            {order.updated_at && order.updated_at !== order.created_at && (
              <div class="flex justify-between">
                <span class="text-gray-400">Actualizado:</span>
                <span class="text-white">{formatDate(order.updated_at)}</span>
              </div>
            )}
            {order.shipped_at && (
              <div class="flex justify-between">
                <span class="text-gray-400">Enviado:</span>
                <span class="text-white">{formatDate(order.shipped_at)}</span>
              </div>
            )}
            {order.delivered_at && (
              <div class="flex justify-between">
                <span class="text-gray-400">Entregado:</span>
                <span class="text-white">{formatDate(order.delivered_at)}</span>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { customConfirm, customAlert } from '../../../lib/notifications';
    
    // Actualizar estado del pedido
    document.getElementById('update-status-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const button = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      
      // Deshabilitar botón y mostrar loading
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Guardando...';
      
      try {
        const response = await fetch(`/api/orders/${window.location.pathname.split('/').pop()}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            status: formData.get('status'),
            shipping_method: formData.get('shipping_method') || null,
            tracking_number: formData.get('tracking_number') || null,
            admin_notes: formData.get('admin_notes') || null,
          }),
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Recargar página para ver cambios
          window.location.reload();
        } else {
          customAlert('Error al actualizar: ' + result.error, 'error');
          button.disabled = false;
          button.textContent = originalText;
        }
      } catch (error) {
        console.error('Error:', error);
        customAlert('Error al actualizar el pedido', 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    });

    // Procesar reembolso
    document.getElementById('refund-button')?.addEventListener('click', async (e) => {
      const button = e.target as HTMLButtonElement;
      
      // Confirmación
      const confirmRefund = await customConfirm(
        '¿Estás seguro de que quieres reembolsar este pedido?\n\n' +
        'Esta acción:\n' +
        '• Devolverá el dinero al cliente mediante Stripe\n' +
        '• Recuperará el stock de los productos\n' +
        '• NO se puede deshacer\n\n' +
        '¿Deseas continuar?',
        {
          title: 'Procesar reembolso',
          confirmText: 'Sí, reembolsar',
          cancelText: 'Cancelar',
          type: 'danger'
        }
      );
      
      if (!confirmRefund) return;
      
      // Deshabilitar botón y mostrar loading
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Procesando reembolso...';
      
      try {
        const response = await fetch(`/api/orders/${window.location.pathname.split('/').pop()}/refund`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        
        const result = await response.json();
        
        if (result.success) {
          customAlert(`Reembolso procesado correctamente\n\nID: ${result.refund.id}\nMonto: €${result.refund.amount}`, 'success');
          // Recargar página para ver cambios
          setTimeout(() => window.location.reload(), 2000);
        } else {
          customAlert('Error al procesar reembolso:\n\n' + result.error, 'error');
          button.disabled = false;
          button.textContent = originalText;
        }
      } catch (error) {
        console.error('Error:', error);
        customAlert('Error al procesar el reembolso', 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    });
  </script>
</AdminLayout>
