---
import AdminLayout from '@layouts/AdminLayout.astro';
import { verifyAdminFromCookies, createServerSupabaseClient } from '@lib/auth';

// Protecci√≥n: solo admins
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

const userId = await verifyAdminFromCookies(accessToken, refreshToken);
if (!userId) {
  return Astro.redirect('/auth/login');
}

const supabase = createServerSupabaseClient();

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/pedidos');
}

// Obtener pedido completo con items
const { data: order, error: orderError } = await supabase
  .from('orders')
  .select('*')
  .eq('id', id)
  .single();

if (orderError || !order) {
  return Astro.redirect('/admin/pedidos');
}

// Obtener items del pedido
const { data: orderItems } = await supabase
  .from('order_items')
  .select('*')
  .eq('order_id', id);

// Formatear moneda
const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(amount);
};

// Formatear fecha
const formatDate = (date: string) => {
  return new Date(date).toLocaleString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// Estados disponibles
const statusOptions = [
  { value: 'pending', label: 'Pendiente', color: 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' },
  { value: 'confirmed', label: 'Confirmado', color: 'bg-blue-500/20 text-blue-400 border border-blue-500/30' },
  { value: 'processing', label: 'Procesando', color: 'bg-indigo-500/20 text-indigo-400 border border-indigo-500/30' },
  { value: 'shipped', label: 'Enviado', color: 'bg-purple-500/20 text-purple-400 border border-purple-500/30' },
  { value: 'delivered', label: 'Entregado', color: 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' },
  { value: 'cancelled', label: 'Cancelado', color: 'bg-red-500/20 text-red-400 border border-red-500/30' },
  { value: 'refunded', label: 'Reembolsado', color: 'bg-gray-500/20 text-gray-400 border border-gray-500/30' }
];

const currentStatus = statusOptions.find(s => s.value === order.status) || statusOptions[0];

// Estados de pago
const paymentStatusOptions = [
  { value: 'pending', label: 'Pendiente', color: 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' },
  { value: 'paid', label: 'Pagado', color: 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' },
  { value: 'failed', label: 'Fallido', color: 'bg-red-500/20 text-red-400 border border-red-500/30' },
  { value: 'refunded', label: 'Reembolsado', color: 'bg-gray-500/20 text-gray-400 border border-gray-500/30' }
];

const currentPaymentStatus = paymentStatusOptions.find(s => s.value === order.payment_status) || paymentStatusOptions[0];

// Timeline de progreso del pedido
const timelineSteps = [
  { key: 'pending', label: 'Pendiente', icon: 'üìã' },
  { key: 'confirmed', label: 'Confirmado', icon: '‚úÖ' },
  { key: 'processing', label: 'Procesando', icon: '‚öôÔ∏è' },
  { key: 'shipped', label: 'Enviado', icon: 'üöö' },
  { key: 'delivered', label: 'Entregado', icon: 'üì¶' },
];
const currentStepIndex = timelineSteps.findIndex(s => s.key === order.status);
const isCancelled = order.status === 'cancelled';
const isRefunded = order.status === 'refunded' || order.payment_status === 'refunded';
---

<AdminLayout title={`Pedido ${order.order_number} - Admin`}>
  <div class="space-y-6">
    {/* Header con bot√≥n volver */}
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <a
          href="/admin/pedidos"
          class="text-gray-400 hover:text-white transition-colors"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </a>
        <div>
          <h1 class="text-3xl font-bold text-white">Pedido {order.order_number}</h1>
          <p class="text-sm text-gray-500 mt-1">Creado el {formatDate(order.created_at)}</p>
        </div>
      </div>
      
      {/* Estado actual */}
      <div class="flex items-center space-x-3">
        <span class={`px-3 py-1.5 rounded-full text-sm font-medium ${currentPaymentStatus.color}`}>
          {currentPaymentStatus.label}
        </span>
        <span class={`px-3 py-1.5 rounded-full text-sm font-medium ${currentStatus.color}`}>
          {currentStatus.label}
        </span>
      </div>
    </div>

    {/* Timeline de progreso */}
    {!isCancelled && !isRefunded ? (
      <div class="bg-dark-surface rounded-xl border border-white/10 p-6">
        <div class="flex items-center">
          {timelineSteps.map((step, i) => (
            <>
              <div class="flex flex-col items-center flex-shrink-0">
                <div class={`w-10 h-10 rounded-full flex items-center justify-center text-base transition-all ${
                  i < currentStepIndex ? 'bg-emerald-500/20 text-emerald-400 ring-2 ring-emerald-500/30' :
                  i === currentStepIndex ? 'bg-accent-gold text-dark-bg ring-2 ring-accent-gold/50 shadow-lg shadow-accent-gold/20' :
                  'bg-white/5 text-gray-600 ring-1 ring-white/10'
                }`}>
                  {i < currentStepIndex ? (
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
                  ) : step.icon}
                </div>
                <span class={`text-xs mt-2 font-medium ${
                  i <= currentStepIndex ? 'text-white' : 'text-gray-600'
                }`}>{step.label}</span>
              </div>
              {i < timelineSteps.length - 1 && (
                <div class={`flex-1 h-0.5 mx-3 mt-[-1.25rem] rounded-full transition-all ${
                  i < currentStepIndex ? 'bg-emerald-500' : 'bg-white/10'
                }`}></div>
              )}
            </>
          ))}
        </div>
      </div>
    ) : isCancelled ? (
      <div class="bg-red-500/10 rounded-xl border border-red-500/30 p-5 flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center shrink-0">
          <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </div>
        <div>
          <p class="font-semibold text-red-400">Pedido Cancelado</p>
          <p class="text-sm text-red-300/70">Este pedido ha sido cancelado</p>
        </div>
      </div>
    ) : (
      <div class="bg-gray-500/10 rounded-xl border border-gray-500/30 p-5 flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full bg-gray-500/20 flex items-center justify-center shrink-0">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
        </div>
        <div>
          <p class="font-semibold text-gray-300">Pedido Reembolsado</p>
          <p class="text-sm text-gray-400">El dinero fue devuelto al cliente</p>
        </div>
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      {/* Columna izquierda - Productos */}
      <div class="lg:col-span-2 space-y-6">
        {/* Items del pedido */}
        <div class="bg-dark-surface rounded-xl border border-white/10 overflow-hidden">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Productos ({orderItems?.length || 0})</h2>
          </div>
          
          <div class="divide-y divide-white/5">
            {orderItems && orderItems.map((item: any) => (
              <div class="px-6 py-4 flex items-center space-x-4">
                {/* Imagen */}
                {item.product_image ? (
                  <img
                    src={item.product_image}
                    alt={item.product_name}
                    class="w-20 h-20 object-cover rounded-xl border border-white/10 shrink-0"
                  />
                ) : (
                  <div class="w-20 h-20 bg-dark-card rounded-xl flex items-center justify-center border border-white/10 shrink-0">
                    <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                  </div>
                )}
                
                {/* Info del producto */}
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-white">
                    {item.product_name}
                  </p>
                  <div class="flex items-center space-x-3 mt-1">
                    {item.product_sku && <span class="text-xs text-gray-500 font-mono bg-white/5 px-1.5 py-0.5 rounded">SKU: {item.product_sku}</span>}
                    {item.size && <span class="text-xs text-gray-400 bg-white/5 px-2 py-0.5 rounded-full">Talla: {item.size}</span>}
                  </div>
                </div>
                
                {/* Cantidad y precio */}
                <div class="text-right shrink-0">
                  <p class="text-sm text-gray-400">
                    {item.quantity} √ó {formatCurrency(item.price_per_unit || item.price)}
                  </p>
                  <p class="text-base font-semibold text-accent-gold">
                    {formatCurrency(item.total_price || item.subtotal)}
                  </p>
                </div>
              </div>
            ))}
          </div>
          
          {/* Totales */}
          <div class="px-6 py-4 bg-dark-card/50 border-t border-white/10 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-400">Subtotal:</span>
              <span class="text-white">{formatCurrency(order.subtotal)}</span>
            </div>
            {order.shipping_cost > 0 && (
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Env√≠o:</span>
                <span class="text-white">{formatCurrency(order.shipping_cost)}</span>
              </div>
            )}
            {order.tax > 0 && (
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">IVA:</span>
                <span class="text-white">{formatCurrency(order.tax)}</span>
              </div>
            )}
            {order.discount > 0 && (
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Descuento:</span>
                <span class="text-red-400">-{formatCurrency(order.discount)}</span>
              </div>
            )}
            <div class="flex justify-between text-base font-semibold pt-2 border-t border-white/10">
              <span class="text-white">Total:</span>
              <span class="text-accent-gold">{formatCurrency(order.total)}</span>
            </div>
          </div>
        </div>

        {/* Informaci√≥n de pago */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Informaci√≥n de Pago</h2>
          </div>
          <div class="px-6 py-4 space-y-3">
            <div class="flex justify-between">
              <span class="text-sm text-gray-400">M√©todo de pago:</span>
              <span class="text-sm text-white capitalize">{order.payment_method}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-400">Estado del pago:</span>
              <span class={`text-sm px-2 py-1 rounded ${currentPaymentStatus.color}`}>
                {currentPaymentStatus.label}
              </span>
            </div>
            {order.payment_id && (
              <div class="flex justify-between">
                <span class="text-sm text-gray-400">ID de pago:</span>
                <span class="text-sm text-white font-mono">{order.payment_id}</span>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Columna derecha - Informaci√≥n del cliente y gesti√≥n */}
      <div class="space-y-6">
        {/* Actualizar estado */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Gesti√≥n del Pedido</h2>
          </div>
          <div class="px-6 py-4">
            <form id="update-status-form" class="space-y-4">
              <div>
                <label for="status" class="block text-sm font-medium text-gray-400 mb-2">
                  Estado del pedido
                </label>
                <div class="relative">
                  <div id="status-indicator" class={`absolute left-3 top-1/2 -translate-y-1/2 w-3 h-3 rounded-full ${
                    order.status === 'pending' ? 'bg-yellow-400' :
                    order.status === 'confirmed' ? 'bg-blue-400' :
                    order.status === 'processing' ? 'bg-indigo-400' :
                    order.status === 'shipped' ? 'bg-purple-400' :
                    order.status === 'delivered' ? 'bg-emerald-400' :
                    order.status === 'cancelled' ? 'bg-red-400' :
                    order.status === 'refunded' ? 'bg-gray-400' : 'bg-gray-400'
                  }`}></div>
                  <select
                    id="status"
                    name="status"
                    class="w-full pl-9 pr-10 py-2.5 bg-dark-card border border-white/10 rounded-lg text-white focus:ring-2 focus:ring-accent-gold focus:border-transparent appearance-none cursor-pointer text-sm"
                  >
                    {statusOptions.map(option => (
                      <option value={option.value} selected={option.value === order.status}>
                        {option.label}
                      </option>
                    ))}
                  </select>
                  <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </div>

              <div>
                <label for="shipping_method" class="block text-sm font-medium text-gray-400 mb-2">
                  M√©todo de env√≠o
                </label>
                <input
                  type="text"
                  id="shipping_method"
                  name="shipping_method"
                  value={order.shipping_method || ''}
                  placeholder="Ej: SEUR, Correos Express"
                  class="w-full px-3 py-2.5 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent text-sm"
                />
              </div>

              <div>
                <label for="tracking_number" class="block text-sm font-medium text-gray-400 mb-2">
                  N√∫mero de seguimiento
                </label>
                <input
                  type="text"
                  id="tracking_number"
                  name="tracking_number"
                  value={order.tracking_number || ''}
                  placeholder="C√≥digo de tracking"
                  class="w-full px-3 py-2.5 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent text-sm font-mono"
                />
              </div>

              <div>
                <label for="admin_notes" class="block text-sm font-medium text-gray-400 mb-2">
                  Notas internas
                </label>
                <textarea
                  id="admin_notes"
                  name="admin_notes"
                  rows="3"
                  class="w-full px-3 py-2.5 bg-dark-card border border-white/10 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-accent-gold focus:border-transparent text-sm"
                  placeholder="Notas privadas del administrador"
                >{order.admin_notes || ''}</textarea>
              </div>

              <button
                type="submit"
                class="w-full bg-accent-gold text-dark-bg px-4 py-2.5 rounded-lg hover:bg-accent-gold/90 transition-colors font-medium"
              >
                Guardar cambios
              </button>
            </form>

            {/* Descargar factura */}
            <div class="mt-4 pt-4 border-t border-white/10">
              <a
                href={`/api/orders/${id}/invoice`}
                target="_blank"
                class="w-full flex items-center justify-center space-x-2 bg-white/5 border border-white/10 text-white px-4 py-2.5 rounded-lg hover:bg-white/10 transition-colors font-medium text-sm"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span>Descargar Factura PDF</span>
              </a>
            </div>
          </div>
        </div>

        {/* Zona de peligro - Reembolso */}
        {(order.payment_status === 'paid' && order.status !== 'refunded') && (
          <div class="bg-dark-surface rounded-xl border-2 border-red-500/30">
            <div class="px-6 py-4 border-b border-red-500/30 bg-red-500/10">
              <h2 class="text-lg font-semibold text-red-400">Zona de Peligro</h2>
            </div>
            <div class="px-6 py-4">
              <p class="text-sm text-gray-400 mb-4">
                El reembolso devolver√° el dinero al cliente mediante Stripe y recuperar√° el stock de los productos. Esta acci√≥n no se puede deshacer.
              </p>
              <button
                id="refund-button"
                type="button"
                class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium"
              >
                Procesar Reembolso
              </button>
            </div>
          </div>
        )}

        {/* Estado de reembolso */}
        {(order.status === 'refunded' || order.payment_status === 'refunded') && (
          <div class="bg-dark-surface rounded-xl border border-white/10">
            <div class="px-6 py-4 bg-emerald-500/10">
              <div class="flex items-center space-x-2">
                <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-lg font-semibold text-white">Pedido Reembolsado</h2>
              </div>
              <p class="text-sm text-gray-400 mt-2">
                Este pedido ha sido reembolsado. El dinero fue devuelto al cliente y el stock recuperado.
              </p>
            </div>
          </div>
        )}

        {/* Informaci√≥n del cliente */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Cliente</h2>
          </div>
          <div class="px-6 py-4 space-y-3">
            <div>
              <p class="text-sm text-gray-400">Nombre:</p>
              <p class="text-sm font-medium text-white">{order.shipping_full_name}</p>
            </div>
            {order.shipping_phone && (
              <div>
                <p class="text-sm text-gray-400">Tel√©fono:</p>
                <p class="text-sm text-white">{order.shipping_phone}</p>
              </div>
            )}
            {order.user_id && (
              <div>
                <p class="text-sm text-gray-400">ID Usuario:</p>
                <p class="text-xs text-gray-500 font-mono">{order.user_id}</p>
              </div>
            )}
          </div>
        </div>

        {/* Direcci√≥n de env√≠o */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Direcci√≥n de Env√≠o</h2>
          </div>
          <div class="px-6 py-4">
            <address class="text-sm text-gray-300 not-italic space-y-1">
              <p class="font-medium">{order.shipping_full_name}</p>
              <p>{order.shipping_address_line1}</p>
              {order.shipping_address_line2 && <p>{order.shipping_address_line2}</p>}
              <p>{order.shipping_postal_code} {order.shipping_city}</p>
              {order.shipping_state && <p>{order.shipping_state}</p>}
              <p class="uppercase">{order.shipping_country}</p>
            </address>
          </div>
        </div>

        {/* Notas del cliente */}
        {order.customer_notes && (
          <div class="bg-dark-surface rounded-xl border border-white/10">
            <div class="px-6 py-4 border-b border-white/10">
              <h2 class="text-lg font-semibold text-white">Notas del Cliente</h2>
            </div>
            <div class="px-6 py-4">
              <p class="text-sm text-gray-300">{order.customer_notes}</p>
            </div>
          </div>
        )}

        {/* Timestamps */}
        <div class="bg-dark-surface rounded-xl border border-white/10">
          <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Historial</h2>
          </div>
          <div class="px-6 py-4 space-y-2 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-400">Creado:</span>
              <span class="text-white">{formatDate(order.created_at)}</span>
            </div>
            {order.updated_at && order.updated_at !== order.created_at && (
              <div class="flex justify-between">
                <span class="text-gray-400">Actualizado:</span>
                <span class="text-white">{formatDate(order.updated_at)}</span>
              </div>
            )}
            {order.shipped_at && (
              <div class="flex justify-between">
                <span class="text-gray-400">Enviado:</span>
                <span class="text-white">{formatDate(order.shipped_at)}</span>
              </div>
            )}
            {order.delivered_at && (
              <div class="flex justify-between">
                <span class="text-gray-400">Entregado:</span>
                <span class="text-white">{formatDate(order.delivered_at)}</span>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { customConfirm, customAlert } from '../../../lib/notifications';

    // Mapa de colores para el indicador del select
    const statusColors: Record<string, string> = {
      pending: 'bg-yellow-400',
      confirmed: 'bg-blue-400',
      processing: 'bg-indigo-400',
      shipped: 'bg-purple-400',
      delivered: 'bg-emerald-400',
      cancelled: 'bg-red-400',
      refunded: 'bg-gray-400'
    };

    // Actualizar indicador de color al cambiar el select
    document.getElementById('status')?.addEventListener('change', (e) => {
      const value = (e.target as HTMLSelectElement).value;
      const indicator = document.getElementById('status-indicator');
      if (indicator) {
        // Remove all color classes and add the new one
        Object.values(statusColors).forEach(c => indicator.classList.remove(c));
        indicator.classList.add(statusColors[value] || 'bg-gray-400');
      }
    });
    
    // Actualizar estado del pedido
    document.getElementById('update-status-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const button = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      
      // Deshabilitar bot√≥n y mostrar loading
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Guardando...';
      
      try {
        const response = await fetch(`/api/orders/${window.location.pathname.split('/').pop()}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            status: formData.get('status'),
            shipping_method: formData.get('shipping_method') || null,
            tracking_number: formData.get('tracking_number') || null,
            admin_notes: formData.get('admin_notes') || null,
          }),
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Recargar p√°gina para ver cambios
          window.location.reload();
        } else {
          customAlert('Error al actualizar: ' + result.error, 'error');
          button.disabled = false;
          button.textContent = originalText;
        }
      } catch (error) {
        console.error('Error:', error);
        customAlert('Error al actualizar el pedido', 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    });

    // Procesar reembolso
    document.getElementById('refund-button')?.addEventListener('click', async (e) => {
      const button = e.target as HTMLButtonElement;
      
      // Confirmaci√≥n
      const confirmRefund = await customConfirm(
        '¬øEst√°s seguro de que quieres reembolsar este pedido?\n\n' +
        'Esta acci√≥n:\n' +
        '‚Ä¢ Devolver√° el dinero al cliente mediante Stripe\n' +
        '‚Ä¢ Recuperar√° el stock de los productos\n' +
        '‚Ä¢ NO se puede deshacer\n\n' +
        '¬øDeseas continuar?',
        {
          title: 'Procesar reembolso',
          confirmText: 'S√≠, reembolsar',
          cancelText: 'Cancelar',
          type: 'danger'
        }
      );
      
      if (!confirmRefund) return;
      
      // Deshabilitar bot√≥n y mostrar loading
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Procesando reembolso...';
      
      try {
        const response = await fetch(`/api/orders/${window.location.pathname.split('/').pop()}/refund`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        
        const result = await response.json();
        
        if (result.success) {
          customAlert(`Reembolso procesado correctamente\n\nID: ${result.refund.id}\nMonto: ‚Ç¨${result.refund.amount}`, 'success');
          // Recargar p√°gina para ver cambios
          setTimeout(() => window.location.reload(), 2000);
        } else {
          customAlert('Error al procesar reembolso:\n\n' + result.error, 'error');
          button.disabled = false;
          button.textContent = originalText;
        }
      } catch (error) {
        console.error('Error:', error);
        customAlert('Error al procesar el reembolso', 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    });
  </script>
</AdminLayout>
