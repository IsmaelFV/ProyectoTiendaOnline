---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .order('name');
---

<AdminLayout title="Nuevo Producto - Admin">
  <div class="mb-8">
    <a href="/internal-admin/productos" class="text-brand-slate hover:text-brand-navy mb-4 inline-block">
      ← Volver a productos
    </a>
    <h1 class="font-serif text-3xl font-bold text-brand-navy mb-2">
      Nuevo Producto
    </h1>
    <p class="text-brand-slate">
      Añade un nuevo producto al catálogo
    </p>
  </div>

  <div class="bg-white rounded-lg shadow p-8 max-w-4xl">
    <form action="/api/products/create" method="POST" enctype="multipart/form-data" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="name" class="block text-sm font-medium text-brand-charcoal mb-2">
            Nombre del Producto *
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="input-field"
            placeholder="Ej: Camisa Oxford Blanca"
          />
        </div>

        <div>
          <label for="category_id" class="block text-sm font-medium text-brand-charcoal mb-2">
            Categoría *
          </label>
          <select id="category_id" name="category_id" required class="input-field">
            <option value="">Seleccionar categoría</option>
            {categories?.map((category) => (
              <option value={category.id}>{category.name}</option>
            ))}
          </select>
        </div>
      </div>

      <div>
        <label for="description" class="block text-sm font-medium text-brand-charcoal mb-2">
          Descripción
        </label>
        <textarea
          id="description"
          name="description"
          rows="4"
          class="input-field"
          placeholder="Descripción detallada del producto..."
        ></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="price" class="block text-sm font-medium text-brand-charcoal mb-2">
            Precio (€) *
          </label>
          <input
            type="number"
            id="price"
            name="price"
            required
            min="0"
            step="0.01"
            class="input-field"
            placeholder="89.99"
          />
          <p class="text-xs text-brand-slate mt-1">El precio se guardará en céntimos</p>
        </div>

        <div>
          <label for="stock" class="block text-sm font-medium text-brand-charcoal mb-2">
            Stock *
          </label>
          <input
            type="number"
            id="stock"
            name="stock"
            required
            min="0"
            class="input-field"
            placeholder="25"
          />
        </div>
      </div>

      <div>
        <label for="sizes" class="block text-sm font-medium text-brand-charcoal mb-2">
          Tallas Disponibles *
        </label>
        <input
          type="text"
          id="sizes"
          name="sizes"
          required
          class="input-field"
          placeholder="S, M, L, XL, XXL"
        />
        <p class="text-xs text-brand-slate mt-1">Separar por comas</p>
      </div>

      <div>
        <label for="images" class="block text-sm font-medium text-brand-charcoal mb-2">
          URLs de Imágenes
        </label>
        <textarea
          id="images"
          name="images"
          rows="3"
          class="input-field"
          placeholder="https://ejemplo.com/imagen1.jpg&#10;https://ejemplo.com/imagen2.jpg"
        ></textarea>
        <p class="text-xs text-brand-slate mt-1">Una URL por línea. Sube las imágenes a Supabase Storage primero.</p>
      </div>

      <div class="flex items-center">
        <input
          type="checkbox"
          id="featured"
          name="featured"
          class="w-4 h-4 text-brand-navy border-brand-slate/30 rounded focus:ring-brand-gold"
        />
        <label for="featured" class="ml-2 text-sm text-brand-charcoal">
          Producto destacado (aparecerá en la página principal)
        </label>
      </div>

      <div class="flex gap-4 pt-4 border-t">
        <button type="submit" class="btn btn-primary">
          Crear Producto
        </button>
        <a href="/internal-admin/productos" class="btn btn-secondary">
          Cancelar
        </a>
      </div>
    </form>
  </div>
</AdminLayout>

<script>
  const form = document.querySelector('form');
  const priceInput = document.getElementById('price') as HTMLInputElement;
  
  form?.addEventListener('submit', (e) => {
    if (priceInput) {
      const priceInEuros = parseFloat(priceInput.value);
      const priceInCents = Math.round(priceInEuros * 100);
      priceInput.value = priceInCents.toString();
    }
  });
</script>
