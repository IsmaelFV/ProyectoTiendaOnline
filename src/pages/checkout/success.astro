---
import PublicLayout from '../../layouts/PublicLayout.astro';
import Stripe from 'stripe';

const stripe = new Stripe(import.meta.env.STRIPE_SECRET_KEY || '', {
  apiVersion: '2025-12-15.clover',
});

// Obtener session_id de la URL
const sessionId = Astro.url.searchParams.get('session_id');

let orderNumber = '';
let customerEmail = '';
let totalAmount = 0;

if (sessionId) {
  try {
    // Recuperar información de la sesión
    const session = await stripe.checkout.sessions.retrieve(sessionId);
    orderNumber = session.metadata?.order_number || 'N/A';
    customerEmail = session.customer_email || session.customer_details?.email || '';
    totalAmount = session.amount_total || 0;
  } catch (error) {
    console.error('Error retrieving session:', error);
  }
}
---

<PublicLayout title="¡Pedido Confirmado!">
  <div class="min-h-screen py-16 relative overflow-hidden">
    <!-- Background effects -->
    <div class="absolute inset-0 bg-gradient-dark"></div>
    <div class="absolute top-1/4 left-1/3 w-[400px] h-[400px] bg-emerald-500/20 rounded-full blur-[120px]"></div>
    <div class="absolute bottom-1/4 right-1/3 w-[300px] h-[300px] bg-accent-teal/15 rounded-full blur-[100px]"></div>
    
    <div class="relative max-w-3xl mx-auto px-4">
      <!-- Icono de éxito -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-emerald-500/20 border border-emerald-500/30 rounded-full mb-6">
          <svg class="w-12 h-12 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h1 class="text-4xl font-bold text-white font-serif mb-2">¡Pedido Confirmado!</h1>
        <p class="text-xl text-gray-400">Gracias por tu compra</p>
      </div>

      <!-- Tarjeta de información -->
      <div class="glass-panel p-8 mb-6">
        <div class="border-b border-white/10 pb-6 mb-6">
          <h2 class="text-2xl font-semibold text-white mb-4">Detalles del pedido</h2>
          
          {sessionId ? (
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <span class="text-gray-400">Número de pedido:</span>
                <span class="font-mono font-semibold text-accent-gold">{orderNumber || `#${sessionId.slice(-8).toUpperCase()}`}</span>
              </div>
              
              {customerEmail && (
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Email de confirmación:</span>
                  <span class="font-medium text-white">{customerEmail}</span>
                </div>
              )}
              
              {totalAmount > 0 && (
                <div class="flex justify-between items-center text-lg">
                  <span class="text-gray-400">Total pagado:</span>
                  <span class="font-bold text-gradient">
                    {new Intl.NumberFormat('es-ES', {
                      style: 'currency',
                      currency: 'EUR'
                    }).format(totalAmount / 100)}
                  </span>
                </div>
              )}
            </div>
          ) : (
            <div class="text-center py-4">
              <p class="text-gray-400">Procesando información del pedido...</p>
            </div>
          )}
        </div>

        <!-- Qué sigue -->
        <div>
          <h3 class="text-lg font-semibold text-white mb-4">¿Qué sigue?</h3>
          <div class="space-y-3">
            <div class="flex items-start">
              <div class="flex-shrink-0">
                <div class="flex items-center justify-center w-8 h-8 bg-accent-teal/30 border border-accent-teal/50 rounded-full">
                  <span class="text-accent-glow font-semibold text-sm">1</span>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-gray-300">
                  Recibirás un <strong class="text-white">email de confirmación</strong> en los próximos minutos con todos los detalles.
                </p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="flex-shrink-0">
                <div class="flex items-center justify-center w-8 h-8 bg-accent-teal/30 border border-accent-teal/50 rounded-full">
                  <span class="text-blue-600 font-semibold text-sm">2</span>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-gray-700">
                  Preparamos tu pedido cuidadosamente. El <strong>envío estimado</strong> es de 3-5 días laborables.
                </p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="flex-shrink-0">
                <div class="flex items-center justify-center w-8 h-8 bg-blue-100 rounded-full">
                  <span class="text-blue-600 font-semibold text-sm">3</span>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-gray-700">
                  Te enviaremos un <strong>número de seguimiento</strong> para que puedas rastrear tu paquete.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones -->
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="/"
          class="inline-flex items-center justify-center px-6 py-3 bg-brand-gold text-white font-semibold rounded-md hover:bg-yellow-600 transition-colors"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
          </svg>
          Volver al inicio
        </a>

        <a
          href="/productos"
          class="inline-flex items-center justify-center px-6 py-3 bg-white text-gray-700 font-semibold rounded-md border-2 border-gray-300 hover:border-brand-gold transition-colors"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
          Seguir comprando
        </a>
      </div>

      <!-- Ayuda -->
      <div class="text-center mt-8">
        <p class="text-gray-600 mb-2">¿Necesitas ayuda?</p>
        <a href="mailto:soporte@tutienda.com" class="text-brand-gold hover:text-yellow-600 font-medium">
          Contacta con nuestro equipo de soporte
        </a>
      </div>
    </div>
  </div>
</PublicLayout>
