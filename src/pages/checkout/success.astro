---
import PublicLayout from '../../layouts/PublicLayout.astro';
import Stripe from 'stripe';
import { createClient } from '@supabase/supabase-js';
import { generateInvoicePDF } from '../../lib/invoice-pdf';
import { sendInvoiceEmail } from '../../lib/brevo';

const stripe = new Stripe(import.meta.env.STRIPE_SECRET_KEY || '', {
  apiVersion: '2025-12-15.clover',
});

const supabaseAdmin = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_ROLE_KEY,
  {
    auth: { autoRefreshToken: false, persistSession: false }
  }
);

// Obtener session_id de la URL
const sessionId = Astro.url.searchParams.get('session_id');

let orderNumber = '';
let customerEmail = '';
let totalAmount = 0;
let orderStatus = 'unknown';

if (sessionId) {
  try {
    // 1. Recuperar sesion de Stripe
    const session = await stripe.checkout.sessions.retrieve(sessionId, {
      expand: ['line_items', 'line_items.data.price.product']
    });
    
    customerEmail = session.customer_email || session.customer_details?.email || '';
    totalAmount = session.amount_total || 0;

    // 2. Verificar si el pedido ya existe
    const { data: existingOrder } = await supabaseAdmin
      .from('orders')
      .select('id, order_number, status')
      .or(`payment_id.eq.${session.payment_intent},admin_notes.ilike.%${sessionId}%`)
      .maybeSingle();

    if (existingOrder) {
      // El webhook ya lo creo
      orderNumber = existingOrder.order_number;
      orderStatus = 'exists';
      console.log(`[SUCCESS] Pedido ya existe: ${orderNumber}`);
    } else if (session.payment_status === 'paid') {
      // FALLBACK: El webhook no creo el pedido, crearlo aqui
      console.log('[SUCCESS] Pedido NO encontrado, creando como fallback...');
      
      const { user_id, discount_code } = session.metadata || {};

      let orderItemsSizes: Array<{ id: string; size: string; qty: number }> = [];
      try {
        if (session.metadata?.order_items_sizes) {
          orderItemsSizes = JSON.parse(session.metadata.order_items_sizes);
        }
      } catch (e) { /* ignorar */ }

      // Obtener line_items
      let lineItems = session.line_items?.data || [];
      if (lineItems.length === 0) {
        const fetchedItems = await stripe.checkout.sessions.listLineItems(sessionId, {
          expand: ['data.price.product']
        });
        lineItems = fetchedItems.data;
      }

      const subtotalCents = lineItems.reduce((sum, item) => {
        return sum + ((item.price?.unit_amount || 0) * (item.quantity || 1));
      }, 0);
      const totalCents = session.amount_total || 0;
      const taxCents = session.total_details?.amount_tax || 0;
      const shippingCents = session.total_details?.amount_shipping || 0;
      const discountCents = session.total_details?.amount_discount || 0;

      // Generar order_number desde codigo (por si el trigger no existe en la BD)
      const yearNow = new Date().getFullYear();
      const rndSuffix = Math.random().toString(36).substring(2, 8).toUpperCase();
      const fallbackOrderNum = `ORD-${yearNow}-${Date.now().toString().slice(-6)}-${rndSuffix}`;

      const orderData = {
        order_number: fallbackOrderNum,
        user_id: (user_id && user_id !== 'guest') ? user_id : null,
        shipping_full_name: session.customer_details?.name || 'Cliente',
        shipping_phone: session.customer_details?.phone || '',
        shipping_address_line1: session.customer_details?.address?.line1 || 'Direccion no proporcionada',
        shipping_address_line2: session.customer_details?.address?.line2 || null,
        shipping_city: session.customer_details?.address?.city || 'Ciudad',
        shipping_state: session.customer_details?.address?.state || '',
        shipping_postal_code: session.customer_details?.address?.postal_code || '00000',
        shipping_country: session.customer_details?.address?.country || 'ES',
        subtotal: subtotalCents / 100,
        shipping_cost: shippingCents / 100,
        tax: taxCents / 100,
        discount: discountCents / 100,
        total: totalCents / 100,
        payment_method: 'card',
        payment_status: 'paid',
        payment_id: session.payment_intent as string,
        status: 'confirmed',
        customer_notes: discount_code ? `Codigo aplicado: ${discount_code}` : null,
        admin_notes: `[FALLBACK] Stripe Session: ${session.id} | Email: ${customerEmail}`,
      };

      const { data: order, error: orderError } = await supabaseAdmin
        .from('orders')
        .insert(orderData)
        .select()
        .single();

      if (orderError) {
        console.error('[SUCCESS] Error creando pedido:', orderError);
        orderStatus = 'error';
      } else {
        orderNumber = order.order_number;
        orderStatus = 'created';
        console.log(`[SUCCESS] Pedido creado (fallback): ${orderNumber}`);

        // Crear order_items y decrementar stock
        const successProductImages: Map<string, string> = new Map();
        for (const lineItem of lineItems) {
          const productName = lineItem.description || 'Producto';
          const quantity = lineItem.quantity || 1;
          const pricePerUnit = lineItem.price?.unit_amount || 0;

          const { data: product } = await supabaseAdmin
            .from('products')
            .select('id, slug, sku, images, stock, stock_by_size')
            .eq('name', productName)
            .maybeSingle();

          if (product?.id) {
            const productImage = product.images?.[0] || null;
            if (productImage) {
              successProductImages.set(productName, productImage);
            }
            const itemSizeInfo = orderItemsSizes.find(oi => oi.id === product.id);
            const itemSize = itemSizeInfo?.size || 'Unica';

            await supabaseAdmin
              .from('order_items')
              .insert({
                order_id: order.id,
                product_id: product.id,
                product_name: productName,
                product_slug: product.slug,
                product_image: product.images?.[0] || null,
                size: itemSize,
                color: null,
                price: pricePerUnit / 100,
                quantity: quantity,
                subtotal: (pricePerUnit * quantity) / 100,
              });

            // Decrementar stock
            const newStock = Math.max(0, (product.stock || 0) - quantity);
            const updateData: any = { 
              stock: newStock,
              updated_at: new Date().toISOString()
            };
            
            if (product.stock_by_size && typeof product.stock_by_size === 'object') {
              const sizeStock = product.stock_by_size as Record<string, number>;
              if (itemSize in sizeStock) {
                sizeStock[itemSize] = Math.max(0, (sizeStock[itemSize] || 0) - quantity);
                updateData.stock_by_size = sizeStock;
              }
            }

            await supabaseAdmin
              .from('products')
              .update(updateData)
              .eq('id', product.id);
          }
        }

        // Enviar email de factura
        try {
          if (customerEmail) {
            const customerName = session.customer_details?.name || 'Cliente';
            const invoiceItems = lineItems.map(item => ({
              name: item.description || 'Producto',
              quantity: item.quantity || 1,
              price: item.price?.unit_amount || 0,
              total: (item.price?.unit_amount || 0) * (item.quantity || 1),
              image: successProductImages.get(item.description || '') || undefined
            }));

            const shippingAddress = session.customer_details?.address 
              ? `${session.customer_details.address.line1 || ''}${session.customer_details.address.line2 ? ', ' + session.customer_details.address.line2 : ''}, ${session.customer_details.address.city || ''}, ${session.customer_details.address.postal_code || ''}, ${session.customer_details.address.country || ''}`
              : 'Direccion no proporcionada';

            const pdfBase64 = await generateInvoicePDF({
              orderNumber: order.order_number,
              orderDate: new Date().toISOString(),
              customerName,
              customerEmail,
              shippingAddress,
              items: invoiceItems,
              subtotal: subtotalCents,
              shipping: shippingCents,
              tax: taxCents,
              total: totalCents
            });

            await sendInvoiceEmail({
              to: customerEmail,
              customerName,
              orderNumber: order.order_number,
              pdfBase64,
              items: invoiceItems
            });
            console.log(`[SUCCESS] Factura enviada a ${customerEmail}`);
          }
        } catch (emailErr: any) {
          console.error('[SUCCESS] Error enviando email:', emailErr.message);
        }
      }
    } else {
      orderStatus = 'pending';
    }
  } catch (error) {
    console.error('[SUCCESS] Error:', error);
    orderStatus = 'error';
  }
}
---

<PublicLayout title="¡Pedido Confirmado!">
  <div class="min-h-screen py-16 relative overflow-hidden">
    <!-- Background effects -->
    <div class="absolute inset-0 bg-gradient-dark"></div>
    <div class="absolute top-1/4 left-1/3 w-[400px] h-[400px] bg-emerald-500/20 rounded-full blur-[120px]"></div>
    <div class="absolute bottom-1/4 right-1/3 w-[300px] h-[300px] bg-accent-teal/15 rounded-full blur-[100px]"></div>
    
    <div class="relative max-w-3xl mx-auto px-4">
      <!-- Icono de éxito -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-emerald-500/20 border border-emerald-500/30 rounded-full mb-6">
          <svg class="w-12 h-12 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h1 class="text-4xl font-bold text-white font-serif mb-2">¡Pedido Confirmado!</h1>
        <p class="text-xl text-gray-400">Gracias por tu compra</p>
      </div>

      <!-- Tarjeta de información -->
      <div class="glass-panel p-8 mb-6">
        <div class="border-b border-white/10 pb-6 mb-6">
          <h2 class="text-2xl font-semibold text-white mb-4">Detalles del pedido</h2>
          
          {sessionId ? (
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <span class="text-gray-400">Número de pedido:</span>
                <span class="font-mono font-semibold text-accent-gold">{orderNumber || `#${sessionId.slice(-8).toUpperCase()}`}</span>
              </div>
              
              {customerEmail && (
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Email de confirmación:</span>
                  <span class="font-medium text-white">{customerEmail}</span>
                </div>
              )}
              
              {totalAmount > 0 && (
                <div class="flex justify-between items-center text-lg">
                  <span class="text-gray-400">Total pagado:</span>
                  <span class="font-bold text-gradient">
                    {new Intl.NumberFormat('es-ES', {
                      style: 'currency',
                      currency: 'EUR'
                    }).format(totalAmount / 100)}
                  </span>
                </div>
              )}
            </div>
          ) : (
            <div class="text-center py-4">
              <p class="text-gray-400">Procesando información del pedido...</p>
            </div>
          )}
        </div>

        <!-- Qué sigue -->
        <div>
          <h3 class="text-lg font-semibold text-white mb-4">¿Qué sigue?</h3>
          <div class="space-y-3">
            <div class="flex items-start">
              <div class="flex-shrink-0">
                <div class="flex items-center justify-center w-8 h-8 bg-accent-teal/30 border border-accent-teal/50 rounded-full">
                  <span class="text-accent-glow font-semibold text-sm">1</span>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-gray-300">
                  Recibirás un <strong class="text-white">email de confirmación</strong> en los próximos minutos con todos los detalles.
                </p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="flex-shrink-0">
                <div class="flex items-center justify-center w-8 h-8 bg-accent-teal/30 border border-accent-teal/50 rounded-full">
                  <span class="text-blue-600 font-semibold text-sm">2</span>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-gray-700">
                  Preparamos tu pedido cuidadosamente. El <strong>envío estimado</strong> es de 3-5 días laborables.
                </p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="flex-shrink-0">
                <div class="flex items-center justify-center w-8 h-8 bg-blue-100 rounded-full">
                  <span class="text-blue-600 font-semibold text-sm">3</span>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-gray-700">
                  Te enviaremos un <strong>número de seguimiento</strong> para que puedas rastrear tu paquete.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones -->
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="/"
          class="inline-flex items-center justify-center px-6 py-3 bg-brand-gold text-white font-semibold rounded-md hover:bg-yellow-600 transition-colors"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
          </svg>
          Volver al inicio
        </a>

        <a
          href="/productos"
          class="inline-flex items-center justify-center px-6 py-3 bg-white text-gray-700 font-semibold rounded-md border-2 border-gray-300 hover:border-brand-gold transition-colors"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
          Seguir comprando
        </a>
      </div>

      <!-- Ayuda -->
      <div class="text-center mt-8">
        <p class="text-gray-600 mb-2">¿Necesitas ayuda?</p>
        <a href="mailto:soporte@tutienda.com" class="text-brand-gold hover:text-yellow-600 font-medium">
          Contacta con nuestro equipo de soporte
        </a>
      </div>
    </div>
  </div>

  <!-- Limpiar carrito tras pago exitoso -->
  <script>
    // Limpiar el carrito del lado cliente ahora que el pago se ha confirmado
    try {
      // 1. Limpiar todas las claves de carrito en localStorage
      const keysToRemove: string[] = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.startsWith('cart:guest:') || key === 'cart')) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));

      // 2. Para usuarios autenticados: limpiar carrito en Supabase via API
      const { createClient } = await import('@supabase/supabase-js');
      const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
      const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
      const supabase = createClient(supabaseUrl, supabaseAnonKey);
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session?.user?.id) {
        const { error: clearError } = await supabase.rpc('clear_cart', { p_user_id: session.user.id });
        if (clearError) console.warn('[SUCCESS] Error al limpiar carrito en DB:', clearError.message);
      }

      // 3. Disparar evento storage para que nanostores se actualice
      window.dispatchEvent(new Event('storage'));
      
      console.log('[SUCCESS] Carrito limpiado tras pago exitoso');
    } catch (e) {
      console.warn('[SUCCESS] Error al limpiar carrito:', e);
    }
  </script>
</PublicLayout>
