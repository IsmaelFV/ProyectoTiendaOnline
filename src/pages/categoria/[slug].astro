---
import PublicLayout from '@layouts/PublicLayout.astro';
import ProductCard from '@components/product/ProductCard.astro';
import { supabase } from '@lib/supabase';

export async function getStaticPaths() {
  const { data: categories } = await supabase
    .from('categories')
    .select('*');

  return categories?.map((category) => ({
    params: { slug: category.slug },
    props: { category },
  })) || [];
}

// Obtener el slug de la URL
const { slug } = Astro.params;

// Obtener la categoría desde props (SSG) o desde la base de datos (SSR)
let category = Astro.props.category;

// Si no hay category en props, buscarla en la base de datos (modo SSR)
if (!category) {
  const { data } = await supabase
    .from('categories')
    .select('*')
    .eq('slug', slug)
    .single();
  
  category = data;
}

// Si la categoría no existe, devolver 404
if (!category) {
  return Astro.redirect('/404');
}

const { data: products } = await supabase
  .from('products')
  .select('*')
  .eq('category_id', category.id)
  .order('created_at', { ascending: false });

const { data: allCategories } = await supabase
  .from('categories')
  .select('*')
  .order('name');
---

<PublicLayout 
  title={`${category.name} - Fashion Store`}
  description={category.description}
>
  <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="mb-12">
      <h1 class="font-serif text-4xl md:text-5xl font-bold text-brand-navy mb-4">
        {category.name}
      </h1>
      {category.description && (
        <p class="text-lg text-brand-slate">
          {category.description}
        </p>
      )}
    </div>

    {allCategories && allCategories.length > 0 && (
      <div class="mb-8 flex flex-wrap gap-4">
        <a
          href="/productos"
          class="px-6 py-2 border-2 border-brand-slate/30 hover:border-brand-navy transition-colors font-medium"
        >
          Todos
        </a>
        {allCategories.map((cat) => (
          <a
            href={`/categoria/${cat.slug}`}
            class={`px-6 py-2 border-2 font-medium transition-colors ${
              cat.id === category.id
                ? 'border-brand-navy bg-brand-navy text-white'
                : 'border-brand-slate/30 hover:border-brand-navy'
            }`}
          >
            {cat.name}
          </a>
        ))}
      </div>
    )}

    {products && products.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        {products.map((product) => (
          <ProductCard product={product} />
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-brand-slate text-lg">
          No hay productos disponibles en esta categoría.
        </p>
        <a href="/productos" class="inline-block mt-4 btn-secondary">
          Ver Todos los Productos
        </a>
      </div>
    )}
  </div>
</PublicLayout>
