---
import PublicLayout from '@layouts/PublicLayout.astro';
import ProductCard from '@components/product/ProductCard.astro';
import { supabase } from '@lib/supabase';

export async function getStaticPaths() {
  const { data: categories } = await supabase
    .from('categories')
    .select('*');

  return categories?.map((category) => ({
    params: { slug: category.slug },
    props: { category },
  })) || [];
}

// Obtener el slug de la URL
const { slug } = Astro.params;

// Obtener la categoría desde props (SSG) o desde la base de datos (SSR)
let category = Astro.props.category;

// Si no hay category en props, buscarla en la base de datos (modo SSR)
if (!category) {
  const { data } = await supabase
    .from('categories')
    .select('*')
    .eq('slug', slug)
    .single();
  
  category = data;
}

// Si la categoría no existe, devolver 404
if (!category) {
  return Astro.redirect('/404');
}

const { data: products } = await supabase
  .from('products')
  .select('*')
  .eq('category_id', category.id)
  .eq('is_active', true)
  .order('created_at', { ascending: false });

// Obtener categorías del mismo género para navegación lateral
const { data: allCategories } = await supabase
  .from('categories')
  .select('id, name, slug, level, parent_id, gender_id')
  .eq('is_active', true)
  .order('display_order');

// Encontrar categorías relacionadas (mismo género o misma categoría padre)
const sameLevelCats = (allCategories || []).filter(c => 
  c.gender_id === category.gender_id && c.level === category.level
);

// Deduplicar por nombre base (quitar sufijos "Mujer"/"Hombre")
const clean = (name: string) => name.replace(/\s+(Mujer|Hombre)$/i, '').trim();
const seen = new Map<string, any>();
for (const c of sameLevelCats) {
  const baseName = clean(c.name).toLowerCase();
  if (!seen.has(baseName)) {
    seen.set(baseName, c);
  }
}
const relatedCategories = Array.from(seen.values()).slice(0, 12);

// Si la categoría tiene parent (nivel 2), buscar hermanas
let siblingCategories: any[] = [];
if (category.parent_id) {
  siblingCategories = (allCategories || []).filter(c => 
    c.parent_id === category.parent_id && c.id !== category.id
  );
}

// Si la categoría es nivel 1, buscar hijas
let childCategories: any[] = [];
if (category.level === 1) {
  childCategories = (allCategories || []).filter(c => 
    c.parent_id === category.id
  );
}

// Elegir qué categorías mostrar: hermanas > hijas > relacionadas
const displayCategories = siblingCategories.length > 0 
  ? siblingCategories 
  : childCategories.length > 0 
    ? childCategories 
    : relatedCategories.filter(c => c.id !== category.id);
---

<PublicLayout 
  title={`${category.name} - Fashion Store`}
  description={category.description}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
    
    {/* Breadcrumb */}
    <nav class="flex items-center gap-2 text-sm text-gray-500 mb-6">
      <a href="/" class="hover:text-accent-gold transition-colors">Inicio</a>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      <a href="/productos" class="hover:text-accent-gold transition-colors">Productos</a>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      <span class="text-gray-300">{category.name}</span>
    </nav>

    <div class="mb-8">
      <h1 class="font-serif text-3xl sm:text-4xl font-bold text-white mb-2">
        {category.name}
      </h1>
      {category.description && (
        <p class="text-gray-400">
          {category.description}
        </p>
      )}
      <p class="text-sm text-gray-500 mt-2">
        {products?.length || 0} producto{(products?.length || 0) !== 1 ? 's' : ''}
      </p>
    </div>

    {/* Categorías relacionadas - máximo unas pocas, estilo limpio */}
    {displayCategories.length > 0 && (
      <div class="mb-8 flex items-center gap-3 overflow-x-auto pb-2 scrollbar-hide">
        <a
          href="/productos"
          class="shrink-0 px-4 py-2 rounded-full text-sm font-medium border border-white/10 text-gray-400 hover:border-accent-gold/30 hover:text-white transition-all"
        >
          Todos
        </a>
        {displayCategories.slice(0, 8).map((cat: any) => (
          <a
            href={`/categoria/${cat.slug}`}
            class={`shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all ${
              cat.id === category.id
                ? 'bg-accent-gold text-dark-bg'
                : 'border border-white/10 text-gray-400 hover:border-accent-gold/30 hover:text-white'
            }`}
          >
            {clean(cat.name)}
          </a>
        ))}
      </div>
    )}

    {/* Grid de productos */}
    {products && products.length > 0 ? (
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6">
        {products.map((product) => (
          <ProductCard product={product} />
        ))}
      </div>
    ) : (
      <div class="text-center py-20">
        <div class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-dark-card/50 border border-white/5 flex items-center justify-center">
          <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-white mb-3">Sin productos</h2>
        <p class="text-gray-400 mb-6">No hay productos disponibles en esta categoría.</p>
        <a href="/productos" class="btn btn-primary">
          Ver todos los productos
        </a>
      </div>
    )}
  </div>
</PublicLayout>
