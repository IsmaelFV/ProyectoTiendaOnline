---
/**
 * ============================================================================
 * P√°gina: Productos con Filtros Avanzados
 * ============================================================================
 */

import PublicLayout from '@layouts/PublicLayout.astro';
import ProductCard from '@components/product/ProductCard.astro';
import { supabase } from '@lib/supabase';
import type { Product } from '@lib/supabase';

// Par√°metros de filtros desde URL
const url = new URL(Astro.request.url);
const categorySlug = url.searchParams.get('categoria');
const genderSlug = url.searchParams.get('genero');
const minPrice = url.searchParams.get('precio_min');
const maxPrice = url.searchParams.get('precio_max');
const sortBy = url.searchParams.get('ordenar') || 'newest';
const isOnSale = url.searchParams.get('rebaja') === 'true';
const isNew = url.searchParams.get('nuevo') === 'true';
const page = parseInt(url.searchParams.get('pagina') || '1');
const itemsPerPage = 24;
const offset = (page - 1) * itemsPerPage;
const colorSlug = url.searchParams.get('color');
const size = url.searchParams.get('talla');
const material = url.searchParams.get('material');

// Si hay filtro de categor√≠a, obtener IDs de productos usando product_categories
let productIdsFromCategory: string[] | null = null;
if (categorySlug) {
  const { data: cat } = await supabase.from('categories').select('id').eq('slug', categorySlug).single();
  if (cat) {
    const { data: relations } = await supabase
      .from('product_categories')
      .select('product_id')
      .eq('category_id', cat.id);
    productIdsFromCategory = (relations || []).map(rel => rel.product_id);
  }
}

// Construir query con filtros
let query = supabase
  .from('products')
  .select(`*, category:categories(name, slug), gender:genders(name, slug)`);

// Aplicar filtro de categor√≠a si existe
if (productIdsFromCategory !== null) {
  if (productIdsFromCategory.length > 0) {
    query = query.in('id', productIdsFromCategory);
  } else {
    // Si no hay productos en la categor√≠a, devolver vac√≠o
    query = query.eq('id', '00000000-0000-0000-0000-000000000000'); // UUID inexistente
  }
}

if (genderSlug) {
  const { data: gen } = await supabase.from('genders').select('id').eq('slug', genderSlug).single();
  if (gen) query = query.eq('gender_id', gen.id);
}

if (minPrice) query = query.gte('price', parseInt(minPrice) * 100);
if (maxPrice) query = query.lte('price', parseInt(maxPrice) * 100);
if (isOnSale) query = query.eq('is_on_sale', true);
if (isNew) query = query.eq('is_new', true);
if (size) query = query.contains('sizes', [size]);
if (material) query = query.ilike('description', `%${material}%`);
if (colorSlug) {
  const { data: colorData } = await supabase.from('colors').select('name').eq('slug', colorSlug).single();
  if (colorData) {
    query = query.contains('colors', [colorData.name]);
  }
}

// Ordenar
if (sortBy === 'price_asc') query = query.order('price', { ascending: true });
else if (sortBy === 'price_desc') query = query.order('price', { ascending: false });
else if (sortBy === 'name') query = query.order('name');
else query = query.order('created_at', { ascending: false });

// Contar total de productos para paginaci√≥n
const countQuery = supabase
  .from('products')
  .select('id', { count: 'exact', head: true });

// Aplicar los mismos filtros al contador
if (productIdsFromCategory !== null && productIdsFromCategory.length > 0) {
  countQuery.in('id', productIdsFromCategory);
}
if (genderSlug) {
  const { data: gen } = await supabase.from('genders').select('id').eq('slug', genderSlug).single();
  if (gen) countQuery.eq('gender_id', gen.id);
}
if (minPrice) countQuery.gte('price', parseInt(minPrice) * 100);
if (maxPrice) countQuery.lte('price', parseInt(maxPrice) * 100);
if (isOnSale) countQuery.eq('is_on_sale', true);
if (isNew) countQuery.eq('is_new', true);
if (size) countQuery.contains('sizes', [size]);
if (material) countQuery.ilike('description', `%${material}%`);
if (colorSlug) {
  const { data: colorData } = await supabase.from('colors').select('name').eq('slug', colorSlug).single();
  if (colorData) {
    countQuery.contains('colors', [colorData.name]);
  }
}

const { count: totalProducts } = await countQuery;
const totalPages = Math.ceil((totalProducts || 0) / itemsPerPage);

// Aplicar paginaci√≥n
const { data: products } = await query.range(offset, offset + itemsPerPage - 1);
const productsArray = (products || []) as Product[];

// Datos para filtros
const { data: categories } = await supabase.from('categories').select('*').eq('level', 1).order('display_order');
const { data: genders } = await supabase.from('genders').select('*').order('display_order');
const { data: colors } = await supabase.from('colors').select('*').eq('is_active', true).order('display_order');

// Tallas est√°ndar
const availableSizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];

// Materiales comunes
const availableMaterials = ['Algod√≥n', 'Poli√©ster', 'Lana', 'Seda', 'Lino', 'Denim', 'Cuero'];
---

<PublicLayout title="Productos con Filtros - FashionMarket">
  <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-brand-navy mb-2">Todos los Productos</h1>
    <p class="text-gray-600 mb-8">{totalProducts || 0} productos encontrados</p>

    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Sidebar Filtros -->
      <aside class="lg:w-64">
        <div class="bg-white border rounded-lg p-6 sticky top-20">
          <h2 class="font-bold mb-4">Filtros</h2>
          <form method="get">
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">G√©nero</h3>
              {genders?.map(g => (
                <label class="flex items-center mb-2 cursor-pointer">
                  <input type="radio" name="genero" value={g.slug} checked={genderSlug === g.slug} class="mr-2" />
                  {g.name}
                </label>
              ))}
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">Categor√≠a</h3>
              <div class="max-h-48 overflow-y-auto">
                {categories?.map(c => (
                  <label class="flex items-center mb-2 cursor-pointer text-sm">
                    <input type="radio" name="categoria" value={c.slug} checked={categorySlug === c.slug} class="mr-2" />
                    {c.name}
                  </label>
                ))}
              </div>
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">Precio (‚Ç¨)</h3>
              <input type="number" name="precio_min" value={minPrice || ''} placeholder="M√≠n" class="w-full px-3 py-2 border rounded mb-2" />
              <input type="number" name="precio_max" value={maxPrice || ''} placeholder="M√°x" class="w-full px-3 py-2 border rounded" />
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <label class="flex items-center mb-2 cursor-pointer">
                <input type="checkbox" name="rebaja" value="true" checked={isOnSale} class="mr-2" />
                üî• En rebaja
              </label>
              <label class="flex items-center cursor-pointer">
                <input type="checkbox" name="nuevo" value="true" checked={isNew} class="mr-2" />
                ‚≠ê Nuevo
              </label>
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">Colores</h3>
              <div class="flex flex-wrap gap-2">
                {colors?.map(c => (
                  <label class="cursor-pointer">
                    <input 
                      type="radio" 
                      name="color" 
                      value={c.slug} 
                      checked={colorSlug === c.slug} 
                      class="sr-only peer"
                      aria-label={c.name}
                    />
                    <div 
                      class={`w-8 h-8 rounded-full border-2 transition-all ${colorSlug === c.slug ? 'border-brand-navy ring-2 ring-brand-gold' : 'border-gray-300 hover:border-gray-400'}`}
                      style={`background-color: ${c.hex_code}`}
                    ></div>
                  </label>
                ))}
              </div>
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">Tallas</h3>
              <div class="grid grid-cols-3 gap-2">
                {availableSizes.map(s => (
                  <label class="cursor-pointer">
                    <input 
                      type="radio" 
                      name="talla" 
                      value={s} 
                      checked={size === s} 
                      class="sr-only peer"
                    />
                    <div class={`px-3 py-2 text-center border rounded ${size === s ? 'bg-brand-navy text-white border-brand-navy' : 'border-gray-300 hover:border-brand-navy'}`}>
                      {s}
                    </div>
                  </label>
                ))}
              </div>
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">Material</h3>
              <select name="material" class="w-full px-3 py-2 border rounded">
                <option value="">Todos</option>
                {availableMaterials.map(m => (
                  <option value={m} selected={material === m}>{m}</option>
                ))}
              </select>
            </div>
            <button type="submit" class="w-full bg-brand-navy text-white py-2 rounded hover:bg-brand-charcoal mb-2">Aplicar</button>
            <a href="/productos" class="block w-full text-center border py-2 rounded hover:bg-gray-50">Limpiar</a>
          </form>
        </div>
      </aside>

      <!-- Grid Productos -->
      <main class="flex-1">
        <div class="flex justify-between items-center mb-4">
          <p class="text-sm text-gray-600">{productsArray.length} productos</p>
          <form method="get" class="flex items-center gap-2">
            {categorySlug && <input type="hidden" name="categoria" value={categorySlug} />}
            {genderSlug && <input type="hidden" name="genero" value={genderSlug} />}
            <select name="ordenar" onchange="this.form.submit()" class="border px-3 py-1 rounded text-sm">
              <option value="newest" selected={sortBy === 'newest'}>M√°s recientes</option>
              <option value="price_asc" selected={sortBy === 'price_asc'}>Precio ‚Üë</option>
              <option value="price_desc" selected={sortBy === 'price_desc'}>Precio ‚Üì</option>
              <option value="name" selected={sortBy === 'name'}>Nombre</option>
            </select>
          </form>
        </div>

        {productsArray.length > 0 ? (
          <Fragment>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {productsArray.map(p => <ProductCard product={p} />)}
            </div>

            <!-- Paginaci√≥n -->
            {totalPages > 1 && (
              <div class="mt-8 flex justify-center items-center gap-2">
                {page > 1 && (
                  <a 
                    href={`?${new URLSearchParams({
                      ...(categorySlug && { categoria: categorySlug }),
                      ...(genderSlug && { genero: genderSlug }),
                      ...(minPrice && { precio_min: minPrice }),
                      ...(maxPrice && { precio_max: maxPrice }),
                      ...(isOnSale && { rebaja: 'true' }),
                      ...(isNew && { nuevo: 'true' }),
                      ...(colorSlug && { color: colorSlug }),
                      ...(size && { talla: size }),
                      ...(material && { material: material }),
                      ordenar: sortBy,
                      pagina: String(page - 1)
                    }).toString()}`}
                    class="px-4 py-2 border rounded hover:bg-gray-50"
                  >
                    Anterior
                  </a>
                )}

                <div class="flex gap-1">
                  {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                    let pageNum;
                    if (totalPages <= 5) {
                      pageNum = i + 1;
                    } else if (page <= 3) {
                      pageNum = i + 1;
                    } else if (page >= totalPages - 2) {
                      pageNum = totalPages - 4 + i;
                    } else {
                      pageNum = page - 2 + i;
                    }
                    
                    return (
                      <a
                        href={`?${new URLSearchParams({
                          ...(categorySlug && { categoria: categorySlug }),
                          ...(genderSlug && { genero: genderSlug }),
                          ...(minPrice && { precio_min: minPrice }),
                          ...(maxPrice && { precio_max: maxPrice }),
                          ...(isOnSale && { rebaja: 'true' }),
                          ...(isNew && { nuevo: 'true' }),
                          ...(colorSlug && { color: colorSlug }),
                          ...(size && { talla: size }),
                          ...(material && { material: material }),
                          ordenar: sortBy,
                          pagina: String(pageNum)
                        }).toString()}`}
                        class={`px-3 py-2 border rounded ${pageNum === page ? 'bg-brand-navy text-white' : 'hover:bg-gray-50'}`}
                      >
                        {pageNum}
                      </a>
                    );
                  })}
                </div>

                {page < totalPages && (
                  <a 
                    href={`?${new URLSearchParams({
                      ...(categorySlug && { categoria: categorySlug }),
                      ...(genderSlug && { genero: genderSlug }),
                      ...(minPrice && { precio_min: minPrice }),
                      ...(maxPrice && { precio_max: maxPrice }),
                      ...(isOnSale && { rebaja: 'true' }),
                      ...(isNew && { nuevo: 'true' }),
                      ...(colorSlug && { color: colorSlug }),
                      ...(size && { talla: size }),
                      ...(material && { material: material }),
                      ordenar: sortBy,
                      pagina: String(page + 1)
                    }).toString()}`}
                    class="px-4 py-2 border rounded hover:bg-gray-50"
                  >
                    Siguiente
                  </a>
                )}
              </div>
            )}
          </Fragment>
        ) : (
          <div class="text-center py-16">
            <p class="text-gray-500 mb-4">No se encontraron productos con estos filtros</p>
            <a href="/productos" class="text-brand-navy hover:underline">Ver todos los productos ‚Üí</a>
          </div>
        )}
      </main>
    </div>
  </div>
</PublicLayout>

<script>
  document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
    input.addEventListener('change', function(this: HTMLInputElement) {
      this.closest('form')?.submit();
    });
  });
</script>
