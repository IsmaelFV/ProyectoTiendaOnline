---
/**
 * ============================================================================
 * Página: Productos con Filtros Avanzados
 * ============================================================================
 */

import PublicLayout from '@layouts/PublicLayout.astro';
import ProductCard from '@components/product/ProductCard.astro';
import { supabase } from '@lib/supabase';
import type { Product } from '@lib/supabase';

// Parámetros de filtros desde URL
const url = new URL(Astro.request.url);
const categorySlug = url.searchParams.get('categoria');
const genderSlug = url.searchParams.get('genero');
const minPrice = url.searchParams.get('precio_min');
const maxPrice = url.searchParams.get('precio_max');
const sortBy = url.searchParams.get('ordenar') || 'newest';
const isOnSale = url.searchParams.get('rebaja') === 'true';
const isNew = url.searchParams.get('nuevo') === 'true';
const page = parseInt(url.searchParams.get('pagina') || '1');
const itemsPerPage = 24;
const offset = (page - 1) * itemsPerPage;
const colorSlug = url.searchParams.get('color');
const size = url.searchParams.get('talla');
const material = url.searchParams.get('material');

// Si hay filtro de categoría, obtener IDs de productos usando product_categories
let productIdsFromCategory: string[] | null = null;
if (categorySlug) {
  const { data: cat } = await supabase.from('categories').select('id').eq('slug', categorySlug).single();
  if (cat) {
    const { data: relations } = await supabase
      .from('product_categories')
      .select('product_id')
      .eq('category_id', cat.id);
    productIdsFromCategory = (relations || []).map(rel => rel.product_id);
  }
}

// Construir query con filtros
let query = supabase
  .from('products')
  .select('*')
  .eq('is_active', true); // Solo productos activos

// Aplicar filtro de categoría si existe
if (productIdsFromCategory !== null) {
  if (productIdsFromCategory.length > 0) {
    query = query.in('id', productIdsFromCategory);
  } else {
    // Si no hay productos en la categoría, devolver vacío
    query = query.eq('id', '00000000-0000-0000-0000-000000000000'); // UUID inexistente
  }
}

if (genderSlug) {
  const { data: gen } = await supabase.from('genders').select('id').eq('slug', genderSlug).single();
  if (gen) query = query.eq('gender_id', gen.id);
}

if (minPrice) query = query.gte('price', parseInt(minPrice) * 100);
if (maxPrice) query = query.lte('price', parseInt(maxPrice) * 100);
if (isOnSale) query = query.eq('is_on_sale', true);
if (isNew) query = query.eq('is_new', true);
if (size) query = query.contains('sizes', [size]);
if (material) query = query.ilike('description', `%${material}%`);
if (colorSlug) {
  const { data: colorData } = await supabase.from('colors').select('name').eq('slug', colorSlug).single();
  if (colorData) {
    query = query.contains('colors', [colorData.name]);
  }
}

// Ordenar
if (sortBy === 'price_asc') query = query.order('price', { ascending: true });
else if (sortBy === 'price_desc') query = query.order('price', { ascending: false });
else if (sortBy === 'name') query = query.order('name');
else query = query.order('created_at', { ascending: false });

// Contar total de productos para paginación
const countQuery = supabase
  .from('products')
  .select('id', { count: 'exact', head: true })
  .eq('is_active', true); // Solo productos activos

// Aplicar los mismos filtros al contador
if (productIdsFromCategory !== null && productIdsFromCategory.length > 0) {
  countQuery.in('id', productIdsFromCategory);
}
if (genderSlug) {
  const { data: gen } = await supabase.from('genders').select('id').eq('slug', genderSlug).single();
  if (gen) countQuery.eq('gender_id', gen.id);
}
if (minPrice) countQuery.gte('price', parseInt(minPrice) * 100);
if (maxPrice) countQuery.lte('price', parseInt(maxPrice) * 100);
if (isOnSale) countQuery.eq('is_on_sale', true);
if (isNew) countQuery.eq('is_new', true);
if (size) countQuery.contains('sizes', [size]);
if (material) countQuery.ilike('description', `%${material}%`);
if (colorSlug) {
  const { data: colorData } = await supabase.from('colors').select('name').eq('slug', colorSlug).single();
  if (colorData) {
    countQuery.contains('colors', [colorData.name]);
  }
}

const { count: totalProducts } = await countQuery;
const totalPages = Math.ceil((totalProducts || 0) / itemsPerPage);

// Aplicar paginación
const { data: products } = await query.range(offset, offset + itemsPerPage - 1);
const productsArray = (products || []) as Product[];

// Datos para filtros - obtener todas las categorías (nivel 1, 2 y 3)
const { data: allCategories } = await supabase
  .from('categories')
  .select('id, name, slug, level, parent_id, gender_id')
  .eq('is_active', true)
  .order('display_order');

const { data: genders } = await supabase
  .from('genders')
  .select('*')
  .eq('is_active', true)
  .order('display_order');

const { data: colors } = await supabase
  .from('colors')
  .select('*')
  .eq('is_active', true)
  .order('display_order');

// Filtrar categorías según el género seleccionado
let categories = allCategories;
if (genderSlug) {
  const selectedGender = genders?.find(g => g.slug === genderSlug);
  if (selectedGender) {
    categories = allCategories?.filter(c => c.gender_id === selectedGender.id);
  }
}

// Tallas estándar
const availableSizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];

// Materiales comunes
const availableMaterials = ['Algodón', 'Poliéster', 'Lana', 'Seda', 'Lino', 'Denim', 'Cuero'];
---

<PublicLayout title="Productos con Filtros - FashionMarket">
  <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-brand-navy mb-2">Todos los Productos</h1>
    <p class="text-gray-600 mb-4">{totalProducts || 0} productos encontrados</p>

    {/* Filtros activos */}
    {(genderSlug || categorySlug || minPrice || maxPrice || isOnSale || isNew || colorSlug || size || material) && (
      <div class="mb-6 flex flex-wrap gap-2 items-center">
        <span class="text-sm font-medium text-gray-600">Filtros activos:</span>
        {genderSlug && (
          <a href={`/productos?${new URLSearchParams({...Object.fromEntries(url.searchParams), genero: ''}).toString().replace('genero=&', '').replace('genero=', '')}`} 
             class="inline-flex items-center gap-1 px-3 py-1 bg-brand-navy text-white text-sm rounded-full hover:bg-brand-charcoal">
            Género: {genders?.find(g => g.slug === genderSlug)?.name}
            <span>×</span>
          </a>
        )}
        {categorySlug && (
          <a href={`/productos?${new URLSearchParams({...Object.fromEntries(url.searchParams), categoria: ''}).toString().replace('categoria=&', '').replace('categoria=', '')}`}
             class="inline-flex items-center gap-1 px-3 py-1 bg-brand-navy text-white text-sm rounded-full hover:bg-brand-charcoal">
            Categoría: {categories?.find(c => c.slug === categorySlug)?.name}
            <span>×</span>
          </a>
        )}
        {(minPrice || maxPrice) && (
          <a href={`/productos?${new URLSearchParams(Object.fromEntries(Array.from(url.searchParams).filter(([k]) => k !== 'precio_min' && k !== 'precio_max'))).toString()}`}
             class="inline-flex items-center gap-1 px-3 py-1 bg-brand-navy text-white text-sm rounded-full hover:bg-brand-charcoal">
            Precio: {minPrice || '0'}€ - {maxPrice || '∞'}€
            <span>×</span>
          </a>
        )}
        {isOnSale && (
          <a href={`/productos?${new URLSearchParams({...Object.fromEntries(url.searchParams), rebaja: ''}).toString().replace('rebaja=&', '').replace('rebaja=', '')}`}
             class="inline-flex items-center gap-1 px-3 py-1 bg-brand-navy text-white text-sm rounded-full hover:bg-brand-charcoal">
            En rebaja
            <span>×</span>
          </a>
        )}
        {isNew && (
          <a href={`/productos?${new URLSearchParams({...Object.fromEntries(url.searchParams), nuevo: ''}).toString().replace('nuevo=&', '').replace('nuevo=', '')}`}
             class="inline-flex items-center gap-1 px-3 py-1 bg-brand-navy text-white text-sm rounded-full hover:bg-brand-charcoal">
            Nuevo
            <span>×</span>
          </a>
        )}
        <a href="/productos" class="text-sm text-red-600 hover:text-red-700 font-medium ml-2">
          Limpiar todos
        </a>
      </div>
    )}

    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Sidebar Filtros -->
      <aside class="lg:w-64">
        <div class="bg-white border rounded-lg p-6 sticky top-20">
          <h2 class="font-bold mb-4">Filtros</h2>
          <form method="get" id="filter-form">
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">1. Selecciona Género</h3>
              {genders?.map(g => (
                <label class="flex items-center mb-2 cursor-pointer">
                  <input 
                    type="radio" 
                    name="genero" 
                    value={g.slug} 
                    checked={genderSlug === g.slug} 
                    class="mr-2 gender-radio" 
                    onchange="this.form.submit()"
                  />
                  {g.name}
                </label>
              ))}
              {genderSlug && (
                <button 
                  type="button" 
                  onclick="window.location.href='/productos'" 
                  class="text-xs text-red-600 hover:text-red-700 mt-1"
                >
                  Quitar filtro
                </button>
              )}
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-3 uppercase">2. Categoría</h3>
              {!genderSlug ? (
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                  <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <p class="text-sm text-gray-600 font-medium mb-1">Selecciona un género primero</p>
                  <p class="text-xs text-gray-500">Para ver las categorías disponibles</p>
                </div>
              ) : categories && categories.length > 0 ? (
                <div class="max-h-64 overflow-y-auto space-y-1">
                  {categories
                    ?.filter(c => c.level === 1) // Solo categorías principales
                    .map(c => (
                      <div>
                        <label class="flex items-center mb-2 cursor-pointer text-sm font-medium">
                          <input type="radio" name="categoria" value={c.slug} checked={categorySlug === c.slug} class="mr-2" />
                          {c.name}
                        </label>
                        {/* Subcategorías */}
                        {categories
                          ?.filter(sub => sub.parent_id === c.id)
                          .map(sub => (
                            <label class="flex items-center mb-1 cursor-pointer text-sm ml-4">
                              <input type="radio" name="categoria" value={sub.slug} checked={categorySlug === sub.slug} class="mr-2" />
                              <span class="text-gray-600">{sub.name}</span>
                            </label>
                          ))
                        }
                      </div>
                    ))
                  }
                </div>
              ) : (
                <p class="text-sm text-gray-500 italic">No hay categorías para este género</p>
              )}
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">Precio (€)</h3>
              <input type="number" name="precio_min" value={minPrice || ''} placeholder="Mín" class="w-full px-3 py-2 border rounded mb-2" />
              <input type="number" name="precio_max" value={maxPrice || ''} placeholder="Máx" class="w-full px-3 py-2 border rounded" />
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <label class="flex items-center mb-2 cursor-pointer group">
                <input type="checkbox" name="rebaja" value="true" checked={isOnSale} class="mr-2" />
                <svg class="w-4 h-4 mr-1 text-red-500 group-hover:text-red-600" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                </svg>
                <span>En rebaja</span>
              </label>
              <label class="flex items-center cursor-pointer group">
                <input type="checkbox" name="nuevo" value="true" checked={isNew} class="mr-2" />
                <svg class="w-4 h-4 mr-1 text-yellow-500 group-hover:text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <span>Nuevo</span>
              </label>
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">Colores</h3>
              <div class="flex flex-wrap gap-2">
                {colors?.map(c => (
                  <label class="cursor-pointer">
                    <input 
                      type="radio" 
                      name="color" 
                      value={c.slug} 
                      checked={colorSlug === c.slug} 
                      class="sr-only peer"
                      aria-label={c.name}
                    />
                    <div 
                      class={`w-8 h-8 rounded-full border-2 transition-all ${colorSlug === c.slug ? 'border-brand-navy ring-2 ring-brand-gold' : 'border-gray-300 hover:border-gray-400'}`}
                      style={`background-color: ${c.hex_code}`}
                    ></div>
                  </label>
                ))}
              </div>
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">Tallas</h3>
              <div class="grid grid-cols-3 gap-2">
                {availableSizes.map(s => (
                  <label class="cursor-pointer">
                    <input 
                      type="radio" 
                      name="talla" 
                      value={s} 
                      checked={size === s} 
                      class="sr-only peer"
                    />
                    <div class={`px-3 py-2 text-center border rounded ${size === s ? 'bg-brand-navy text-white border-brand-navy' : 'border-gray-300 hover:border-brand-navy'}`}>
                      {s}
                    </div>
                  </label>
                ))}
              </div>
            </div>
            <hr class="my-4" />
            <div class="mb-6">
              <h3 class="font-semibold text-sm mb-2 uppercase">Material</h3>
              <select name="material" class="w-full px-3 py-2 border rounded">
                <option value="">Todos</option>
                {availableMaterials.map(m => (
                  <option value={m} selected={material === m}>{m}</option>
                ))}
              </select>
            </div>
            <button type="submit" class="w-full bg-brand-navy text-white py-2 rounded hover:bg-brand-charcoal mb-2">Aplicar</button>
            <a href="/productos" class="block w-full text-center border py-2 rounded hover:bg-gray-50">Limpiar</a>
          </form>
        </div>
      </aside>

      <!-- Grid Productos -->
      <main class="flex-1">
        <div class="flex justify-between items-center mb-4">
          <p class="text-sm text-gray-600">{productsArray.length} productos</p>
          <form method="get" class="flex items-center gap-2">
            {categorySlug && <input type="hidden" name="categoria" value={categorySlug} />}
            {genderSlug && <input type="hidden" name="genero" value={genderSlug} />}
            <select name="ordenar" onchange="this.form.submit()" class="border px-3 py-1 rounded text-sm">
              <option value="newest" selected={sortBy === 'newest'}>Más recientes</option>
              <option value="price_asc" selected={sortBy === 'price_asc'}>Precio ↑</option>
              <option value="price_desc" selected={sortBy === 'price_desc'}>Precio ↓</option>
              <option value="name" selected={sortBy === 'name'}>Nombre</option>
            </select>
          </form>
        </div>

        {productsArray.length > 0 ? (
          <div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {productsArray.map(p => <ProductCard product={p} />)}
            </div>

            <!-- Paginación -->
            {totalPages > 1 && (
              <div class="mt-8 flex justify-center items-center gap-2">
                {page > 1 && (
                  <a 
                    href={`?${new URLSearchParams({
                      ...(categorySlug && { categoria: categorySlug }),
                      ...(genderSlug && { genero: genderSlug }),
                      ...(minPrice && { precio_min: minPrice }),
                      ...(maxPrice && { precio_max: maxPrice }),
                      ...(isOnSale && { rebaja: 'true' }),
                      ...(isNew && { nuevo: 'true' }),
                      ...(colorSlug && { color: colorSlug }),
                      ...(size && { talla: size }),
                      ...(material && { material: material }),
                      ordenar: sortBy,
                      pagina: String(page - 1)
                    }).toString()}`}
                    class="px-4 py-2 border rounded hover:bg-gray-50"
                  >
                    Anterior
                  </a>
                )}

                <div class="flex gap-1">
                  {Array.from({ length: Math.min(5, totalPages) }, (_unused, i) => {
                    let pageNum = i + 1;
                    
                    // Calcular número de página según posición
                    const pagesCount = totalPages;
                    const currentPage = page;
                    
                    if (pagesCount > 5) {
                      if (currentPage > 3) {
                        if (currentPage + 2 < pagesCount) {
                          pageNum = currentPage - 2 + i;
                        } else {
                          pageNum = pagesCount - 4 + i;
                        }
                      }
                    }
                    
                    return (
                      <a
                        href={`?${new URLSearchParams({
                          ...(categorySlug && { categoria: categorySlug }),
                          ...(genderSlug && { genero: genderSlug }),
                          ...(minPrice && { precio_min: minPrice }),
                          ...(maxPrice && { precio_max: maxPrice }),
                          ...(isOnSale && { rebaja: 'true' }),
                          ...(isNew && { nuevo: 'true' }),
                          ...(colorSlug && { color: colorSlug }),
                          ...(size && { talla: size }),
                          ...(material && { material: material }),
                          ordenar: sortBy,
                          pagina: String(pageNum)
                        }).toString()}`}
                        class={`px-3 py-2 border rounded ${pageNum === page ? 'bg-brand-navy text-white' : 'hover:bg-gray-50'}`}
                      >
                        {pageNum}
                      </a>
                    );
                  })}
                </div>

                {page < totalPages && (
                  <a 
                    href={`?${new URLSearchParams({
                      ...(categorySlug && { categoria: categorySlug }),
                      ...(genderSlug && { genero: genderSlug }),
                      ...(minPrice && { precio_min: minPrice }),
                      ...(maxPrice && { precio_max: maxPrice }),
                      ...(isOnSale && { rebaja: 'true' }),
                      ...(isNew && { nuevo: 'true' }),
                      ...(colorSlug && { color: colorSlug }),
                      ...(size && { talla: size }),
                      ...(material && { material: material }),
                      ordenar: sortBy,
                      pagina: String(page + 1)
                    }).toString()}`}
                    class="px-4 py-2 border rounded hover:bg-gray-50"
                  >
                    Siguiente
                  </a>
                )}
              </div>
            )}
          </div>
        ) : (
          <div class="text-center py-16">
            <p class="text-gray-500 mb-4">No se encontraron productos con estos filtros</p>
            <a href="/productos" class="text-brand-navy hover:underline">Ver todos los productos →</a>
          </div>
        )}
      </main>
    </div>
  </div>
</PublicLayout>

<script>
  document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
    input.addEventListener('change', function(this: HTMLInputElement) {
      this.closest('form')?.submit();
    });
  });
</script>
