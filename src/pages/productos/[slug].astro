---
import PublicLayout from '@layouts/PublicLayout.astro';
import ProductGallery from '@components/product/ProductGallery.astro';
import ProductCard from '@components/product/ProductCard.astro';
import AddToCartButton from '@components/islands/AddToCartButton';
import ProductReviews from '@components/islands/ProductReviews';
import RecentlyViewed from '@components/islands/RecentlyViewed';
import { supabase } from '@lib/supabase';
import { formatPrice } from '@lib/utils';

export async function getStaticPaths() {
  const { data: products } = await supabase
    .from('products')
    .select('*');

  return products?.map((product) => ({
    params: { slug: product.slug },
    props: { product },
  })) || [];
}

// Obtener el slug de la URL
const { slug } = Astro.params;

// Obtener el producto desde props (SSG) o desde la base de datos (SSR)
let product = Astro.props.product;

// Si no hay product en props, buscarlo en la base de datos (modo SSR)
if (!product) {
  const { data } = await supabase
    .from('products')
    .select('*')
    .eq('slug', slug)
    .single();
  
  product = data;
}

// Si el producto no existe, devolver 404
if (!product) {
  return Astro.redirect('/404');
}

// Cargar la categoría relacionada solo si existe category_id
let category = null;
if (product.category_id) {
  const { data } = await supabase
    .from('categories')
    .select('*')
    .eq('id', product.category_id)
    .single();
  category = data;
}

// Cargar productos relacionados (misma categoría, excluyendo el actual)
let relatedProducts: any[] = [];
if (product.category_id) {
  const { data } = await supabase
    .from('products')
    .select('*')
    .eq('category_id', product.category_id)
    .neq('id', product.id)
    .gt('stock', 0)
    .limit(8);
  relatedProducts = data || [];
}
// Si hay pocos, completar con productos del mismo género
if (relatedProducts.length < 4 && product.gender_id) {
  const existingIds = [product.id, ...relatedProducts.map((p: any) => p.id)];
  const { data } = await supabase
    .from('products')
    .select('*')
    .eq('gender_id', product.gender_id)
    .not('id', 'in', `(${existingIds.join(',')})`)
    .gt('stock', 0)
    .limit(8 - relatedProducts.length);
  if (data) relatedProducts = [...relatedProducts, ...data];
}
// JSON-LD de producto
const productUrl = `${Astro.url.origin}/productos/${product.slug}`;
const productJsonLd = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Product",
  "name": product.name,
  "description": product.description || '',
  "image": product.images || [],
  "sku": product.id,
  "url": productUrl,
  "offers": {
    "@type": "Offer",
    "price": product.is_on_sale && product.sale_price ? product.sale_price : product.price,
    "priceCurrency": "EUR",
    "availability": product.stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
    "url": productUrl,
    ...(product.is_on_sale && product.sale_price ? { "priceValidUntil": new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] } : {})
  },
  ...(product.brand ? { "brand": { "@type": "Brand", "name": product.brand } } : {}),
});

// Calcular stock real desde stock_by_size para evitar desincronización con campo stock
const stockBySize = product.stock_by_size as Record<string, number> | null;
const realStock = stockBySize && typeof stockBySize === 'object' && Object.keys(stockBySize).length > 0
  ? Object.values(stockBySize).reduce((sum, v) => sum + (Number(v) || 0), 0)
  : (product.stock ?? 0);
---

<PublicLayout 
  title={`${product.name} - Fashion Store`}
  description={product.description}
  ogImage={product.images?.[0] || '/og-default.jpg'}
  ogType="og:product"
  canonicalUrl={productUrl}
  jsonLd={productJsonLd}
>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-10"
    data-recently-viewed={JSON.stringify({
      id: product.id,
      name: product.name,
      slug: product.slug,
      image: product.images?.[0] || '',
      price: product.price,
      sale_price: product.sale_price || null,
      is_on_sale: product.is_on_sale || false,
    })}
  >
    <!-- Breadcrumb -->
    <nav class="mb-6 text-xs text-gray-500 flex items-center flex-wrap gap-1">
      <a href="/" class="hover:text-gold-500 transition-colors">Inicio</a>
      <span class="text-gray-700">/</span>
      <a href="/productos" class="hover:text-gold-500 transition-colors">Productos</a>
      {category && (
        <>
          <span class="text-gray-700">/</span>
          <a href={`/categoria/${category.slug}`} class="hover:text-gold-500 transition-colors">
            {category.name}
          </a>
        </>
      )}
      <span class="text-gray-700">/</span>
      <span class="text-gray-400">{product.name}</span>
    </nav>

    <!-- Grid principal -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-14 items-start">
      
      <!-- Columna izquierda: Galería -->
      <div class="lg:sticky lg:top-20">
        <ProductGallery images={product.images} productName={product.name} />
      </div>

      <!-- Columna derecha: Info del producto -->
      <div class="space-y-5">
        <!-- Categoría + Nombre -->
        <div>
          {category && (
            <a 
              href={`/categoria/${category.slug}`}
              class="inline-block text-xs text-gold-500 hover:text-gold-400 font-medium uppercase tracking-widest mb-2 transition-colors"
            >
              {category.name}
            </a>
          )}
          <h1 class="font-serif text-2xl sm:text-3xl lg:text-4xl font-bold text-white leading-tight">
            {product.name}
          </h1>
        </div>

        <!-- Precio -->
        <div class="flex items-baseline gap-3">
          <span class="text-2xl lg:text-3xl font-serif font-bold text-gold-500">
            {formatPrice(product.price)}
          </span>
        </div>

        <!-- Descripción -->
        {product.description && (
          <p class="text-sm leading-relaxed text-gray-400">
            {product.description}
          </p>
        )}

        <!-- Compartir -->
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-600">Compartir:</span>
          <a
            href={`https://wa.me/?text=${encodeURIComponent(product.name + ' - Fashion Store\n' + Astro.url.href)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="p-2 rounded-lg bg-white/5 text-gray-400 hover:text-emerald-400 hover:bg-emerald-400/10 transition-all"
            title="Compartir en WhatsApp"
          >
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
          </a>
          <a
            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(product.name + ' - Fashion Store')}&url=${encodeURIComponent(Astro.url.href)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="p-2 rounded-lg bg-white/5 text-gray-400 hover:text-sky-400 hover:bg-sky-400/10 transition-all"
            title="Compartir en X"
          >
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
          </a>
          <a
            href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="p-2 rounded-lg bg-white/5 text-gray-400 hover:text-blue-400 hover:bg-blue-400/10 transition-all"
            title="Compartir en Facebook"
          >
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
          </a>
          <button
            id="copy-link-btn"
            class="p-2 rounded-lg bg-white/5 text-gray-400 hover:text-gold-500 hover:bg-gold-500/10 transition-all"
            title="Copiar enlace"
            data-url={Astro.url.href}
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
            </svg>
          </button>
        </div>

        <!-- Separador -->
        <div class="h-px bg-white/8"></div>

        <!-- Tallas + Botón o Agotado -->
        <div>
          {realStock > 0 ? (
            <>
              <div class="mb-4 flex items-center gap-3">
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-500/10 text-emerald-400 text-xs font-medium rounded-md border border-emerald-500/20">
                  <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                  En stock
                </span>
                <span class="text-xs text-gray-600">{realStock} uds. totales</span>
              </div>
              <AddToCartButton 
                client:load
                product={{
                  id: product.id,
                  name: product.name,
                  price: product.price,
                  slug: product.slug,
                  image: product.images?.[0],
                  sizes: product.sizes || [],
                  stock_by_size: product.stock_by_size || {},
                  size_measurements: product.size_measurements || {},
                }}
              />
            </>
          ) : (
            <div class="text-center py-6 bg-white/[0.02] rounded-xl border border-white/5">
              <p class="text-red-400 font-medium mb-1">Producto agotado</p>
              <p class="text-gray-500 text-sm">Este producto no está disponible actualmente</p>
            </div>
          )}
        </div>

        <!-- Separador -->
        <div class="h-px bg-white/8"></div>

        <!-- Beneficios -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="flex items-center gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/5">
            <div class="flex items-center justify-center w-9 h-9 rounded-lg bg-gold-500/10">
              <svg class="w-4 h-4 text-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
              </svg>
            </div>
            <div>
              <p class="text-xs font-medium text-white">Envío gratis</p>
              <p class="text-[11px] text-gray-500">Pedidos +100€</p>
            </div>
          </div>
          
          <div class="flex items-center gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/5">
            <div class="flex items-center justify-center w-9 h-9 rounded-lg bg-gold-500/10">
              <svg class="w-4 h-4 text-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
              </svg>
            </div>
            <div>
              <p class="text-xs font-medium text-white">Devoluciones</p>
              <p class="text-[11px] text-gray-500">30 días gratis</p>
            </div>
          </div>

          <div class="flex items-center gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/5">
            <div class="flex items-center justify-center w-9 h-9 rounded-lg bg-gold-500/10">
              <svg class="w-4 h-4 text-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
              </svg>
            </div>
            <div>
              <p class="text-xs font-medium text-white">Pago seguro</p>
              <p class="text-[11px] text-gray-500">Stripe certificado</p>
            </div>
          </div>

          <div class="flex items-center gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/5">
            <div class="flex items-center justify-center w-9 h-9 rounded-lg bg-gold-500/10">
              <svg class="w-4 h-4 text-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456z" />
              </svg>
            </div>
            <div>
              <p class="text-xs font-medium text-white">Garantía 2 años</p>
              <p class="text-[11px] text-gray-500">Calidad garantizada</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reseñas de clientes -->
    <ProductReviews client:visible productId={product.id} />

    <!-- Vistos recientemente -->
    <RecentlyViewed client:visible currentProductId={product.id} />

    <!-- Productos relacionados -->
    {relatedProducts.length > 0 && (
      <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="font-serif text-xl sm:text-2xl font-bold text-white">También te puede gustar</h2>
            <p class="text-sm text-gray-500 mt-1">Productos similares que podrían interesarte</p>
          </div>
          {category && (
            <a href={`/categoria/${category.slug}`} class="hidden sm:inline-flex items-center gap-1.5 text-sm text-gold-500 hover:text-gold-400 transition-colors font-medium">
              Ver más
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
              </svg>
            </a>
          )}
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6">
          {relatedProducts.slice(0, 4).map((related: any) => (
            <ProductCard product={related} />
          ))}
        </div>
      </section>
    )}
  </div>
</PublicLayout>

<script>
  // Guardar producto en historial de vistos recientemente
  (function() {
    try {
      const productData = document.querySelector('[data-recently-viewed]');
      if (productData) {
        const product = JSON.parse(productData.getAttribute('data-recently-viewed') || '{}');
        if (product.id) {
          const STORAGE_KEY = 'recently-viewed';
          const MAX_STORED = 12;
          const stored = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          const filtered = stored.filter((p: any) => p.id !== product.id);
          const updated = [{ ...product, timestamp: Date.now() }, ...filtered].slice(0, MAX_STORED);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
        }
      }
    } catch { /* ignore */ }
  })();

  // Copiar enlace del producto
  const copyBtn = document.getElementById('copy-link-btn');
  copyBtn?.addEventListener('click', async () => {
    const url = copyBtn.getAttribute('data-url') || window.location.href;
    try {
      await navigator.clipboard.writeText(url);
      const originalTitle = copyBtn.getAttribute('title');
      copyBtn.setAttribute('title', '¡Enlace copiado!');
      copyBtn.classList.add('text-gold-500');
      setTimeout(() => {
        copyBtn.setAttribute('title', originalTitle || 'Copiar enlace');
        copyBtn.classList.remove('text-gold-500');
      }, 2000);
    } catch {
      // Fallback
      const input = document.createElement('input');
      input.value = url;
      document.body.appendChild(input);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
    }
  });
</script>