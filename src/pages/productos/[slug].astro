---
import PublicLayout from '@layouts/PublicLayout.astro';
import ProductGallery from '@components/product/ProductGallery.astro';
import AddToCartButton from '@components/islands/AddToCartButton';
import { supabase } from '@lib/supabase';
import { formatPrice } from '@lib/utils';

export async function getStaticPaths() {
  const { data: products } = await supabase
    .from('products')
    .select('*');

  return products?.map((product) => ({
    params: { slug: product.slug },
    props: { product },
  })) || [];
}

// Obtener el slug de la URL
const { slug } = Astro.params;

// Obtener el producto desde props (SSG) o desde la base de datos (SSR)
let product = Astro.props.product;

// Si no hay product en props, buscarlo en la base de datos (modo SSR)
if (!product) {
  const { data } = await supabase
    .from('products')
    .select('*')
    .eq('slug', slug)
    .single();
  
  product = data;
}

// Si el producto no existe, devolver 404
if (!product) {
  return Astro.redirect('/404');
}

// Cargar la categoría relacionada solo si existe category_id
let category = null;
if (product.category_id) {
  const { data } = await supabase
    .from('categories')
    .select('*')
    .eq('id', product.category_id)
    .single();
  category = data;
}
---

<PublicLayout 
  title={`${product.name} - FashionMarket`}
  description={product.description}
>
  <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <nav class="mb-8 text-sm text-gray-400">
      <a href="/" class="hover:text-accent-gold transition-colors">Inicio</a>
      <span class="mx-2 text-gray-600">/</span>
      <a href="/productos" class="hover:text-accent-gold transition-colors">Productos</a>
      {category && (
        <>
          <span class="mx-2 text-gray-600">/</span>
          <a href={`/categoria/${category.slug}`} class="hover:text-accent-gold transition-colors">
            {category.name}
          </a>
        </>
      )}
      <span class="mx-2 text-gray-600">/</span>
      <span class="text-white">{product.name}</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <div>
        <ProductGallery images={product.images} productName={product.name} />
      </div>

      <div class="space-y-6">
        <div>
          {category && (
            <a 
              href={`/categoria/${category.slug}`}
              class="text-sm text-accent-gold hover:text-accent-gold-soft font-medium uppercase tracking-wide transition-colors"
            >
              {category.name}
            </a>
          )}
          <h1 class="font-serif text-4xl md:text-5xl font-bold text-white mt-2">
            {product.name}
          </h1>
        </div>

        <div class="text-3xl font-serif font-bold text-gradient">
          {formatPrice(product.price)}
        </div>

        {product.description && (
          <div class="prose prose-lg prose-invert text-gray-300">
            <p>{product.description}</p>
          </div>
        )}

        <div class="border-t border-white/10 pt-6">
          {(product.stock ?? 0) > 0 ? (
            <>
              <div class="mb-4">
                <span class="inline-flex items-center px-3 py-1 bg-emerald-500/20 text-emerald-400 text-sm font-medium rounded-full border border-emerald-500/30">
                  <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                  En stock ({product.stock} unidades)
                </span>
              </div>
              <AddToCartButton 
                client:load
                product={{
                  id: product.id,
                  name: product.name,
                  price: product.price,
                  slug: product.slug,
                  image: product.images?.[0],
                  sizes: product.sizes || [],
                }}
              />
            </>
          ) : (
            <div class="text-center py-8">
              <p class="text-red-400 font-semibold text-lg mb-4">Producto agotado</p>
              <p class="text-gray-400">Este producto no está disponible actualmente</p>
            </div>
          )}
        </div>

        <div class="border-t border-white/10 pt-6 space-y-4 text-sm text-gray-400">
          <div class="flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0 mt-0.5 text-accent-gold">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
            </svg>
            <div>
              <p class="font-medium text-white">Envío gratuito</p>
              <p>En pedidos superiores a 100€</p>
            </div>
          </div>
          
          <div class="flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0 mt-0.5 text-accent-gold">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
            <div>
              <p class="font-medium text-white">Devoluciones fáciles</p>
              <p>30 días para cambios y devoluciones</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</PublicLayout>
