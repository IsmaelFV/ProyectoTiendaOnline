---
/**
 * ============================================================================
 * Página: Hombre
 * ============================================================================
 * Ruta: /hombre
 * Landing page con todos los productos de hombre + navegación por categorías
 * ============================================================================
 */

import PublicLayout from '../../layouts/PublicLayout.astro';
import CategoryNav from '../../components/navigation/CategoryNav';
import ProductCard from '../../components/product/ProductCard.astro';
import { supabase } from '../../lib/supabase';
import type { Product } from '../../lib/supabase';

// Obtener ID del género hombre
const { data: gender } = await supabase
  .from('genders')
  .select('id, name')
  .eq('slug', 'hombre')
  .single();

if (!gender) {
  return Astro.redirect('/404');
}

// Obtener productos de hombre (destacados primero, luego novedades)
const { data: products, error } = await supabase
  .from('products')
  .select(`
    *,
    category:categories!products_category_id_fkey(name, slug)
  `)
  .eq('gender_id', gender.id)
  .eq('is_active', true)
  .order('featured', { ascending: false })
  .order('is_new', { ascending: false })
  .order('created_at', { ascending: false })
  .limit(24);

const productsArray = (products || []) as Product[];
---

<PublicLayout title="Hombre - Fashion Store" description="Descubre la última moda masculina">
  <div class="flex flex-col lg:flex-row min-h-screen">
    <!-- Navegación lateral -->
    <aside class="lg:sticky lg:top-20 lg:self-start">
      <CategoryNav currentGender="hombre" client:load />
    </aside>

    <!-- Contenido principal -->
    <main class="flex-1 bg-dark-bg">
      {/* Hero Banner */}
      <section class="relative py-20 px-6 overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-dark-surface via-dark-bg to-dark-surface"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_120%,rgba(212,175,55,0.1),transparent_60%)]"></div>
        <div class="relative max-w-4xl mx-auto text-center">
          <span class="inline-block px-4 py-2 bg-white/5 border border-white/10 rounded-full text-accent-gold text-sm font-medium mb-6 backdrop-blur-sm">
            Colección Masculina
          </span>
          <h1 class="text-5xl md:text-6xl font-light mb-4 uppercase tracking-[0.2em] text-white">Hombre</h1>
          <p class="text-xl font-light text-gray-400">
            Descubre la última moda masculina
          </p>
        </div>
      </section>

      {/* Destacados */}
      <section class="py-8 px-6 bg-dark-surface border-b border-white/5">
        <div class="max-w-7xl mx-auto">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a 
              href="/productos?genero=hombre&categoria=novedades-hombre" 
              class="group relative h-48 bg-cover bg-center rounded-xl overflow-hidden border border-white/10"
              style="background-image: url('https://images.unsplash.com/photo-1490578474895-699cd4e2cf59?w=400&h=300&fit=crop')"
            >
              <div class="absolute inset-0 bg-black/50 group-hover:bg-black/40 transition-all flex items-center justify-center">
                <span class="text-white text-xl font-light uppercase tracking-wider">Novedades</span>
              </div>
            </a>

            <a 
              href="/productos?genero=hombre&categoria=rebajas-hombre" 
              class="group relative h-48 bg-cover bg-center rounded-xl overflow-hidden border border-white/10"
              style="background-image: url('https://images.unsplash.com/photo-1489987707025-afc232f7ea0f?w=400&h=300&fit=crop')"
            >
              <div class="absolute inset-0 bg-gradient-to-br from-accent-gold/60 to-amber-600/60 group-hover:from-accent-gold/70 group-hover:to-amber-600/70 transition-all flex items-center justify-center">
                <span class="text-white text-xl font-semibold uppercase tracking-wider">Rebajas</span>
              </div>
            </a>

            <a 
              href="/productos?genero=hombre&categoria=ropa-hombre" 
              class="group relative h-48 bg-cover bg-center rounded-xl overflow-hidden border border-white/10"
              style="background-image: url('https://images.unsplash.com/photo-1617127365659-c47fa864d8bc?w=400&h=300&fit=crop')"
            >
              <div class="absolute inset-0 bg-black/50 group-hover:bg-black/40 transition-all flex items-center justify-center">
                <span class="text-white text-xl font-light uppercase tracking-wider">Ropa</span>
              </div>
            </a>

            <a 
              href="/productos?genero=hombre&categoria=zapatos-hombre" 
              class="group relative h-48 bg-cover bg-center rounded-xl overflow-hidden border border-white/10"
              style="background-image: url('https://images.unsplash.com/photo-1549298916-b41d501d3772?w=400&h=300&fit=crop')"
            >
              <div class="absolute inset-0 bg-black/50 group-hover:bg-black/40 transition-all flex items-center justify-center">
                <span class="text-white text-xl font-light uppercase tracking-wider">Zapatos</span>
              </div>
            </a>
          </div>
        </div>
      </section>

      {/* Productos */}
      <section class="py-12 px-6">
        <div class="max-w-7xl mx-auto">
          <h2 class="text-3xl font-light mb-8 text-white uppercase tracking-wider">
            Todos los productos
          </h2>

          {productsArray.length > 0 ? (
            <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
              {productsArray.map((product) => (
                <ProductCard product={product} />
              ))}
            </div>
          ) : (
            <div class="text-center py-16">
              <p class="text-gray-400 text-lg">No hay productos disponibles en esta sección.</p>
              <a href="/" class="text-accent-gold hover:text-accent-gold/80 mt-4 inline-block transition-colors">
                Volver al inicio
              </a>
            </div>
          )}

          {productsArray.length >= 24 && (
            <div class="text-center mt-12" id="load-more-container">
              <button 
                id="load-more-btn"
                data-gender-id={gender.id}
                data-page="1"
                data-limit="24"
                class="px-8 py-3 border border-white/20 text-white hover:bg-white/5 transition-all uppercase tracking-wider text-sm rounded-lg"
              >
                Cargar más productos
              </button>
            </div>
          )}
        </div>
      </section>
    </main>
  </div>
</PublicLayout>

<script>
  function initLoadMore() {
    const btn = document.getElementById('load-more-btn') as HTMLButtonElement | null;
    if (!btn) return;

    if (btn.dataset.bound === 'true') return;
    btn.dataset.bound = 'true';

    btn.addEventListener('click', async () => {
      const currentPage = parseInt(btn.dataset.page || '1');
      const nextPage = currentPage + 1;
      const limit = parseInt(btn.dataset.limit || '24');
      const genderId = btn.dataset.genderId;

      btn.disabled = true;
      btn.textContent = 'Cargando...';

      try {
        const params = new URLSearchParams({
          page: nextPage.toString(),
          limit: limit.toString(),
          gender_id: genderId || '',
        });

        const res = await fetch(`/api/products/list?${params}`);
        if (!res.ok) throw new Error('Error al cargar productos');

        const data = await res.json();
        const { products, pagination } = data;

        if (products.length > 0) {
          const grid = document.getElementById('products-grid');
          if (grid) {
            products.forEach((product: any) => {
              grid.insertAdjacentHTML('beforeend', renderProductCard(product));
            });
            document.dispatchEvent(new Event('astro:page-load'));
          }
          btn.dataset.page = nextPage.toString();
        }

        if (!pagination.hasMore) {
          btn.parentElement?.remove();
        } else {
          btn.disabled = false;
          btn.textContent = 'Cargar más productos';
        }
      } catch (err) {
        console.error(err);
        btn.disabled = false;
        btn.textContent = 'Cargar más productos';
      }
    });
  }

  function formatPrice(cents: number): string {
    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(cents / 100);
  }

  function optimizeImage(url: string): string {
    if (!url || !url.includes('cloudinary.com')) return url;
    return url.replace('/upload/', '/upload/w_400,h_500,c_fill,g_auto,f_auto,q_auto/');
  }

  function renderProductCard(p: any): string {
    const mainImage = p.images?.[0] || '/placeholder.svg';
    const img = optimizeImage(mainImage);
    const hasDiscount = p.is_on_sale && p.sale_price && p.sale_price < p.price;
    const discountPct = hasDiscount ? Math.round((1 - p.sale_price / p.price) * 100) : 0;
    const displayPrice = hasDiscount ? p.sale_price : p.price;
    const catName = p.category?.name || 'Moda';

    return `
      <article class="product-card-premium group" data-product-id="${p.id}">
        <button class="wishlist-btn" aria-label="Añadir a favoritos" data-wishlist-id="${p.id}">
          <svg class="w-5 h-5 wishlist-icon-outline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
          <svg class="w-5 h-5 wishlist-icon-filled hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
        </button>
        <a href="/productos/${p.slug}" class="block">
          <div class="product-image-container">
            <img src="${img}" alt="${p.name}" class="product-image" loading="lazy"/>
            <div class="absolute top-3 left-3 flex flex-col gap-1.5 z-10">
              ${hasDiscount ? `<span class="badge-discount">-${discountPct}%</span>` : ''}
              ${p.stock <= 3 && p.stock > 0 ? '<span class="badge-low-stock">¡Últimas unidades!</span>' : ''}
            </div>
            <div class="product-overlay"></div>
            <div class="quick-view-btn">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
              <span>Ver detalles</span>
            </div>
          </div>
          <div class="product-content">
            <div class="product-category">${catName}</div>
            <h3 class="product-name">${p.name}</h3>
            <div class="product-price-container">
              <span class="product-price-current">${formatPrice(displayPrice)}</span>
              ${hasDiscount ? `<span class="product-price-original">${formatPrice(p.price)}</span>` : ''}
            </div>
            <div class="product-stock">
              ${p.stock > 0 
                ? '<div class="stock-available"><span class="stock-dot"></span><span>Disponible</span></div>'
                : '<div class="stock-unavailable"><span class="stock-dot-red"></span><span>Agotado</span></div>'}
            </div>
          </div>
        </a>
      </article>
    `;
  }

  initLoadMore();
  document.addEventListener('astro:page-load', initLoadMore);
</script>
