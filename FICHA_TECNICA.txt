================================================================================

                         F A S H I O N   S T O R E
                    Ficha Técnica del Producto — v1.0

================================================================================
  Proyecto:    FashionStore — Plataforma e-commerce de moda
  Autor:       Ismael Fernández Velázquez
  Fecha:       Febrero 2026
  Repositorio: github.com/IsmaelFV/ProyectoTiendaOnline
================================================================================


================================================================================
  ÍNDICE
================================================================================

  1. Descripción General del Producto
  2. Stack Tecnológico y Arquitectura
  3. Base de Datos y Lógica de Negocio
  4. Experiencia de Usuario — Tienda Pública
  5. Panel de Administración (Backoffice)
  6. Sistema de Facturación y Abonos
  7. Infraestructura de Seguridad
  8. Notificaciones y Comunicaciones
  9. Despliegue y Puesta en Producción
  10. Documentación Técnica Complementaria


================================================================================
  1. DESCRIPCIÓN GENERAL DEL PRODUCTO
================================================================================

  FashionStore es una plataforma de comercio electrónico especializada en moda,
  desarrollada con tecnologías modernas orientadas al rendimiento, la seguridad
  y la escalabilidad. El sistema cubre el ciclo completo de una tienda online:
  desde la navegación del catálogo por parte del cliente hasta la gestión
  integral de pedidos, facturación y devoluciones por parte del administrador.

  El proyecto se divide en dos áreas claramente separadas:

  · TIENDA PÚBLICA — Catálogo de productos segmentado por género (Hombre /
    Mujer), con buscador inteligente, sistema de filtros avanzados, carrito
    persistente, recomendador algorítmico de tallas, pasarela de pago
    integrada con Stripe y área personal para que cada cliente consulte
    sus pedidos e historial de compras.

  · PANEL DE ADMINISTRACIÓN — Backoffice independiente con acceso
    restringido, que incluye dashboard con métricas en tiempo real,
    gestión CRUD de productos con subida múltiple de imágenes, control
    de pedidos con flujo de estados, sistema de facturación automática
    con generación de PDF, gestión de devoluciones con abonos
    rectificativos, códigos promocionales y captación de leads
    vía newsletter.


================================================================================
  2. STACK TECNOLÓGICO Y ARQUITECTURA
================================================================================

  2.1 Tecnologías principales
  ---------------------------------------------------------------------------

  Frontend:
  · Astro 5 — Framework principal con renderizado híbrido (SSR + SSG)
  · React 18 — Componentes interactivos mediante "Islands Architecture"
  · Tailwind CSS 3 — Sistema de diseño utility-first con tema personalizado
  · TypeScript 5 — Tipado estricto en todo el código fuente
  · Nanostores — Gestión de estado global con persistencia en localStorage

  Backend:
  · Supabase — Base de datos PostgreSQL con autenticación, Row Level
    Security, funciones PL/pgSQL y API REST autogenerada
  · Stripe — Pasarela de pagos (checkout, webhooks, reembolsos)
  · Brevo — Servicio de emails transaccionales con adjuntos PDF

  Multimedia:
  · Cloudinary — CDN de imágenes con transformaciones automáticas
    (WebP/AVIF, resize, crop, optimización de calidad)

  Herramientas auxiliares:
  · jsPDF — Generación de facturas y abonos en formato PDF
  · Chart.js — Gráficos interactivos en el dashboard administrativo
  · pg_trgm — Extensión PostgreSQL para búsqueda tolerante a erratas


  2.2 Arquitectura del renderizado
  ---------------------------------------------------------------------------

  La aplicación utiliza un modelo híbrido de renderizado:

  · Renderizado en servidor (SSR) — El catálogo, las fichas de producto,
    el checkout, el área de usuario y el panel de administración se
    renderizan en cada petición con datos frescos de la base de datos.
    Esto garantiza que los precios, el stock y los estados de los pedidos
    estén siempre actualizados.

  · Pre-renderizado estático (SSG) — Las páginas informativas (política
    de privacidad, sostenibilidad, contacto) se generan en tiempo de
    build como HTML estático, lo que mejora la velocidad de carga y el
    posicionamiento SEO.

  · Islas de interactividad — Solo los componentes que requieren
    interacción del usuario (barra de búsqueda, botón de añadir al
    carrito, slide-over del carrito, popup de newsletter, recomendador
    de tallas) se hidratan en el navegador como componentes React. El
    resto de la página se entrega como HTML puro sin JavaScript.


  2.3 Estado global y persistencia del carrito
  ---------------------------------------------------------------------------

  El carrito de compras se gestiona con Nanostores y la extensión
  @nanostores/persistent, lo que permite:

  · Persistencia automática en localStorage entre sesiones de navegación
  · Sincronización instantánea entre componentes sin prop drilling
  · Tipado completo de cada elemento del carrito (id, nombre, slug,
    precio, precio de oferta, cantidad, imagen, talla, stock disponible)
  · Funcionamiento fluido durante la navegación sin recargas ni pérdida
    de datos

  Además del carrito, se gestionan como stores globales la sesión del
  usuario y el estado de los filtros de búsqueda.


  2.4 Estructura del proyecto
  ---------------------------------------------------------------------------

  src/
  ├── components/
  │   ├── admin/          Componentes del panel de administración
  │   ├── islands/        Componentes React hidratados (islas interactivas)
  │   ├── navigation/     Navbar, menú móvil, migas de pan
  │   ├── product/        Tarjeta de producto, galería, grid
  │   ├── search/         Barra de búsqueda con autocompletado
  │   └── ui/             Footer, newsletter, botones, modales
  ├── layouts/            Layouts: Admin, Base y Público
  ├── lib/                Módulos de negocio (autenticación, facturación,
  │                       Cloudinary, Brevo, Stripe, búsqueda, logger...)
  ├── pages/
  │   ├── api/            +20 endpoints REST tipados
  │   ├── internal-admin/ Panel de administración (ruta oculta)
  │   ├── checkout/       Flujo de pago y confirmación
  │   ├── perfil/         Área personal del cliente
  │   └── productos/      Catálogo público
  ├── stores/             Nano Stores (carrito, sesión, filtros)
  ├── styles/             Estilos globales
  └── types/              Interfaces TypeScript (Product, Order, Invoice...)


================================================================================
  3. BASE DE DATOS Y LÓGICA DE NEGOCIO
================================================================================

  3.1 Modelo de datos
  ---------------------------------------------------------------------------

  La base de datos está desplegada en Supabase (PostgreSQL) con un esquema
  normalizado que incluye las siguientes tablas principales:

  · products            Catálogo de productos con precios en céntimos de
                        euro (enteros), imágenes como array, stock global
                        y stock desglosado por talla
  · categories          Jerarquía de categorías con relación padre/hijo
                        mediante parent_id (camisetas → ropa, etc.)
  · genders             Segmentación por género (Hombre / Mujer)
  · orders              Pedidos con datos de envío, importes desglosados,
                        7 estados posibles y referencia al pago en Stripe
  · order_items         Líneas de cada pedido con producto, talla, precio
                        unitario y cantidad
  · invoices            Facturas de venta y notas de abono rectificativas,
                        con número secuencial y tipo diferenciado
  · invoice_items       Líneas de factura asociadas a cada documento
  · admin_users         Tabla de administradores separada de los clientes,
                        con roles (super_admin, admin, editor, viewer)
  · discount_codes      Códigos promocionales con reglas configurables
  · newsletter_subs.    Suscriptores al boletín de novedades
  · stock_reservations  Reservas temporales de stock durante el checkout
  · persistent_cart     Carrito persistente vinculado al usuario
  · wishlist            Lista de deseos del cliente

  Todas las tablas utilizan claves foráneas con políticas ON DELETE
  CASCADE o SET NULL según corresponda. Se aplican constraints CHECK para
  validar precios positivos, stock no negativo y formatos de slug mediante
  expresiones regulares. Se han creado índices optimizados, incluyendo
  trigramas (pg_trgm) para potenciar la búsqueda de texto.


  3.2 Control atómico de stock
  ---------------------------------------------------------------------------

  El stock se gestiona mediante funciones PL/pgSQL ejecutadas a nivel de
  base de datos, lo que garantiza atomicidad e integridad incluso en
  escenarios de alta concurrencia:

  · decrement_stock() — Decrementa el stock de un producto utilizando
    bloqueo a nivel de fila (SELECT ... FOR UPDATE). Esto impide que dos
    transacciones simultáneas lean el mismo valor de stock antes de
    decrementarlo, eliminando el riesgo de sobreventa.

  · validate_and_decrement_stock() — Recibe un array JSON con los
    productos y cantidades del pedido. Valida que haya stock suficiente
    para TODOS los artículos antes de confirmar el decremento. Si algún
    producto no tiene disponibilidad, la operación se revierte por
    completo.

  · reserve_stock() — Implementa un patrón de reserva temporal: al
    iniciar el checkout, el stock se reserva durante 15 minutos. Si el
    pago no se completa en ese plazo, la función expire_reservations()
    libera automáticamente las unidades reservadas.

  · increment_stock() — Restaura el stock cuando se cancela un pedido
    que aún no ha sido enviado, garantizando que las unidades vuelvan a
    estar disponibles para otros clientes.


  3.3 Seguridad a nivel de base de datos (RLS)
  ---------------------------------------------------------------------------

  Todas las tablas sensibles tienen activado Row Level Security:

  · Los visitantes y clientes pueden leer productos, categorías y
    géneros, pero nunca modificarlos
  · Cada cliente solo puede acceder a sus propios pedidos y facturas
  · La tabla admin_users solo es accesible con el service_role key
    (nunca desde el navegador)
  · Las operaciones de escritura en el catálogo requieren autenticación
    como administrador verificado


================================================================================
  4. EXPERIENCIA DE USUARIO — TIENDA PÚBLICA
================================================================================

  4.1 Diseño visual
  ---------------------------------------------------------------------------

  La interfaz sigue una estética minimalista premium inspirada en
  plataformas como H&M o Zara, con un sistema de diseño cohesivo:

  · Paleta de colores personalizada: tonos navy como color principal,
    dorado como acento de lujo, crema para fondos cálidos y una escala
    completa de grises
  · Tipografías seleccionadas: Playfair Display (serif) para títulos
    y encabezados, Inter (sans-serif) para el cuerpo de texto
  · Sombras progresivas (soft, elevated, glass, premium) que crean
    profundidad sin romper la limpieza visual
  · Animaciones suaves (fade-in, slide-up, shimmer) que aportan
    dinamismo sin distraer
  · Diseño totalmente responsive con enfoque Mobile-first, adaptado
    a todos los tamaños de pantalla


  4.2 Navegación y catálogo
  ---------------------------------------------------------------------------

  · Navegación principal segmentada por género (Hombre / Mujer) con
    submenús desplegables por categoría
  · Cada sección muestra los productos en cuadrícula responsive con
    carga progresiva mediante botón "Cargar más" conectado a una API
    de paginación
  · Tarjetas de producto con imagen optimizada (lazy loading), nombre,
    categoría, precio, precio de oferta con porcentaje de descuento,
    indicador de últimas unidades y botón de lista de deseos


  4.3 Buscador inteligente
  ---------------------------------------------------------------------------

  · Barra de búsqueda con autocompletado en tiempo real y debounce
    de 300ms para evitar saturar la API
  · Sugerencias en dropdown navegable con teclado (flechas, Enter, Escape)
  · Búsqueda por trigramas (pg_trgm) que tolera erratas y variaciones
    ortográficas
  · Filtros combinables: categoría, género, rango de precio, colores,
    tallas, disponibilidad, novedades, rebajas
  · Ordenación por precio (ascendente/descendente), nombre o novedades


  4.4 Carrito y checkout
  ---------------------------------------------------------------------------

  · Carrito tipo slide-over lateral con animación, visible desde
    cualquier página sin perder el contexto de navegación
  · Persistencia entre sesiones gracias a Nanostores + localStorage
  · Aplicación de códigos promocionales con validación en tiempo real
  · Checkout integrado con Stripe Checkout (hosted), que gestiona
    de forma segura la introducción de datos de pago sin que la
    información sensible pase por nuestro servidor
  · Página de confirmación que verifica el estado del pedido y muestra
    el resumen de la compra


  4.5 Recomendador algorítmico de tallas
  ---------------------------------------------------------------------------

  Modal interactivo de tres pasos que guía al cliente:

  Paso 1 — Selección de género (hombre / mujer), que determina las
           tablas de medidas a utilizar
  Paso 2 — Introducción de medidas corporales: contorno de pecho,
           cintura, cadera y altura en centímetros
  Paso 3 — Preferencia de ajuste (ajustado / normal / holgado)

  El algoritmo calcula un score de compatibilidad (0-100) con cada
  talla europea (XS a XXL / 36 a 52) utilizando una función de
  distancia ponderada sobre las medidas introducidas. El resultado
  indica la talla recomendada con un nivel de confianza (perfecto,
  bueno o aproximado). El perfil de talla se guarda localmente para
  futuras compras.


  4.6 Herramientas de captación y marketing
  ---------------------------------------------------------------------------

  · Pop-up de newsletter que aparece tras 5 segundos en la primera
    visita, con código promocional de bienvenida incluido
  · Sección de ofertas flash controlable desde el panel admin
    (activación/desactivación individual de descuentos por producto)
  · Códigos promocionales configurables: porcentaje o importe fijo,
    con fecha de inicio y caducidad, límite de usos por código y
    mínimo de compra requerido


================================================================================
  5. PANEL DE ADMINISTRACIÓN (BACKOFFICE)
================================================================================

  El backoffice es un área completamente independiente de la tienda
  pública, accesible mediante una ruta oculta y protegida por múltiples
  capas de seguridad (ver sección 7). El modelo de separación es similar
  al que utilizan plataformas como Shopify: las cuentas de administrador
  viven en una tabla distinta a las de los clientes.


  5.1 Dashboard y métricas en tiempo real
  ---------------------------------------------------------------------------

  La pantalla principal del panel presenta:

  · Tarjetas de KPIs calculados directamente desde la base de datos:
    - Ventas totales acumuladas (excluyendo pedidos cancelados)
    - Número total de pedidos
    - Ventas del mes en curso
    - Producto más vendido
  · Gráfico de líneas interactivo (Chart.js) con doble eje Y que
    muestra la evolución de ventas en euros y número de pedidos
    durante los últimos 7 días
  · Resumen de distribución de pedidos por estado


  5.2 Gestión de productos
  ---------------------------------------------------------------------------

  · CRUD completo: crear, editar, duplicar y desactivar productos
  · Subida de múltiples imágenes con Drag & Drop, preview, barra de
    progreso, validación de tipo y tamaño, reordenación y marcado
    de imagen principal
  · Campos gestionables: nombre, descripción, precio, precio de oferta,
    categoría, género, tallas disponibles, colores, stock global,
    stock por talla, marca, SKU, destacado, novedad, rebaja activa,
    sostenibilidad


  5.3 Gestión de pedidos
  ---------------------------------------------------------------------------

  · Listado con filtros por estado y búsqueda por número de pedido
  · Detalle de cada pedido con timeline visual de progreso
  · Flujo de estados controlado:
    Pendiente → Confirmado → En preparación → Enviado → Entregado
  · Posibilidad de cancelar pedidos antes del envío (lo que restaura
    automáticamente el stock de los productos afectados)
  · Estados de pago independientes: pendiente / pagado / fallido /
    reembolsado


  5.4 Gestión de devoluciones
  ---------------------------------------------------------------------------

  · El cliente puede solicitar una devolución desde su área personal
    indicando el motivo
  · El administrador revisa, aprueba o rechaza la solicitud
  · Al aprobar, se ejecuta automáticamente el reembolso a través de
    la API de Stripe y se genera la nota de abono correspondiente
    (ver sección 6)


  5.5 Otros módulos
  ---------------------------------------------------------------------------

  · Gestión de ofertas — Activar/desactivar descuentos por producto
  · Códigos promocionales — Crear, editar y desactivar códigos con
    reglas de validez
  · Gestión de clientes — Listado de clientes con historial de compras
  · Configuración general — Ajustes de la tienda


================================================================================
  6. SISTEMA DE FACTURACIÓN Y ABONOS
================================================================================

  La facturación está completamente automatizada y se integra con el
  flujo de pagos y devoluciones:

  6.1 Factura de venta
  ---------------------------------------------------------------------------

  Se genera automáticamente en el momento en que Stripe confirma el pago
  a través del webhook. El documento PDF incluye:

  · Número de factura secuencial (formato FACT-2026-000001)
  · Datos fiscales del emisor y del cliente
  · Tabla detallada de productos con imagen, nombre, talla, cantidad
    y precio unitario
  · Desglose: subtotal, gastos de envío, IVA y total en euros
  · Fecha de emisión y referencia al método de pago

  La factura se persiste en la tabla invoices de la base de datos y se
  envía al cliente por email con el PDF como adjunto.


  6.2 Nota de abono (factura rectificativa)
  ---------------------------------------------------------------------------

  Cuando se procesa una devolución, el sistema genera automáticamente una
  factura rectificativa que cumple con la normativa aplicable (Art. 15 del
  RD 1619/2012):

  · Número de abono secuencial (formato ABON-2026-000001)
  · Referencia explícita a la factura original rectificada
  · Importes en negativo que anulan parcial o totalmente la factura
    de origen
  · Motivo de la devolución incluido en el documento
  · Referencia legal al artículo normativo correspondiente

  El abono se persiste igualmente en la tabla invoices (diferenciado
  por tipo = 'credit_note') y se envía por email al cliente.


  6.3 Servicio centralizado
  ---------------------------------------------------------------------------

  Toda la lógica de facturación pasa por un servicio único que se encarga
  de generar el número secuencial, crear el PDF, persistir el registro en
  base de datos y disparar el envío del email. Esto garantiza la
  consistencia entre la numeración de facturas, los datos almacenados
  y los documentos recibidos por el cliente.


================================================================================
  7. INFRAESTRUCTURA DE SEGURIDAD
================================================================================

  7.1 Cabeceras HTTP de seguridad
  ---------------------------------------------------------------------------

  Todas las respuestas del servidor incluyen las siguientes cabeceras,
  configuradas en el middleware de la aplicación:

  · Strict-Transport-Security (HSTS) con preload
  · Content-Security-Policy con directivas específicas por recurso
  · X-Content-Type-Options: nosniff
  · X-Frame-Options: DENY (previene clickjacking)
  · X-XSS-Protection: 1; mode=block
  · Referrer-Policy: strict-origin-when-cross-origin
  · Permissions-Policy (cámara, micrófono y geolocalización desactivados)
  · Cross-Origin-Opener-Policy: same-origin


  7.2 Protección del panel administrativo
  ---------------------------------------------------------------------------

  El acceso al backoffice está protegido por múltiples capas:

  · Ruta oculta no predecible ni indexada por buscadores
  · Verificación de sesión mediante tokens en cookies HttpOnly + Secure
    + SameSite=Lax
  · Comprobación de que el usuario autenticado figure en la tabla
    admin_users (no basta con tener cuenta en Supabase Auth)
  · Verificación de que la cuenta de administrador esté activa
  · Rate limiting en el login: máximo 5 intentos en 15 minutos por IP
  · Posibilidad de configurar whitelist de IPs autorizadas
  · Registro de auditoría de accesos en producción
  · Separación total: las cuentas de administrador no pueden acceder
    al checkout ni confundirse con cuentas de cliente


  7.3 Protección de credenciales
  ---------------------------------------------------------------------------

  Ninguna clave secreta se almacena en el código fuente ni se expone al
  navegador. Las credenciales de Supabase (service_role), Stripe
  (secret_key, webhook_secret), Brevo (API key) y Cloudinary (api_secret)
  se gestionan exclusivamente como variables de entorno del servidor.
  Astro garantiza a nivel de framework que las variables sin el prefijo
  PUBLIC_ nunca se incluyen en el bundle del cliente.


  7.4 Prevención de ataques comunes
  ---------------------------------------------------------------------------

  · XSS — Escape de HTML en todas las inserciones dinámicas de contenido,
    tanto en el front como en los templates de email
  · Inyección — Validación UUID con regex en todos los endpoints API,
    sanitización de inputs con longitudes máximas
  · Sobrecarga — Rate limiting en endpoints sensibles (login, newsletter,
    contacto, autocompletado) con clase reutilizable y auto-purga
  · CSRF — Verificación de firma en el webhook de Stripe (constructEvent)
  · Sobreventa — Stock atómico con bloqueo de fila a nivel de BD
    (ver sección 3.2)


================================================================================
  8. NOTIFICACIONES Y COMUNICACIONES
================================================================================

  El sistema envía emails transaccionales reales a través de la API de
  Brevo (anteriormente Sendinblue):

  · Factura al confirmar el pago — Se envía automáticamente tras la
    verificación del webhook de Stripe, con el PDF de la factura como
    archivo adjunto y un resumen visual de los productos comprados
    en el cuerpo del email

  · Nota de abono al procesar una devolución — Se envía al aprobar
    la solicitud de devolución, con el PDF del abono rectificativo
    adjunto

  · Formulario de contacto — Los mensajes enviados por los clientes
    desde la página de contacto se reenvían por email al equipo de
    administración

  Todos los emails utilizan templates HTML profesionales con estilos
  inline para garantizar compatibilidad con los principales clientes
  de correo.


================================================================================
  9. DESPLIEGUE Y PUESTA EN PRODUCCIÓN
================================================================================

  9.1 Contenedorización
  ---------------------------------------------------------------------------

  La aplicación se distribuye como imagen Docker construida en múltiples
  etapas para minimizar el tamaño final:

  Etapa 1 (base)    — Imagen Node.js 20 sobre Alpine Linux
  Etapa 2 (deps)    — Instalación de dependencias de producción (npm ci)
  Etapa 3 (build)   — Compilación del proyecto con las variables de
                       entorno inyectadas como build args
  Etapa 4 (runtime) — Imagen final con únicamente el directorio dist/
                       y las dependencias necesarias

  El servidor arranca con el comando:
    node ./dist/server/entry.mjs

  Escuchando en 0.0.0.0:4321 por defecto.

  Adicionalmente, se incluye un archivo nixpacks.toml como configuración
  alternativa para despliegues directos en plataformas como Coolify.


  9.2 Variables de entorno
  ---------------------------------------------------------------------------

  La configuración sensible se inyecta mediante variables de entorno en
  el momento del despliegue. Las principales son:

  · PUBLIC_SUPABASE_URL         — URL del proyecto Supabase (pública)
  · PUBLIC_SUPABASE_ANON_KEY    — Clave anónima de Supabase (pública, 
                                   protegida por RLS)
  · SUPABASE_SERVICE_ROLE_KEY   — Clave de servicio (solo servidor)
  · STRIPE_SECRET_KEY           — Clave secreta de Stripe (solo servidor)
  · STRIPE_WEBHOOK_SECRET       — Secreto para verificar webhooks
  · BREVO_API_KEY               — Clave de API de Brevo (solo servidor)
  · CLOUDINARY_CLOUD_NAME       — Nombre del cloud de Cloudinary
  · CLOUDINARY_API_KEY          — Clave de API de Cloudinary
  · CLOUDINARY_API_SECRET       — Secreto de Cloudinary (solo servidor)


================================================================================
  10. DOCUMENTACIÓN TÉCNICA COMPLEMENTARIA
================================================================================

  El repositorio incluye la siguiente documentación adicional:

  · README.md                          Guía principal del proyecto
  · INSTALACION.md                     Instrucciones de instalación local
  · ARQUITECTURA_DIAGRAMAS.md          Diagramas de arquitectura del sistema
  · ARQUITECTURA_SEGURIDAD_TOTAL.md    Modelo de seguridad completo
  · ARQUITECTURA_BUSQUEDA_FILTROS.md   Diseño del sistema de búsqueda
  · SISTEMA_RESERVA_STOCK.md           Patrón de reserva temporal de stock
  · STRIPE_SETUP.md                    Configuración de la pasarela de pagos
  · SUPABASE_SETUP.md                  Configuración de la base de datos
  · CLOUDINARY_SETUP.md                Configuración del servicio multimedia
  · SECURITY_IMPLEMENTATION.md         Detalle de la implementación de seguridad
  · RESUMEN_EJECUTIVO.md               Visión ejecutiva del proyecto


================================================================================

  Stack tecnológico resumido
  ─────────────────────────

  Frontend       Astro 5 · React 18 · Tailwind CSS 3 · TypeScript 5
                 Nanostores + @nanostores/persistent

  Backend        Supabase (PostgreSQL 15 · Auth · RLS · Stored Procedures)
                 Stripe (pagos · reembolsos · webhooks)
                 Brevo (emails transaccionales con adjuntos PDF)

  Multimedia     Cloudinary (CDN · transformaciones · optimización auto)

  Herramientas   jsPDF · Chart.js · pg_trgm

  Despliegue     Docker multi-stage (Node 20 Alpine) · Nixpacks · Coolify

================================================================================
                          FIN DE LA FICHA TÉCNICA
================================================================================
