================================================================================
               FICHA TÉCNICA — FASHIONSTORE (Proyecto Tienda Online)
================================================================================
  Autor:       Ismael
  Fecha:       Febrero 2026
  Repositorio: https://github.com/IsmaelFV/ProyectoTiendaOnline
  Stack:       Astro 5 + Supabase + Stripe + Tailwind CSS
================================================================================


================================================================================
  ÍNDICE
================================================================================
  1. Stack Tecnológico y Arquitectura General
  2. Base de Datos y Lógica Crítica (Supabase)
  3. Funcionalidad Tienda Pública (UX/UI)
  4. Backoffice y Gestión Administrativa
  5. Despliegue y Entrega
  6. Seguridad (transversal)
  7. Bonus — Emails Transaccionales
  8. Resumen de Autoevaluación según Rúbrica
================================================================================


================================================================================
  1. ARQUITECTURA Y STACK TECNOLÓGICO (Rúbrica: 2.0 puntos)
================================================================================

  1.1 Astro Híbrido — SSG/SSR                            [0.75 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivo: astro.config.mjs
  - Configuración: output: 'server' con adaptador @astrojs/node (standalone)
  - Integraciones: @astrojs/react, @astrojs/tailwind, @astrojs/sitemap
  - Las páginas de catálogo público y fichas de producto se renderizan en el
    servidor con datos frescos de Supabase (SSR). Las páginas estáticas
    (privacidad, sostenibilidad, contacto) se pre-renderizan (SSG).
  - El Admin, Carrito y Checkout son completamente dinámicos (SSR), nunca
    se cachean en el CDN porque dependen del estado de sesión del usuario.

  1.2 Islas y Estado (Nano Stores)                        [0.75 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos:
    · src/stores/cartStore.ts    — Estado del carrito con persistentAtom
    · src/stores/sessionStore.ts — Estado de sesión del usuario
    · src/stores/filterStore.ts  — Filtros de búsqueda y navegación
  - Implementación:
    · Se usa "Islands Architecture" de Astro: solo los componentes React
      interactivos (SearchBar, AddToCartButton, CartSlideOver, SizeRecommender,
      NewsletterPopup, etc.) se hidratan en el navegador.
    · El carrito persiste entre navegaciones usando @nanostores/persistent
      con la directiva persistentAtom que serializa a localStorage.
    · Interfaz CartItem tipada con: id, name, slug, price, salePrice,
      quantity, image, size, stock, isOnSale.

  1.3 Calidad de Código y TypeScript                      [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos de tipos:
    · src/types/index.ts       — Product, Category, Order, OrderItem,
                                  Invoice, CreditNote, ReturnRequest,
                                  DiscountCode, AdminUser, etc.
    · src/types/supabase.ts    — Tipos autogenerados de Supabase (Database)
  - Estructura de carpetas modular:
    src/
    ├── components/
    │   ├── admin/        → Componentes del panel admin
    │   ├── islands/      → Componentes React hidratados (islas)
    │   ├── navigation/   → Navbar, MobileMenu, Breadcrumb
    │   ├── product/      → ProductCard, ProductGrid, Gallery
    │   ├── search/       → SearchBar con autocompletado
    │   └── ui/           → Footer, Newsletter, Botones, Modales
    ├── layouts/          → AdminLayout, BaseLayout, PublicLayout
    ├── lib/              → 14+ módulos TS (auth, brevo, cloudinary,
    │                       invoice-pdf, credit-note-pdf, rate-limit,
    │                       search, supabase, stripe, logger, etc.)
    ├── pages/
    │   ├── api/          → 20+ API endpoints REST tipados
    │   ├── internal-admin/ → Panel admin (ruta oculta)
    │   ├── checkout/     → Flujo de pago
    │   ├── perfil/       → Área de usuario
    │   └── productos/    → Catálogo público
    ├── stores/           → Nano Stores (cart, session, filters)
    ├── styles/           → Estilos globales
    └── scripts/          → Scripts auxiliares


================================================================================
  2. BASE DE DATOS Y LÓGICA CRÍTICA — SUPABASE (Rúbrica: 2.5 puntos)
================================================================================

  2.1 Esquema y Relaciones                                [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos: supabase-schema.sql, supabase-schema-secure.sql
  - Tablas normalizadas:
    · products       — Catálogo (precios en céntimos de euro como enteros)
    · categories     — Jerarquía padre/hijo con parent_id
    · genders        — Hombre/Mujer para segmentación
    · orders         — Pedidos con 7 estados y datos de envío
    · order_items    — Líneas de pedido con FK a products y orders
    · invoices       — Facturas y notas de abono (rectificativas)
    · invoice_items  — Líneas de factura
    · newsletter_subscribers — Captación de leads
    · discount_codes — Códigos promocionales con límites de uso
    · admin_users    — Tabla separada de administradores
    · stock_reservations — Reservas temporales de stock (TTL 15 min)
    · persistent_cart — Carrito persistente por usuario
    · wishlist       — Lista de deseos
  - Claves foráneas correctas entre todas las tablas (ON DELETE CASCADE/SET NULL
    según corresponda). Constraints CHECK en precios, stock >= 0, formatos
    regex para slugs. Índices optimizados con pg_trgm para búsqueda full-text.

  2.2 Atomicidad y Stock                                  [1.00 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos: sql-decrement-stock.sql, sql-increment-stock.sql,
    setup-cron-reservations.sql, verificar-funciones-stock.sql
  - Implementación:
    · Función PL/pgSQL "decrement_stock()" con SECURITY DEFINER que decrementa
      atómicamente el stock usando FOR UPDATE (bloqueo de fila).
    · Función PL/pgSQL "validate_and_decrement_stock()" que recibe un JSON
      array de items y valida stock suficiente ANTES de decrementar.
    · Sistema de Reservas de Stock: "reserve_stock()" con SELECT...FOR UPDATE,
      stock efectivo = stock real - stock reservado, TTL de 15 minutos,
      función "expire_reservations()" para liberar reservas caducadas.
    · Al cancelar un pedido ("No enviado"), el stock se restaura
      automáticamente vía "increment_stock()" con SECURITY DEFINER.
    · Anti-overselling: No se permite vender si stock <= 0 o stock
      reservado >= stock real.

  2.3 Seguridad (RLS y Auth)                              [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivo: supabase-schema-secure.sql, politicas-seguridad-correctas.sql
  - RLS (Row Level Security) activado en TODAS las tablas sensibles:
    · products, categories, genders: lectura pública, escritura solo admin
    · orders, order_items: solo el propietario lee sus pedidos
    · invoices: solo el propietario accede a sus facturas
    · admin_users: solo el service_role puede leer/escribir
  - Auth:
    · Middleware en src/middleware.ts verifica admin REAL (tabla admin_users)
    · Cookies HttpOnly + Secure + SameSite=Lax
    · Rate limiting en login: 5 intentos / 15 minutos
    · Separación total de cuentas: admin_users ≠ auth.users

  2.4 Storage y Multimedia                                [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos: src/lib/cloudinary.ts, src/components/admin/ImageUpload.tsx
  - Implementación:
    · Cloudinary como CDN de imágenes con optimización automática
    · Funciones: uploadImage(), deleteImage(), optimizeImage()
    · Transformaciones: formato WebP/AVIF, resize, crop, calidad auto
    · Componente React de subida con Drag & Drop, preview, barra de
      progreso, validación de tipo/tamaño, reordenación de imágenes,
      botón de eliminar e indicador "Principal"
    · Las imágenes se optimizan en el front con lazy loading y srcset


================================================================================
  3. FUNCIONALIDAD TIENDA PÚBLICA — UX/UI (Rúbrica: 2.0 puntos)
================================================================================

  3.1 Diseño y UX "Premium"                               [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivo: tailwind.config.mjs
  - Estética minimalista premium con Tailwind CSS:
    · Paleta personalizada: brand-navy, brand-gold, brand-cream, brand-sage,
      grises 50-950, dark mode completo
    · Tipografías: Playfair Display (serif, títulos) + Inter (sans, cuerpo)
    · Shadows custom: soft, glass, elevated, card, premium
    · Animaciones: fade-in, slide-up, pulse-soft, shimmer, glow-pulse
    · Responsividad completa: Mobile-first, breakpoints sm/md/lg/xl
    · Slide-over del carrito (CartSlideOver.tsx) funcional con animación
    · Diseño tipo H&M / Zara con navegación por género

  3.2 Buscador y Filtros                                  [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos: src/components/search/SearchBar.tsx,
    src/pages/api/search/autocomplete.ts, src/lib/search.ts
  - Implementación:
    · Buscador "Live Search" con debounce de 300ms
    · Autocompletado con dropdown de sugerencias
    · Navegación con teclado (ArrowDown/Up/Enter/Escape)
    · API de autocompletado con rate limiting
    · Filtros por categoría, género, precio, colores, tallas, stock,
      novedades, rebajas, ordenación (precio, nombre, novedades)
    · Paginación con botón "Cargar más" (load-more) con API REST
    · Búsqueda por trigramas (pg_trgm) para tolerancia a typos

  3.3 Marketing (Newsletter / Ofertas)                    [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos: src/components/ui/NewsletterPopup.tsx,
    src/pages/api/newsletter/subscribe.ts,
    src/pages/internal-admin/ofertas/index.astro,
    src/pages/internal-admin/codigos-promocionales/index.astro
  - Implementación:
    · Pop-up de captación de leads que aparece a los 5 segundos en la
      primera visita (controlado por localStorage)
    · Código promocional BIENVENIDO10 incluido en el popup
    · Sección "Ofertas Flash" controlada por interruptor desde el admin
      (campo is_on_sale en products, con sale_price independiente)
    · Códigos de descuento configurables: porcentaje o fijo, con fecha
      inicio/fin, límite de usos, mínimo de compra
    · API de newsletter con rate limiting (5 intentos / 10 min)

  3.4 Recomendador de Talla                               [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivo: src/components/islands/SizeRecommender.tsx (729 líneas)
  - Implementación:
    · Modal multi-paso (isla React hidratada):
      Paso 1: Género (hombre/mujer)
      Paso 2: Medidas corporales (pecho, cintura, cadera, altura en cm)
      Paso 3: Preferencia de ajuste (ajustado/normal/holgado)
    · Tablas de medidas europeas completas (XS a XXL)
    · Algoritmo de scoring 0-100 con función de distancia ponderada
    · Diferenciación de rangos por género
    · Mapeo tallas numéricas (36-52) ↔ letras (XS-XXL)
    · Niveles de confianza: perfecto | bueno | aproximado
    · Perfil de talla guardado en localStorage para futuras compras


================================================================================
  4. BACKOFFICE Y GESTIÓN ADMINISTRATIVA (Rúbrica: 2.5 puntos)
================================================================================

  4.1 Dashboard y KPIs                                    [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos: src/pages/internal-admin/index.astro,
    src/components/admin/SalesChart.tsx
  - Implementación:
    · Tarjetas de métricas conectadas a Supabase:
      - Ventas totales (SUM de orders.total donde status != cancelado)
      - Número de pedidos (COUNT de orders)
      - Ventas del mes actual
      - Producto más vendido
    · Gráfico de líneas Chart.js con doble eje Y:
      - Eje izquierdo: Ventas en EUR
      - Eje derecho: Número de pedidos
    · Datos de los últimos 7 días calculados con SQL (GROUP BY día)
    · Distribución de estados de pedidos en la página del dashboard
    · Colores brand-navy y brand-gold en los gráficos

  4.2 Gestión de Pedidos                                  [0.75 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos: src/pages/internal-admin/pedidos/index.astro,
    src/pages/internal-admin/pedidos/[id].astro,
    src/pages/api/admin/orders/update-status.ts
  - Flujo completo de estados:
    pending → confirmed → processing → shipped → delivered
                                                 → cancelled (antes de envío)
                                                 → refunded
  - Funcionalidades:
    · Listado con filtro por estado y búsqueda por nº pedido
    · Detalle con timeline visual de progreso del pedido
    · Cambio de estado con validación (solo transiciones permitidas)
    · Cancelación antes del envío: restaura stock automáticamente
      vía increment_stock() (RPC atómica)
    · Estados de pago independientes: pending/paid/failed/refunded
    · Historial de cambios en admin_notes

  4.3 Facturación y Abonos                                [1.25 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos: src/lib/invoice-pdf.ts, src/lib/credit-note-pdf.ts,
    src/lib/invoice-service.ts, src/pages/api/orders/credit-note.ts
  - Implementación COMPLETA:
    · FACTURA al comprar:
      - Se genera automáticamente al confirmar pago (webhook de Stripe)
      - PDF con jsPDF: header con logo, nº factura secuencial, datos
        del cliente, tabla de productos con imágenes, desglose
        subtotal/envío/IVA/total en EUR
      - Se persiste en tabla invoices (tipo = 'invoice')
      - Se envía por email al cliente con PDF adjunto
    · FACTURA DE ABONO (Rectificativa) al devolver:
      - PDF generado por credit-note-pdf.ts con importes NEGATIVOS
      - Referencia al pedido original y factura rectificada
      - Motivo de devolución incluido
      - Referencia legal: Art. 15 del RD 1619/2012
      - Se persiste en tabla invoices (tipo = 'credit_note')
      - Se envía automáticamente por email al cliente
    · Servicio centralizado (invoice-service.ts):
      - Genera número secuencial (FACT-2026-000001, ABON-2026-000001)
      - Crea PDF, persiste en BD, envía por email
      - Usado tanto por el webhook como por el endpoint de devoluciones

  4.4 Extras del Admin
  ---------------------------------------------------------------------------
  - Gestión de productos: CRUD completo con imágenes Drag & Drop
  - Gestión de ofertas: activar/desactivar rebajas, precio de oferta
  - Códigos promocionales: crear, editar, desactivar, límites de uso
  - Gestión de clientes: listado, detalle, historial de pedidos
  - Gestión de devoluciones: aprobar/rechazar, reembolso vía Stripe
  - Configuración: datos de la tienda, ajustes generales


================================================================================
  5. DESPLIEGUE Y ENTREGA (Rúbrica: 1.0 punto)
================================================================================

  5.1 Despliegue VPS (Coolify)                            [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos: Dockerfile, nixpacks.toml
  - Dockerfile multi-stage (4 fases):
    · base:    Node 20 Alpine
    · deps:    npm ci (solo dependencias de producción)
    · build:   npm run build (todas las env vars como build args)
    · runtime: Imagen final mínima con solo dist/ y node_modules
    · HOST=0.0.0.0, PORT=4321
    · CMD ["node", "./dist/server/entry.mjs"]
  - nixpacks.toml como alternativa para Coolify:
    · Node 20, npm ci, npm run build, start con HOST=0.0.0.0
  - Variables de entorno seguras (nunca en código fuente):
    · SUPABASE_SERVICE_ROLE_KEY, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET,
      BREVO_API_KEY, CLOUDINARY_API_SECRET → solo server-side via
      import.meta.env (Astro las oculta del cliente automáticamente)

  5.2 Documentación Técnica                               [0.50 pts — CUMPLE]
  ---------------------------------------------------------------------------
  - Archivos de documentación incluidos en el repositorio:
    · README.md                    — Guía principal del proyecto
    · ARQUITECTURA_DIAGRAMAS.md    — Diagramas de arquitectura
    · ARQUITECTURA_SEGURIDAD_TOTAL.md — Modelo de seguridad completo
    · ARQUITECTURA_BUSQUEDA_FILTROS.md — Sistema de búsqueda
    · SISTEMA_RESERVA_STOCK.md     — Patrón de reserva de stock
    · STRIPE_SETUP.md              — Configuración de pagos
    · SUPABASE_SETUP.md            — Configuración de base de datos
    · CLOUDINARY_SETUP.md          — Configuración de multimedia
    · SECURITY_IMPLEMENTATION.md   — Implementación de seguridad
    · INSTALACION.md               — Guía de instalación
    · RESUMEN_EJECUTIVO.md         — Resumen ejecutivo del proyecto


================================================================================
  6. SEGURIDAD (Transversal — no puntuada directamente pero evita penalizaciones)
================================================================================

  6.1 Headers HTTP de Seguridad (src/middleware.ts)
  ---------------------------------------------------------------------------
  - Strict-Transport-Security (HSTS) con preload
  - Content-Security-Policy estricto (script-src, img-src, connect-src, etc.)
  - X-Content-Type-Options: nosniff
  - X-Frame-Options: DENY
  - X-XSS-Protection: 1; mode=block
  - Referrer-Policy: strict-origin-when-cross-origin
  - Permissions-Policy (camera, microphone, geolocation desactivados)
  - Cross-Origin-Opener-Policy: same-origin
  - X-DNS-Prefetch-Control: on

  6.2 Protección de Claves                              [Sin penalización]
  ---------------------------------------------------------------------------
  - NINGUNA clave secreta expuesta en el repositorio público
  - Las claves de Supabase (service_role), Stripe (secret_key),
    Brevo (API key) y Cloudinary (api_secret) se acceden EXCLUSIVAMENTE
    via import.meta.env en código server-side
  - Solo PUBLIC_SUPABASE_URL y PUBLIC_SUPABASE_ANON_KEY son públicas
    (son seguras por diseño con RLS activo)
  - Archivos de debug/test con claves hardcodeadas eliminados del
    tracking de git y añadidos al .gitignore

  6.3 Rate Limiting
  ---------------------------------------------------------------------------
  - Login admin: 5 intentos / 15 minutos (en middleware)
  - Newsletter: 5 intentos / 10 minutos (clase RateLimiter reutilizable)
  - Contacto: rate limiting configurado
  - API de búsqueda: rate limiting en autocompletado

  6.4 Prevención XSS
  ---------------------------------------------------------------------------
  - Función escapeHtml() en todas las inserciones dinámicas de HTML
  - encodeURIComponent() para slugs en URLs
  - Validación UUID con regex en todos los endpoints API
  - Sanitización de inputs con longitudes máximas

  6.5 Robustez ante Errores                             [Sin penalización]
  ---------------------------------------------------------------------------
  - La aplicación NO rompe al comprar sin stock (stock atómico + validación)
  - La aplicación NO rompe al subir imágenes pesadas (validación de tamaño
    en el componente de upload + Cloudinary maneja el resize)


================================================================================
  7. BONUS — EMAILS TRANSACCIONALES (+1.0 punto)        [CUMPLE]
================================================================================

  - Archivo: src/lib/brevo.ts
  - Proveedor: Brevo (ex-Sendinblue) via API transaccional
  - Emails implementados:
    1. FACTURA al confirmar pedido:
       - PDF adjunto generado con jsPDF
       - Detalle de productos con imágenes en HTML
       - Se envía automáticamente desde el webhook de Stripe
    2. FACTURA DE ABONO al procesar devolución:
       - PDF rectificativo adjunto con importes negativos
       - Se envía automáticamente al aprobar la devolución
    3. CONTACTO:
       - Email al admin con los datos del formulario de contacto
  - Templates HTML profesionales con estilos inline
  - Función de escape HTML para prevenir XSS en emails


================================================================================
  8. RESUMEN DE AUTOEVALUACIÓN SEGÚN RÚBRICA
================================================================================

  ┌────────────────────────────────────────────┬───────────┬────────────┐
  │ Criterio                                   │ Máx. pts  │ Estimación │
  ├────────────────────────────────────────────┼───────────┼────────────┤
  │ 1.1 Astro Híbrido (SSG/SSR)               │   0.75    │    0.75    │
  │ 1.2 Islas y Estado (Nano Stores)           │   0.75    │    0.75    │
  │ 1.3 Calidad de Código y TS                 │   0.50    │    0.50    │
  ├────────────────────────────────────────────┼───────────┼────────────┤
  │ 2.1 Esquema y Relaciones                   │   0.50    │    0.50    │
  │ 2.2 Atomicidad y Stock                     │   1.00    │    1.00    │
  │ 2.3 Seguridad (RLS y Auth)                 │   0.50    │    0.50    │
  │ 2.4 Storage y Multimedia                   │   0.50    │    0.50    │
  ├────────────────────────────────────────────┼───────────┼────────────┤
  │ 3.1 Diseño y UX "Premium"                  │   0.50    │    0.50    │
  │ 3.2 Buscador y Filtros                     │   0.50    │    0.50    │
  │ 3.3 Marketing (Newsletter/Ofertas)         │   0.50    │    0.50    │
  │ 3.4 Recomendador de Talla                  │   0.50    │    0.50    │
  ├────────────────────────────────────────────┼───────────┼────────────┤
  │ 4.1 Dashboard y KPIs                       │   0.50    │    0.50    │
  │ 4.2 Gestión de Pedidos                     │   0.75    │    0.75    │
  │ 4.3 Facturación y Abonos                   │   1.25    │    1.25    │
  ├────────────────────────────────────────────┼───────────┼────────────┤
  │ 5.1 Despliegue VPS (Coolify)               │   0.50    │    0.50    │
  │ 5.2 Documentación Técnica                  │   0.50    │    0.50    │
  ├────────────────────────────────────────────┼───────────┼────────────┤
  │                              SUBTOTAL BASE │  10.00    │   10.00    │
  ├────────────────────────────────────────────┼───────────┼────────────┤
  │ Penalización: Claves expuestas (-2.0)      │           │    0.00    │
  │ Penalización: Crash sin stock (-1.0)       │           │    0.00    │
  │ Bonus: Emails reales (+1.0)                │           │   +1.00    │
  ├────────────────────────────────────────────┼───────────┼────────────┤
  │                                TOTAL FINAL │  10.00    │ 10.0/10.0  │
  │                                      Bonus │   +1.0    │   +1.0     │
  └────────────────────────────────────────────┴───────────┴────────────┘

  Nivel según rúbrica: SENIOR (9.0 - 10.0)
  "Arquitectura impecable, código limpio, gestión de errores robusta.
   El sistema de facturación y stock es a prueba de balas. UX excelente."


================================================================================
  STACK TECNOLÓGICO COMPLETO
================================================================================

  Frontend:
  - Astro 5.x (SSR) con adaptador Node.js
  - React 18 (islas interactivas)
  - Tailwind CSS 3 (diseño responsive premium)
  - TypeScript 5 (tipado estricto)
  - Nanostores + @nanostores/persistent (estado global persistente)

  Backend:
  - Supabase (PostgreSQL 15 + Auth + RLS + Stored Procedures)
  - Stripe (pagos + reembolsos + webhooks)
  - Brevo/Sendinblue (emails transaccionales)

  Multimedia:
  - Cloudinary (CDN + optimización automática + upload)

  Herramientas:
  - jsPDF (generación de facturas PDF)
  - Chart.js (gráficos del dashboard admin)
  - pg_trgm (búsqueda full-text con tolerancia a typos)

  Despliegue:
  - Docker multi-stage (Node 20 Alpine)
  - Nixpacks (compatibilidad Coolify)
  - Node.js 20 LTS

================================================================================
                              FIN DE LA FICHA TÉCNICA
================================================================================
