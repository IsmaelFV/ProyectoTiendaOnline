================================================================================
NUEVOS CAMBIOS - SISTEMA POST-VENTA Y DESCUENTOS
================================================================================
Fecha: 19 de enero de 2026
Commit: 3e16e0f - Sistema completo cancelaci√≥n pedidos, c√≥digos descuento y devoluciones
Fase: POST-VENTA (Fases 1-3 completadas)

================================================================================
√çNDICE
================================================================================
1. Sistema de Cancelaci√≥n de Pedidos (FASE 1 y 2)
2. Sistema de C√≥digos de Descuento (FASE 3)
3. Modal de Devoluciones (UI)
4. Scripts de Diagn√≥stico y Testing
5. Documentaci√≥n y Gu√≠as
6. Pr√≥ximos Pasos


================================================================================
1. SISTEMA DE CANCELACI√ìN DE PEDIDOS
================================================================================

PROBLEMA IDENTIFICADO:
- Los usuarios no pod√≠an ver sus propios pedidos en /perfil/mis-pedidos
- No exist√≠a forma de cancelar pedidos desde el frontend
- El stock no se restauraba al cancelar pedidos
- Inconsistencia en estados: webhook usa 'confirmed' pero no estaba permitido en schema

SOLUCI√ìN IMPLEMENTADA:

A) Migraci√≥n 003: Pol√≠ticas RLS
   Archivo: migrations/003_user_orders_policies.sql
   
   Pol√≠ticas creadas:
   - "Users can view their own orders"
     ‚Üí Permite SELECT de pedidos donde user_id = auth.uid()
   
   - "Users can update their own orders"
     ‚Üí Permite UPDATE para cancelaci√≥n
   
   - "Users can view items of their orders"
     ‚Üí Permite ver order_items con JOIN
   
   ‚ö†Ô∏è CR√çTICO: Esta migraci√≥n debe aplicarse PRIMERO
   Sin ella, los usuarios no ven sus pedidos aunque existan en BD

B) Migraci√≥n 004: Arreglar Estados
   Archivo: migrations/004_fix_order_states.sql
   
   Cambio en CHECK constraint:
   - Antes: 'pending', 'processing', 'paid', 'shipped', 'delivered', 'cancelled', 'refunded'
   - Ahora: + 'confirmed' (usado por webhook de Stripe)
   
   Verificaci√≥n incluida:
   - Cuenta pedidos con estados inv√°lidos
   - Muestra warning si hay datos hu√©rfanos

C) Migraci√≥n 005: Funci√≥n de Cancelaci√≥n At√≥mica
   Archivo: migrations/005_cancel_order_function.sql
   
   Funci√≥n: cancel_order_and_restore_stock(p_order_id, p_user_id)
   
   Validaciones implementadas:
   1. Pedido existe
   2. Pedido pertenece al usuario (user_id = p_user_id)
   3. Estado es 'confirmed' o 'processing'
   4. NO permite cancelar si: shipped, delivered, refunded
   
   Proceso at√≥mico (transacci√≥n impl√≠cita):
   1. Validar condiciones
   2. Iterar sobre order_items
   3. Llamar increment_stock() por cada producto
   4. Actualizar orders.status = 'cancelled'
   5. Si algo falla, se revierte TODO autom√°ticamente
   
   Retorna JSON:
   {
     "success": true|false,
     "message": "Texto descriptivo",
     "restored_items": 3  // N√∫mero de productos restaurados
   }

D) API Endpoint
   Archivo: src/pages/api/orders/cancel.ts
   
   POST /api/orders/cancel
   
   Headers requeridos:
   - Authorization: Bearer {token}
   
   Body:
   {
     "orderId": "uuid-del-pedido"
   }
   
   Flujo de validaci√≥n:
   1. Verificar header Authorization existe
   2. Extraer token y validar con supabase.auth.getUser()
   3. Verificar orderId en body
   4. Llamar funci√≥n SQL cancel_order_and_restore_stock()
   5. Retornar resultado

E) Cambios en UI
   Archivo: src/pages/perfil/mis-pedidos.astro
   
   Mejoras implementadas:
   
   1. M√©todo de autenticaci√≥n corregido:
      - Antes: createServerSupabaseClient() (fallaba con RLS)
      - Ahora: Crear cliente con tokens de cookies manualmente
      - Lee sb-access-token y sb-refresh-token de cookies
      - Establece sesi√≥n con supabase.auth.getUser()
   
   2. Modal de confirmaci√≥n de cancelaci√≥n:
      HTML:
      - Overlay semi-transparente
      - Modal centrado con advertencia
      - Botones: "S√≠, cancelar pedido" y "No, mantener pedido"
      
      JavaScript:
      - Variable currentOrderId para tracking
      - Funciones: openModal(), closeModal()
      - Click en "Cancelar pedido" ‚Üí abre modal
      - Click en "Confirmar" ‚Üí llama API
   
   3. Sistema de Toast (notificaciones):
      function showToast(message, type)
      - Tipos: 'success' (verde) o 'error' (rojo)
      - Se muestra 3 segundos y desaparece
      - Posici√≥n: fixed bottom-right
   
   4. Proceso de cancelaci√≥n:
      ```javascript
      const { createClient } = await import('@supabase/supabase-js');
      const supabase = createClient(...);
      const { data: { session } } = await supabase.auth.getSession();
      
      const response = await fetch('/api/orders/cancel', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`
        },
        body: JSON.stringify({ orderId })
      });
      
      const result = await response.json();
      if (result.success) {
        showToast(result.message);
        window.location.reload();
      }
      ```
   
   5. Bot√≥n "Cancelar pedido" solo visible si:
      - order.status === 'confirmed' || order.status === 'processing'

F) Modal de Devoluciones (Nuevo)
   Tambi√©n en src/pages/perfil/mis-pedidos.astro
   
   Trigger:
   - Bot√≥n "Solicitar devoluci√≥n" visible si order.status === 'delivered'
   
   Contenido del modal:
   - N√∫mero de pedido (copiable)
   - Condiciones de devoluci√≥n:
     ‚Ä¢ 30 d√≠as desde recepci√≥n
     ‚Ä¢ Productos sin usar con etiquetas
     ‚Ä¢ Comprobante de compra incluido
     ‚Ä¢ Productos en oferta no reembolsables
     ‚Ä¢ Gastos de devoluci√≥n a cargo del cliente
   
   - Informaci√≥n de contacto:
     ‚Ä¢ Email: devoluciones@tienda.com (link mailto con asunto prellenado)
     ‚Ä¢ Tel√©fono: +34 900 123 456
   
   - Botones:
     ‚Ä¢ "Copiar n¬∫ de pedido" ‚Üí navigator.clipboard.writeText()
     ‚Ä¢ "Enviar email" ‚Üí abre cliente de correo con template
   
   ‚ö†Ô∏è IMPORTANTE: Este modal es solo informativo
   No crea registro en BD ni gestiona devoluciones autom√°ticamente


================================================================================
2. SISTEMA DE C√ìDIGOS DE DESCUENTO
================================================================================

PROBLEMA IDENTIFICADO:
- No exist√≠a sistema de promociones
- No hab√≠a forma de aplicar descuentos en el checkout
- Necesidad de c√≥digos limitados por tiempo y usos

SOLUCI√ìN IMPLEMENTADA:

A) Migraci√≥n 006: Tabla y Funciones
   Archivo: migrations/006_discount_codes.sql
   
   Tabla: discount_codes
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ Campo               ‚îÇ Tipo         ‚îÇ Descripci√≥n                 ‚îÇ
   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ id                  ‚îÇ UUID         ‚îÇ Primary key                 ‚îÇ
   ‚îÇ code                ‚îÇ TEXT UNIQUE  ‚îÇ C√≥digo (case-insensitive)   ‚îÇ
   ‚îÇ description         ‚îÇ TEXT         ‚îÇ Descripci√≥n interna         ‚îÇ
   ‚îÇ discount_type       ‚îÇ TEXT         ‚îÇ 'percentage' o 'fixed'      ‚îÇ
   ‚îÇ discount_value      ‚îÇ DECIMAL      ‚îÇ 10 (%) o 5 (‚Ç¨)              ‚îÇ
   ‚îÇ valid_from          ‚îÇ TIMESTAMPTZ  ‚îÇ Fecha inicio validez        ‚îÇ
   ‚îÇ valid_until         ‚îÇ TIMESTAMPTZ  ‚îÇ Fecha fin (NULL = ilimitado)‚îÇ
   ‚îÇ max_uses            ‚îÇ INTEGER      ‚îÇ L√≠mite usos (NULL = ‚àû)      ‚îÇ
   ‚îÇ uses_count          ‚îÇ INTEGER      ‚îÇ Contador actual de usos     ‚îÇ
   ‚îÇ min_purchase_amount ‚îÇ DECIMAL      ‚îÇ Compra m√≠nima requerida     ‚îÇ
   ‚îÇ is_active           ‚îÇ BOOLEAN      ‚îÇ Activar/desactivar          ‚îÇ
   ‚îÇ created_at          ‚îÇ TIMESTAMPTZ  ‚îÇ Fecha creaci√≥n              ‚îÇ
   ‚îÇ updated_at          ‚îÇ TIMESTAMPTZ  ‚îÇ Auto-actualizado            ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   
   √çndices creados:
   - idx_discount_codes_code (b√∫squeda r√°pida por c√≥digo)
   - idx_discount_codes_active (filtrado de c√≥digos activos)
   
   Funci√≥n 1: validate_discount_code(p_code, p_cart_total, p_user_id)
   
   Validaciones que realiza:
   1. ¬øEl c√≥digo existe y est√° activo?
   2. ¬øEst√° dentro del periodo de validez? (valid_from <= NOW() <= valid_until)
   3. ¬øNo ha excedido el l√≠mite de usos? (uses_count < max_uses)
   4. ¬øEl total del carrito cumple el m√≠nimo? (p_cart_total >= min_purchase_amount)
   
   C√°lculo de descuento:
   - Si discount_type = 'percentage':
     discount_amount = ROUND(p_cart_total * discount_value / 100, 2)
   
   - Si discount_type = 'fixed':
     discount_amount = discount_value
   
   - Si discount_amount > p_cart_total:
     discount_amount = p_cart_total  (evita totales negativos)
   
   Retorna JSON:
   {
     "valid": true|false,
     "code": "BIENVENIDA10",
     "discount_type": "percentage",
     "discount_value": 10,
     "discount_amount": 5.00,
     "original_total": 50.00,
     "final_total": 45.00,
     "message": "C√≥digo aplicado: -5.00‚Ç¨"
   }
   
   ‚ö†Ô∏è IMPORTANTE: Esta funci√≥n NO incrementa uses_count
   Solo valida y calcula el descuento
   
   Funci√≥n 2: increment_discount_usage(p_code)
   
   Prop√≥sito:
   - Incrementar uses_count tras pago confirmado
   - Llamada desde webhook de Stripe
   - SECURITY DEFINER (solo service_role puede ejecutar)
   
   UPDATE discount_codes
   SET uses_count = uses_count + 1
   WHERE UPPER(code) = UPPER(p_code) AND is_active = true;
   
   Pol√≠ticas RLS:
   - Anyone can view active discount codes (SELECT)
     ‚Üí Permite validaci√≥n desde frontend
   
   - Service role can manage discount codes (ALL)
     ‚Üí Solo admins pueden crear/editar/eliminar
   
   C√≥digos de ejemplo insertados:
   1. BIENVENIDA10
      - 10% descuento
      - Compra m√≠nima: 20‚Ç¨
      - M√°ximo 100 usos
   
   2. PRIMERACOMPRA
      - 5‚Ç¨ descuento fijo
      - Compra m√≠nima: 30‚Ç¨
      - Usos ilimitados
   
   3. VERANO2026
      - 15% descuento
      - Compra m√≠nima: 50‚Ç¨
      - M√°ximo 500 usos

B) Componentes UI
   
   Opci√≥n 1: DiscountCodeInput.tsx (React Island)
   Archivo: src/components/islands/DiscountCodeInput.tsx
   
   Props:
   - cartTotal: number (en centavos)
   - onDiscountApplied: (data) => void (callback)
   
   Estado:
   - code: string (c√≥digo ingresado)
   - isValidating: boolean (loading state)
   - appliedDiscount: object | null (descuento aplicado)
   - error: string (mensaje de error)
   
   Funcionalidades:
   - Input uppercase autom√°tico
   - Validaci√≥n en tiempo real con Supabase RPC
   - Rec√°lculo autom√°tico si cambia cartTotal
   - Guardado en sessionStorage
   - Box verde con c√≥digo aplicado
   - Bot√≥n "Quitar" para remover descuento
   
   Conversi√≥n de unidades:
   - Frontend trabaja en centavos (5000 = 50‚Ç¨)
   - SQL trabaja en euros (50.00)
   - Componente convierte: cartTotal / 100 al validar
   - Componente convierte: result * 100 al guardar
   
   Opci√≥n 2: DiscountCodeInput.astro (Astro Component)
   Archivo: src/components/ui/DiscountCodeInput.astro
   
   Similar al componente React pero en Astro puro
   - Script inline con client:load
   - Misma l√≥gica de validaci√≥n
   - Mismo dise√±o UI
   
   ‚ö†Ô∏è ELEGIR UNA OPCI√ìN: Usar React o Astro, no ambas

C) Integraci√≥n con Checkout (PENDIENTE)
   
   Archivos a modificar:
   1. src/pages/api/checkout/create-session.ts
   2. src/pages/api/webhooks/stripe.ts
   
   Flujo propuesto:
   
   En create-session.ts:
   ```typescript
   const { items, discountCode } = await request.json();
   
   let discount = null;
   if (discountCode) {
     const { data } = await supabase.rpc('validate_discount_code', {
       p_code: discountCode,
       p_cart_total: cartTotal / 100
     });
     
     if (data.valid) {
       discount = data;
     } else {
       // Cancelar reservas y retornar error
       return new Response(JSON.stringify({
         error: data.message
       }), { status: 400 });
     }
   }
   
   // Crear cup√≥n din√°mico en Stripe
   let coupon = null;
   if (discount) {
     const couponData = await stripe.coupons.create({
       amount_off: Math.round(discount.discount_amount * 100), // centavos
       currency: 'eur',
       name: discount.code
     });
     coupon = couponData.id;
   }
   
   const session = await stripe.checkout.sessions.create({
     line_items: [...],
     discounts: coupon ? [{ coupon }] : [],
     metadata: {
       discount_code: discountCode || null,
       discount_amount: discount?.discount_amount || 0
     }
   });
   ```
   
   En webhook stripe.ts:
   ```typescript
   if (event.type === 'checkout.session.completed') {
     const session = event.data.object;
     const discountCode = session.metadata.discount_code;
     
     // Crear orden con descuento
     const { data: order } = await supabase.from('orders').insert({
       ...orderData,
       discount: session.total_details.amount_discount / 100,
       customer_notes: discountCode 
         ? `C√≥digo descuento aplicado: ${discountCode}`
         : null
     });
     
     // Incrementar contador de usos
     if (discountCode) {
       await supabase.rpc('increment_discount_usage', {
         p_code: discountCode
       });
     }
   }
   ```


================================================================================
3. SCRIPTS DE DIAGN√ìSTICO Y TESTING
================================================================================

A) Script PowerShell Autom√°tico
   Archivo: aplicar-migraciones-pedidos.ps1
   
   Prop√≥sito:
   - Aplicar migraciones 003, 004, 005 autom√°ticamente
   - Usar API REST de Supabase
   - Requiere .env con SUPABASE_URL y SERVICE_ROLE_KEY
   
   Uso:
   ```powershell
   .\aplicar-migraciones-pedidos.ps1
   ```
   
   Orden de ejecuci√≥n:
   1. CR√çTICO: 003_user_orders_policies.sql
   2. REQUERIDO: 004_fix_order_states.sql
   3. REQUERIDO: 005_cancel_order_function.sql
   
   Si falla alguna:
   - Muestra error y contin√∫a con las siguientes
   - Al final muestra resumen y instrucciones manuales

B) SQL de Diagn√≥stico
   
   diagnostico-pedidos.sql
   - 7 pasos de verificaci√≥n
   - Queries paso a paso con preguntas
   - Detecta si hay pedidos, user_id NULL, problemas RLS
   - Incluye instrucciones en comentarios
   
   verificar-pedidos-rapido.sql
   - Quick check de 4 queries
   - Cuenta total pedidos
   - Lista √∫ltimos 5 con indicador INVITADO/UUID
   - Verifica pol√≠ticas RLS activas
   
   verificar-cuenta-email.sql
   - Busca user_id por email espec√≠fico
   - Lista pedidos de esa cuenta
   - √ötil para troubleshooting de cuentas espec√≠ficas

C) P√°gina de Testing
   Archivo: src/pages/test-session.astro
   
   URL: http://localhost:4321/test-session
   
   Muestra:
   - Estado de sesi√≥n actual (user_id, email)
   - Pedidos encontrados con el user_id actual
   - Comparaci√≥n con user_id esperado
   - Lista de todos los pedidos en BD
   - Instrucciones de soluci√≥n
   
   Dise√±o:
   - Estilo terminal (fondo oscuro, texto verde)
   - Secciones numeradas
   - Colores: verde (success), rojo (error), amarillo (warning)


================================================================================
4. DOCUMENTACI√ìN Y GU√çAS
================================================================================

A) PLAN_IMPLEMENTACION.md
   
   Contenido:
   - Estado actual verificado del proyecto
   - Inconsistencia detectada (estado 'confirmed')
   - Plan de 5 fases detallado:
     ‚Ä¢ Fase 1: Arreglar estados
     ‚Ä¢ Fase 2: Cancelaci√≥n at√≥mica
     ‚Ä¢ Fase 3: C√≥digos de descuento
     ‚Ä¢ Fase 4: Modal devoluciones
     ‚Ä¢ Fase 5: Popup promocional (pendiente)
   - Reglas de seguridad (qu√© NO hacer)
   - Orden de implementaci√≥n

B) FASE_1_2_COMPLETADA.md
   
   Contenido:
   - Lista de archivos creados/modificados
   - Descripci√≥n detallada de cada migraci√≥n
   - Verificaciones de seguridad
   - Instrucciones de testing paso a paso
   - Verificaci√≥n de stock restaurado
   - Notas importantes

C) FASE_3_COMPLETADA.md
   
   Contenido:
   - Sistema de descuentos implementado
   - Archivos creados (migraci√≥n + componentes)
   - Instrucciones de integraci√≥n en carrito
   - C√≥digos de ejemplo para probar
   - Validaciones implementadas
   - Flujo completo del sistema
   - Pr√≥ximos pasos (gesti√≥n admin)

D) FIX_PEDIDOS_NO_VISIBLES.md
   
   Contenido:
   - Problema: Pedidos no aparecen en /perfil/mis-pedidos
   - Causa: Pol√≠ticas RLS bloqueando acceso
   - Soluci√≥n r√°pida (script autom√°tico)
   - Soluci√≥n manual en Supabase
   - Verificaci√≥n de que funciona
   - Troubleshooting adicional


================================================================================
5. PR√ìXIMOS PASOS Y PENDIENTES
================================================================================

IMPLEMENTADO ‚úÖ:
- [x] Pol√≠ticas RLS para pedidos (Fase 1)
- [x] Arreglar estados del schema (Fase 1)
- [x] Funci√≥n de cancelaci√≥n at√≥mica (Fase 2)
- [x] API endpoint de cancelaci√≥n (Fase 2)
- [x] UI con modal de confirmaci√≥n (Fase 2)
- [x] Tabla de c√≥digos de descuento (Fase 3)
- [x] Funciones SQL de validaci√≥n (Fase 3)
- [x] Componentes UI para descuentos (Fase 3)
- [x] Modal de devoluciones informativo (Fase 4)
- [x] Scripts de diagn√≥stico SQL
- [x] Script PowerShell automatizado
- [x] Documentaci√≥n completa

PENDIENTE ‚è≥:

1. Integraci√≥n de Descuentos en Checkout (FASE 3 - Backend)
   Archivos a modificar:
   - src/pages/api/checkout/create-session.ts
     ‚Üí Recibir discountCode en body
     ‚Üí Validar con validate_discount_code()
     ‚Üí Crear cup√≥n din√°mico en Stripe
     ‚Üí Guardar en metadata
   
   - src/pages/api/webhooks/stripe.ts
     ‚Üí Leer discount_code de metadata
     ‚Üí Guardar descuento en orders.discount
     ‚Üí Llamar increment_discount_usage()
   
   - src/pages/carrito.astro o similar
     ‚Üí Integrar componente DiscountCodeInput
     ‚Üí Enviar c√≥digo al crear checkout session

2. Sistema de Devoluciones Completo (FASE 4 - Backend)
   Tareas:
   - Crear tabla returns en BD
   - Funci√≥n SQL create_return_request()
   - API endpoint POST /api/returns/create
   - Integrar con modal existente
   - Sistema de notificaciones a admins
   - Tracking de estado de devoluci√≥n

3. Panel de Administraci√≥n (FASE 5)
   Funcionalidades:
   - CRUD de c√≥digos de descuento
   - Estad√≠sticas de uso de c√≥digos
   - Gesti√≥n de devoluciones
   - Ver todas las reservas de stock activas
   - Historial de cancelaciones

4. Popup Promocional (FASE 5)
   Caracter√≠sticas:
   - Mostrar una vez por sesi√≥n (localStorage)
   - Formulario de email
   - Generar c√≥digo autom√°tico √∫nico
   - Enviar por email con Brevo
   - Dise√±o atractivo con animaci√≥n

5. Notificaciones por Email
   Eventos a cubrir:
   - Pedido confirmado
   - Pedido cancelado (confirmaci√≥n al usuario)
   - Devoluci√≥n solicitada (confirmaci√≥n al usuario)
   - Devoluci√≥n aprobada
   - C√≥digos de descuento generados

6. Mejoras en Cancelaci√≥n
   Tareas:
   - Implementar reembolso autom√°tico con Stripe
   - Notificar por email al usuario
   - Registro de motivo de cancelaci√≥n (opcional)
   - Estad√≠sticas de cancelaciones para analytics


================================================================================
6. INSTRUCCIONES DE IMPLEMENTACI√ìN
================================================================================

ORDEN DE APLICACI√ìN (CR√çTICO):

1Ô∏è‚É£ Aplicar Migraciones SQL (EN ORDEN)
   
   Opci√≥n A: Script Autom√°tico
   ```powershell
   .\aplicar-migraciones-pedidos.ps1
   ```
   
   Opci√≥n B: Manual en Supabase SQL Editor
   a) migrations/003_user_orders_policies.sql  (CR√çTICO)
   b) migrations/004_fix_order_states.sql
   c) migrations/005_cancel_order_function.sql
   d) migrations/006_discount_codes.sql

2Ô∏è‚É£ Verificar que Funcionan
   
   a) P√°gina de test:
      - Ve a http://localhost:4321/test-session
      - Inicia sesi√≥n
      - Verifica que veas tus pedidos
   
   b) SQL directo:
      ```sql
      -- En Supabase SQL Editor:
      SELECT policyname FROM pg_policies WHERE tablename = 'orders';
      -- Debe mostrar: "Users can view their own orders"
      ```

3Ô∏è‚É£ Probar Cancelaci√≥n
   
   a) Ve a /perfil/mis-pedidos
   b) Busca un pedido con estado "Confirmado"
   c) Click en "Cancelar pedido"
   d) Confirma en el modal
   e) Verifica mensaje de √©xito
   f) Verifica que el stock se restaur√≥:
      ```sql
      SELECT id, name, stock FROM products WHERE id = 'PRODUCT_ID';
      ```

4Ô∏è‚É£ Probar C√≥digos de Descuento
   
   a) Integrar componente en carrito (elegir uno):
      ```astro
      <!-- En src/pages/carrito.astro -->
      import DiscountCodeInput from '@components/islands/DiscountCodeInput';
      <!-- O -->
      import DiscountCodeInput from '@components/ui/DiscountCodeInput.astro';
      
      <DiscountCodeInput />
      ```
   
   b) Probar c√≥digos:
      - BIENVENIDA10 (10% desc, m√≠n 20‚Ç¨)
      - PRIMERACOMPRA (5‚Ç¨ desc, m√≠n 30‚Ç¨)
      - VERANO2026 (15% desc, m√≠n 50‚Ç¨)
   
   c) Verificar que se guarda en sessionStorage
   
   d) Integrar en checkout (ver secci√≥n "Integraci√≥n con Checkout")

5Ô∏è‚É£ Probar Modal de Devoluciones
   
   a) Crear un pedido de prueba
   b) En Supabase, actualizar manualmente:
      ```sql
      UPDATE orders SET status = 'delivered' WHERE id = 'ORDER_ID';
      ```
   c) Recarga /perfil/mis-pedidos
   d) Click en "Solicitar devoluci√≥n"
   e) Verificar contenido del modal
   f) Probar bot√≥n "Copiar n¬∫ pedido"
   g) Probar bot√≥n "Enviar email"


================================================================================
7. VARIABLES DE ENTORNO REQUERIDAS
================================================================================

.env existentes (ya configuradas):
  PUBLIC_SUPABASE_URL=...
  PUBLIC_SUPABASE_ANON_KEY=...
  SUPABASE_SERVICE_ROLE_KEY=...
  STRIPE_SECRET_KEY=...
  STRIPE_WEBHOOK_SECRET=...
  BREVO_API_KEY=...
  EMAIL_FROM=...

Nuevas variables (opcional):
  # Para script PowerShell automatizado
  # (ya est√°n en .env, solo asegurarse que existan)

No se requieren nuevas variables para las funcionalidades implementadas.


================================================================================
8. TROUBLESHOOTING
================================================================================

PROBLEMA: Los pedidos no aparecen en /perfil/mis-pedidos

SOLUCI√ìN:
1. Verifica que ejecutaste migrations/003_user_orders_policies.sql
2. Ve a /test-session para diagn√≥stico autom√°tico
3. Ejecuta diagnostico-pedidos.sql paso a paso
4. Si los pedidos tienen user_id = NULL, fueron hechos como invitado
   ‚Üí No se pueden recuperar en el perfil
   ‚Üí El webhook debe guardar user_id correctamente

PROBLEMA: Error al cancelar pedido

SOLUCI√ìN:
1. Verifica que ejecutaste migrations/005_cancel_order_function.sql
2. Verifica que el estado del pedido sea 'confirmed' o 'processing'
3. Revisa la consola del navegador (F12) para ver el error exacto
4. Verifica logs del backend:
   ```sql
   -- En Supabase SQL Editor:
   SELECT * FROM pg_stat_statements WHERE query LIKE '%cancel_order%';
   ```

PROBLEMA: C√≥digo de descuento no se valida

SOLUCI√ìN:
1. Verifica que ejecutaste migrations/006_discount_codes.sql
2. Verifica que el c√≥digo existe y est√° activo:
   ```sql
   SELECT * FROM discount_codes WHERE code = 'BIENVENIDA10';
   ```
3. Revisa la consola del navegador para ver el error de la RPC
4. Verifica permisos:
   ```sql
   SELECT has_function_privilege('validate_discount_code', 'execute');
   ```

PROBLEMA: Script PowerShell falla

SOLUCI√ìN:
1. Verifica que .env tiene PUBLIC_SUPABASE_URL y SUPABASE_SERVICE_ROLE_KEY
2. Aplica las migraciones manualmente en Supabase SQL Editor
3. Sigue las instrucciones en FIX_PEDIDOS_NO_VISIBLES.md


================================================================================
9. RESUMEN DE ARCHIVOS CREADOS
================================================================================

Migraciones SQL (4):
  ‚úÖ migrations/003_user_orders_policies.sql      (88 l√≠neas)
  ‚úÖ migrations/004_fix_order_states.sql          (53 l√≠neas)
  ‚úÖ migrations/005_cancel_order_function.sql     (128 l√≠neas)
  ‚úÖ migrations/006_discount_codes.sql            (208 l√≠neas)

API Endpoints (1):
  ‚úÖ src/pages/api/orders/cancel.ts               (108 l√≠neas)

Componentes UI (2):
  ‚úÖ src/components/islands/DiscountCodeInput.tsx (181 l√≠neas)
  ‚úÖ src/components/ui/DiscountCodeInput.astro    (234 l√≠neas)

P√°ginas de Testing (1):
  ‚úÖ src/pages/test-session.astro                 (131 l√≠neas)

Scripts de Diagn√≥stico (3):
  ‚úÖ diagnostico-pedidos.sql                      (156 l√≠neas)
  ‚úÖ verificar-pedidos-rapido.sql                 (34 l√≠neas)
  ‚úÖ verificar-cuenta-email.sql                   (27 l√≠neas)

Scripts PowerShell (1):
  ‚úÖ aplicar-migraciones-pedidos.ps1              (156 l√≠neas)

Documentaci√≥n (4):
  ‚úÖ PLAN_IMPLEMENTACION.md                       (162 l√≠neas)
  ‚úÖ FASE_1_2_COMPLETADA.md                       (124 l√≠neas)
  ‚úÖ FASE_3_COMPLETADA.md                         (129 l√≠neas)
  ‚úÖ FIX_PEDIDOS_NO_VISIBLES.md                   (122 l√≠neas)

Archivos Modificados (1):
  ‚úÖ src/pages/perfil/mis-pedidos.astro           (+300 l√≠neas aprox)
     - Modal de confirmaci√≥n cancelaci√≥n
     - Toast de notificaciones
     - Modal de devoluciones
     - Sistema de autenticaci√≥n corregido
     - Botones y l√≥gica mejorada

TOTAL:
  üìÑ 16 archivos nuevos
  üìù 1 archivo modificado significativamente
  üìä ~2,240 l√≠neas de c√≥digo nuevo
  üìö 537 l√≠neas de documentaci√≥n


================================================================================
10. CHECKLIST DE IMPLEMENTACI√ìN
================================================================================

Backend - Migraciones SQL:
  ‚òê Ejecutar migrations/003_user_orders_policies.sql
  ‚òê Ejecutar migrations/004_fix_order_states.sql
  ‚òê Ejecutar migrations/005_cancel_order_function.sql
  ‚òê Ejecutar migrations/006_discount_codes.sql
  ‚òê Verificar pol√≠ticas RLS activas
  ‚òê Verificar funciones SQL creadas

Backend - Integraci√≥n Checkout:
  ‚òê Modificar src/pages/api/checkout/create-session.ts
  ‚òê Modificar src/pages/api/webhooks/stripe.ts
  ‚òê Probar flujo completo con c√≥digo de descuento
  ‚òê Verificar uses_count se incrementa tras pago

Frontend - Componentes:
  ‚òê Elegir entre DiscountCodeInput.tsx o .astro
  ‚òê Integrar en p√°gina de carrito
  ‚òê Verificar validaci√≥n en tiempo real
  ‚òê Verificar guardado en sessionStorage
  ‚òê Probar quitar descuento

Testing:
  ‚òê Probar cancelaci√≥n de pedido confirmado
  ‚òê Probar cancelaci√≥n de pedido en proceso
  ‚òê Verificar stock se restaura correctamente
  ‚òê Intentar cancelar pedido enviado (debe fallar)
  ‚òê Probar c√≥digos de descuento con diferentes condiciones
  ‚òê Probar modal de devoluciones
  ‚òê Probar bot√≥n copiar n√∫mero de pedido
  ‚òê Verificar emails de facturas siguen funcionando

Documentaci√≥n:
  ‚òê Leer PLAN_IMPLEMENTACION.md
  ‚òê Leer FASE_1_2_COMPLETADA.md
  ‚òê Leer FASE_3_COMPLETADA.md
  ‚òê Guardar FIX_PEDIDOS_NO_VISIBLES.md como referencia


================================================================================
11. NOTAS FINALES
================================================================================

SEGURIDAD:
- Todas las operaciones SQL usan SECURITY DEFINER con validaciones
- RLS activo en todas las tablas relevantes
- API endpoints verifican autenticaci√≥n con Bearer token
- Funciones de descuento permiten lectura p√∫blica pero solo service_role modifica

ATOMICIDAD:
- cancel_order_and_restore_stock() es completamente at√≥mico
- Si falla cualquier paso, se revierte TODO autom√°ticamente
- No hay riesgo de stock inconsistente

ESCALABILIDAD:
- Sistema de c√≥digos soporta millones de usos
- √çndices optimizados para b√∫squedas r√°pidas
- Pol√≠ticas RLS eficientes con auth.uid()

MANTENIBILIDAD:
- C√≥digo modular y bien documentado
- Scripts de diagn√≥stico para troubleshooting
- Documentaci√≥n completa por fase
- Comentarios explicativos en SQL y TypeScript

PR√ìXIMAS MEJORAS RECOMENDADAS:
1. Panel de admin para gesti√≥n de c√≥digos
2. Sistema completo de devoluciones con BD
3. Reembolsos autom√°ticos con Stripe
4. Notificaciones por email para todos los eventos
5. Analytics de cancelaciones y descuentos
6. Popup promocional con generaci√≥n autom√°tica de c√≥digos


================================================================================
FIN DEL DOCUMENTO
================================================================================
Fecha: 19 de enero de 2026
Estado: ‚úÖ FASES 1-3 COMPLETAS
Pendiente: Integraci√≥n checkout (descuentos) + Backend devoluciones
Pr√≥ximo: Panel de admin o popup promocional
================================================================================
